<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>IPMSM — MTPA · OVM · 6-Step (No-Canvas)</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0b0f14; --panel:#0f1624; --panel2:#0e1522; --text:#e8eef9; --muted:#8aa0be;
      --accent:#4cc9f0; --accent2:#a0e9ff; --ok:#22c55e; --warn:#f59e0b; --danger:#ef4444;
      --shadow:0 12px 32px rgba(0,0,0,.35); --radius:18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:radial-gradient(1200px 800px at 20% 0%,#0d1421 0%,#0b0f14 60%);
      color:var(--text); font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    }
    .wrap{display:grid; grid-template-rows:auto 1fr; height:100vh}
    header{
      display:flex; align-items:center; justify-content:space-between; padding:14px 18px;
      background:linear-gradient(180deg,rgba(76,201,240,.08),rgba(160,233,255,.03));
      border-bottom:1px solid #1e2738
    }
    .brand{display:flex; gap:12px; align-items:center}
    .badge{
      display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px;
      background:linear-gradient(90deg,rgba(76,201,240,.18),rgba(160,233,255,.12));
      border:1px solid rgba(160,233,255,.25);
      box-shadow:0 0 0 2px rgba(160,233,255,.06) inset; font-weight:600; letter-spacing:.2px
    }
    .badge small{color:var(--muted); font-weight:600}
    .brand h1{font-size:18px; margin:0; letter-spacing:.2px}
    .toolbar{display:flex; gap:10px; align-items:center}
    .toolbar button{
      appearance:none; border:1px solid #26304a; background:linear-gradient(180deg,#122033,#0f1a2b);
      padding:8px 10px; border-radius:10px; color:var(--text); font-weight:700; letter-spacing:.2px; cursor:pointer
    }
    .toolbar button.primary{border-color:#2b7490; background:linear-gradient(180deg,#124a63,#0d3b4f)}
    .main{display:grid; grid-template-columns:2fr 1fr; gap:16px; padding:16px; height:calc(100vh - 68px)}
    .panel{
      background:linear-gradient(180deg,var(--panel) 0%, var(--panel2) 100%);
      border:1px solid #1b2334; border-radius:var(--radius); box-shadow:var(--shadow)
    }
    .card{position:relative; padding:12px 12px 14px}
    .card h4{margin:0 0 6px 0; font-size:12px; color:var(--muted); letter-spacing:.3px}
    .grid-3{display:grid; grid-template-columns:1fr; gap:16px; height:100%}
    .row{display:grid; grid-template-columns:170px 1fr 90px; gap:10px; align-items:center; margin-bottom:8px}
    .row label{font-weight:600; font-size:13px}
    .row output{font-variant-numeric:tabular-nums; text-align:right; color:var(--accent2)}
    input[type=range], input[type=number], select{width:100%}
    .hint{font-size:12px; color:var(--muted); line-height:1.5}
    .pill{display:inline-flex; gap:6px; align-items:center; padding:6px 10px; border-radius:999px; border:1px solid #2a3650; background:linear-gradient(180deg,#121a2a,#0f1624); font-size:12px}
    .state{display:flex; gap:8px; align-items:center; justify-content:flex-end}
    .state .dot{width:10px; height:10px; border-radius:99px}
    .zone-basic{background:#22c55e} .zone-ovm{background:#f59e0b} .zone-6step{background:#ef4444}
    .muted{color:var(--muted)} .small{font-size:12px}
    /* HUD */
    .hud{display:grid; grid-auto-rows:minmax(28px,auto); gap:6px; font-size:13px}
    .kv{display:flex; justify-content:space-between; gap:8px; padding:8px 10px; border:1px solid #1b2334; border-radius:10px; background:linear-gradient(180deg,#111a2b,#0e1522)}
    .kv b{color:#bcdfff}
    /* Bars */
    .bar{height:10px; background:#142033; border:1px solid #203047; border-radius:999px; overflow:hidden}
    .bar > i{display:block; height:100%; width:var(--w,0%); background:linear-gradient(90deg,#60a5fa,#a0e9ff)}
    .kv-col{display:grid; grid-template-columns:1fr 120px; gap:8px; align-items:center}
    .list{display:grid; gap:8px}
    /* Drawer */
    .drawer{position:fixed; inset:0; pointer-events:none}
    .drawer .sheet{
      position:absolute; left:0; top:0; bottom:0; width:460px; transform:translateX(-100%);
      transition:transform .25s ease; background:linear-gradient(180deg,#0f1624,#0e1522);
      border-right:1px solid #1b2334; padding:16px; overflow:auto
    }
    .drawer .overlay{position:absolute; inset:0; background:rgba(0,0,0,.4); opacity:0; transition:opacity .25s ease}
    .drawer.open{pointer-events:auto}
    .drawer.open .sheet{transform:none}
    .drawer.open .overlay{opacity:1}
    /* Badges in header */
    .legend-chip{display:inline-flex; align-items:center; gap:6px; padding:3px 8px; border-radius:999px; border:1px solid #2b3650; margin:0 6px 6px 0; font-size:12px}
    .sw{width:10px; height:10px; border-radius:2px}
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="brand">
      <div class="badge"><span>IPMSM Drive Lab</span> <small>v2.6.3 (no-canvas)</small></div>
      <h1>MTPA→OVM→6-Step 시뮬레이터 (IPMSM)</h1>
    </div>
    <div class="toolbar">
      <button id="btnSettings" class="primary">⚙️ 설정</button>
      <button id="btnCSV">⬇️ CSV 다운로드</button>
      <div class="state small">
        <span class="muted">모드:</span>
        <span id="modePill" class="pill"><b id="modeText">기본</b> <span id="zoneText" class="muted">(선형 영역)</span></span>
        <div class="dot zone-basic" id="zoneDot"></div>
      </div>
    </div>
  </header>

  <div class="main">
    <!-- LEFT: HUD (no canvas) -->
    <section class="panel card">
      <h4>Drive HUD</h4>
      <div class="hud">
        <div class="kv"><span><b>v</b> (m/s)</span><span id="hudV">0.00</span></div>
        <div class="kv"><span><b>RPM</b></span><span id="hudRPM">0</span></div>
        <div class="kv"><span><b>m</b> (mod idx)</span><span id="hudM">0.00</span></div>
        <div class="kv"><span><b>영역</b></span><span id="hudMode">기본</span></div>
        <div class="kv"><span><b>v_ref</b> (m/s)</span><span id="hudVref">0.0</span></div>
      </div>
      <div style="height:10px"></div>
      <div class="grid-3">
        <div class="panel card" style="padding:10px">
          <h4>Phase Voltages vs Back-EMF (a상)</h4>
          <div class="list" id="voltList">
            <!-- Filled by JS: va/vb/vc/ea -->
          </div>
        </div>
        <div class="panel card" style="padding:10px">
          <h4>Phase Currents & Electromagnetic Torque</h4>
          <div class="list" id="currList">
            <!-- Filled by JS: ia/ib/ic/Te -->
          </div>
        </div>
        <div class="panel card" style="padding:10px">
          <h4>Harmonic Spectrum of v_a (최근 1 전기주기)</h4>
          <div class="list" id="fftList">
            <!-- Filled by JS: harmonic bars -->
          </div>
        </div>
      </div>
    </section>

    <!-- RIGHT: settings quick -->
    <section class="panel card">
      <h4>Quick Controls</h4>
      <div class="row"><label>제어 방식</label>
        <select id="ctrlMode"><option value="manual">수동 (m, 모드 직접)</option><option value="auto">Auto: MTPA→OVM→6-Step</option></select><output></output>
      </div>
      <div class="row"><label>가속 페달</label><input id="throttle" type="range" min="-1" max="1" step="0.01" value="0" /><output id="throttleVal">0%</output></div>
      <div class="row"><label>모듈레이션 m</label><input id="midx" type="range" min="0" max="1.5" step="0.01" value="0.80" /><output id="mVal">0.80</output></div>
      <div class="row"><label>모드</label>
        <select id="modeSel"><option value="basic">기본 (3rd harmonic)</option><option value="ovm">과변조 (OVM)</option><option value="six">6-스텝 (구형파)</option></select>
        <output></output>
      </div>

      <div class="row"><label>프로파일</label>
        <select id="cycleSel">
          <option value="manual">수동</option>
          <option value="urban">도심(시내)</option>
          <option value="highway">고속</option>
          <option value="stopgo">정지-출발</option>
        </select>
        <output id="cycleInfo">—</output>
      </div>
      <div class="row"><label>속도 배율</label><input id="cycleV" type="range" min="0.6" max="1.5" step="0.05" value="1.00" /><output id="cycleVVal">×1.00</output></div>
      <div class="row"><label>시간 배율</label><input id="cycleT" type="range" min="0.5" max="2.0" step="0.05" value="1.00" /><output id="cycleTVal">×1.00</output></div>
      <div class="row"><label>재생/일시정지</label><button id="btnCyclePlay">⏸ 일시정지</button><output id="cycleTNow">t=0.0s</output></div>

      <div class="row"><label>R<sub>s</sub> [Ω]</label><input id="rs" type="range" min="0.01" max="0.3" step="0.005" value="0.050" /><output id="rsVal">0.050</output></div>
      <div class="row"><label>L<sub>d</sub> [mH]</label><input id="ld" type="range" min="0.05" max="2.0" step="0.01" value="0.30" /><output id="ldVal">0.30</output></div>
      <div class="row"><label>L<sub>q</sub> [mH]</label><input id="lq" type="range" min="0.05" max="2.0" step="0.01" value="0.60" /><output id="lqVal">0.60</output></div>
      <div class="row"><label>자속 λ<sub>f</sub> [Wb]</label><input id="lambdaF" type="range" min="0.02" max="0.12" step="0.001" value="0.060" /><output id="lfVal">0.060</output></div>
      <div class="row"><label>극쌍수 p</label><input id="pp" type="range" min="1" max="6" step="1" value="3" /><output id="ppVal">3</output></div>
      <div class="row"><label>V<sub>dc</sub> [V]</label><input id="vdc" type="range" min="100" max="800" step="10" value="400" /><output id="vdcVal">400V</output></div>

      <div class="row"><label>휠 반경 [m]</label><input id="wheelR" type="range" min="0.15" max="0.40" step="0.01" value="0.30" /><output id="wheelRVal">0.30</output></div>
      <div class="row"><label>기어비 G</label><input id="gear" type="range" min="2" max="12" step="0.1" value="9.0" /><output id="gearVal">9.0</output></div>
      <div class="row"><label>차량 질량 [kg]</label><input id="mass" type="range" min="800" max="2500" step="10" value="1800" /><output id="massVal">1800</output></div>
      <div class="row"><label>CdA [m²]</label><input id="cda" type="range" min="0.3" max="0.9" step="0.01" value="0.60" /><output id="cdaVal">0.60</output></div>

      <div class="row"><label>H 최대차수</label><input id="harmMax" type="range" min="10" max="80" step="1" value="40" /><output id="harmMaxVal">40</output></div>
      <p class="hint">단축키: ←/→ 가속·감속, Space 일시정지/재생, S 정지</p>
    </section>
  </div>
</div>

<!-- SETTINGS DRAWER (same inputs, 편하게 전체 보기용) -->
<div id="drawer" class="drawer" aria-hidden="true">
  <div class="overlay" id="drawerOverlay"></div>
  <aside class="sheet">
    <h3 style="margin:0 0 12px 0; color:var(--muted)">시뮬레이션 설정</h3>
    <!-- 간단히 오른쪽 Quick Controls와 동일 내용 보여주도록 복제 -->
    <div id="drawerContent"></div>
    <div class="hint" id="selfTests" style="margin-top:8px"></div>
  </aside>
</div>

<script>
/* ===== Helpers ===== */
const clamp=(x,lo,hi)=>Math.min(Math.max(+x,lo),hi);
const fmt=(x,d=2)=>Number(x).toFixed(d);
const si=(n)=>{ n=Number(n); const a=Math.abs(n);
  if(a>=1e9) return (n/1e9).toFixed(2)+'G';
  if(a>=1e6) return (n/1e6).toFixed(2)+'M';
  if(a>=1e3) return (n/1e3).toFixed(2)+'k';
  if(a>=1)   return n.toFixed(2);
  if(a>=1e-3)return (n*1e3).toFixed(2)+'m';
  if(a>=1e-6)return (n*1e6).toFixed(2)+'µ';
  return n.toExponential(2);
};
/* Safe trig (확장 오버라이드 방지) */
(function(){ const SIN=Math.sin.bind(Math), COS=Math.cos.bind(Math); Math.sin=SIN; Math.cos=COS; })();

/* ===== Elements ===== */
const $=id=>document.getElementById(id);
const els={
  drawer: $('drawer'), drawerOverlay:$('drawerOverlay'), btnSettings:$('btnSettings'),
  ctrlMode:$('ctrlMode'), throttle:$('throttle'), throttleVal:$('throttleVal'),
  vdc:$('vdc'), vdcVal:$('vdcVal'),
  pp:$('pp'), ppVal:$('ppVal'),
  midx:$('midx'), mVal:$('mVal'), modeSel:$('modeSel'),
  rs:$('rs'), rsVal:$('rsVal'), ld:$('ld'), ldVal:$('ldVal'),
  lq:$('lq'), lqVal:$('lqVal'), lambdaF:$('lambdaF'), lfVal:$('lfVal'),
  gear:$('gear'), gearVal:$('gearVal'), wheelR:$('wheelR'), wheelRVal:$('wheelRVal'),
  mass:$('mass'), massVal:$('massVal'), cda:$('cda'), cdaVal:$('cdaVal'),
  cycleSel:$('cycleSel'), cycleInfo:$('cycleInfo'),
  cycleV:$('cycleV'), cycleVVal:$('cycleVVal'),
  cycleT:$('cycleT'), cycleTVal:$('cycleTVal'),
  btnCyclePlay:$('btnCyclePlay'), cycleTNow:$('cycleTNow'),
  harmMax:$('harmMax'), harmMaxVal:$('harmMaxVal'),
  btnCSV:$('btnCSV'),
  modePill:$('modePill'), modeText:$('modeText'), zoneText:$('zoneText'), zoneDot:$('zoneDot'),
  hudV:$('hudV'), hudRPM:$('hudRPM'), hudM:$('hudM'), hudMode:$('hudMode'), hudVref:$('hudVref'),
  voltList:$('voltList'), currList:$('currList'), fftList:$('fftList')
};
function bindRange(range,out,map=(x)=>x){ const f=()=> out.textContent=map(range.value); range.addEventListener('input',f); f(); }
bindRange(els.throttle, els.throttleVal, v=> (Math.round(v*100))+'%');
bindRange(els.vdc, els.vdcVal, v=> fmt(v,0)+'V');
bindRange(els.pp, els.ppVal, v=> v);
bindRange(els.midx, els.mVal, v=> fmt(v,2));
bindRange(els.rs, els.rsVal, v=> fmt(v,3));
bindRange(els.ld, els.ldVal, v=> fmt(v,2));
bindRange(els.lq, els.lqVal, v=> fmt(v,2));
bindRange(els.lambdaF, els.lfVal, v=> fmt(v,3));
bindRange(els.gear, els.gearVal, v=> fmt(v,1));
bindRange(els.wheelR, els.wheelRVal, v=> fmt(v,2));
bindRange(els.mass, els.massVal, v=> fmt(v,0));
bindRange(els.cycleV, els.cycleVVal, v=> '×'+fmt(v,2));
bindRange(els.cycleT, els.cycleTVal, v=> '×'+fmt(v,2));
bindRange(els.harmMax, els.harmMaxVal, v=> v);

els.btnSettings.addEventListener('click', ()=>{
  // drawer 안에 Quick Controls 복제(간단히) — 클릭도 정상 동작
  if(!els.drawer.classList.contains('open')){
    $('drawerContent').innerHTML = document.querySelector('section.panel.card').nextElementSibling.innerHTML;
  }
  els.drawer.classList.add('open');
});
els.drawerOverlay.addEventListener('click', ()=> els.drawer.classList.remove('open'));

/* ===== dq 변환 ===== */
function clarke(va,vb,vc){ const v_alpha=(2/3)*(va-0.5*vb-0.5*vc); const v_beta=(2/3)*((Math.sqrt(3)/2)*(vb-vc)); return {v_alpha,v_beta}; }
function parkTransform(va,vb,vc,th){ const {v_alpha,v_beta}=clarke(va,vb,vc); const c=Math.cos(th), s=Math.sin(th); return { v_d:c*v_alpha+s*v_beta, v_q:-s*v_alpha+c*v_beta }; }
function invPark(id,iq,th){ const c=Math.cos(th), s=Math.sin(th); const i_alpha=c*id - s*iq, i_beta=s*id + c*iq;
  const ia=i_alpha, ib=-0.5*i_alpha + (Math.sqrt(3)/2)*i_beta, ic=-0.5*i_alpha - (Math.sqrt(3)/2)*i_beta; return {ia,ib,ic};
}

/* ===== 3rd harmonic 정규화 ===== */
function maxH3(){
  const f=(x)=> Math.sin(x)+(1/6)*Math.sin(3*x);
  let a=0,b=2*Math.PI; const gr=(Math.sqrt(5)-1)/2; let c=b-gr*(b-a), d=a+gr*(b-a); let fc=f(c), fd=f(d);
  for(let i=0;i<80;i++){ if(fc<fd){ a=c; c=d; fc=fd; d=a+gr*(b-a); fd=f(d);} else { b=d; d=c; fd=fc; c=b-gr*(b-a); fc=f(c);} }
  return Math.max(fc,fd);
}
const V3H_MAX = maxH3();

/* ===== 전압 합성 ===== */
function synthesizeVoltages(theta,m,Vdc,mode){
  const s1=Math.sin(theta), s2=Math.sin(theta-2*Math.PI/3), s3=Math.sin(theta+2*Math.PI/3);
  let vaN,vbN,vcN; const h=(x)=> Math.sin(x)+(1/6)*Math.sin(3*x);
  if(mode==='six'){ vaN=Math.sign(s1); vbN=Math.sign(s2); vcN=Math.sign(s3); }
  else{
    vaN=(m*h(theta))/V3H_MAX; vbN=(m*h(theta-2*Math.PI/3))/V3H_MAX; vcN=(m*h(theta+2*Math.PI/3))/V3H_MAX;
    if(mode==='ovm'){ vaN=Math.max(-1,Math.min(1,vaN)); vbN=Math.max(-1,Math.min(1,vbN)); vcN=Math.max(-1,Math.min(1,vcN)); }
  }
  const k=Vdc/2; return {va:k*vaN, vb:k*vbN, vc:k*vcN};
}

/* ===== 시뮬레이션 상태 & 로깅 ===== */
let state={ dt:50e-6, substeps:60, t:0, theta:0, id:0, iq:0, v:0, rpm:0, vCycle:[] };
let FFT_HARM_MAX=+els.harmMax.value;
const log={ t:[], va:[], vb:[], vc:[], ea:[], ia:[], ib:[], ic:[], Te:[], vab:[] };

/* ===== IPMSM & 제어 ===== */
function params(){
  return {
    Vdc:+els.vdc.value, p:+els.pp.value, Rs:+els.rs.value,
    Ld:+els.ld.value/1000, Lq:+els.lq.value/1000, lf:+els.lambdaF.value,
    G:+els.gear.value, Rw:+els.wheelR.value, mveh:+els.mass.value, CdA:+els.cda.value,
    throttle:+els.throttle.value, ctrlMode:els.ctrlMode.value, mode:els.modeSel.value, m:+els.midx.value
  };
}
function updateModeBadge(mode){
  let zone='선형 영역', txt='기본';
  if(mode==='ovm'){ zone='과변조 (플랫탑)'; txt='과변조'; }
  if(mode==='six'){ zone='6-스텝 (구형파)'; txt='6-스텝'; }
  els.modeText.textContent=txt; els.zoneText.textContent='('+zone+')';
  els.zoneDot.className='dot '+(mode==='basic'?'zone-basic':mode==='ovm'?'zone-ovm':'zone-6step');
  els.hudMode.textContent=txt;
}
function mtpa_id(iq,Ld,Lq,lf){ const dL=(Ld-Lq); const term=lf/(2*dL); const inside=Math.max(0,term*term+iq*iq); const id=-term+Math.sqrt(inside); return isFinite(id)?id:0; }
function torque_of(id,iq,p,lf,Ld,Lq){ return 1.5*p*( lf*iq + (Ld-Lq)*id*iq ); }
function volt_dq(id,iq,we,Rs,Ld,Lq,lf){ return { vd:-we*Lq*iq + Rs*id, vq: we*(Ld*id + lf) + Rs*iq }; }
function magnitude(a,b){ return Math.sqrt(a*a+b*b); }
function required_m_for_v1(V1,Vdc){ return (V1/(Vdc/2))*V3H_MAX; }
function choose_mode_from_m(m){ if(m<=1.0) return 'basic'; if(m<=1.3) return 'ovm'; return 'six'; }
function solve_iq_for_torque(Tref,p,lf,Ld,Lq){
  let lo=0, hi=1200; for(let it=0; it<40; it++){ const mid=0.5*(lo+hi); const id=mtpa_id(mid,Ld,Lq,lf); const T=torque_of(id,mid,p,lf,Ld,Lq); if(T<Tref) lo=mid; else hi=mid; }
  const iq=0.5*(lo+hi); return { iq, id: mtpa_id(iq,Ld,Lq,lf) };
}

/* ===== 주행 사이클러(속도 기준 v_ref + PI→throttle) ===== */
const cycler={ mode:'manual', playing:true, t:0, speedScale:1.0, timeScale:1.0, prof:null, vref:0, integ:0 };
function makeProfile(points){
  const T=points[points.length-1].t;
  return { length:T, eval(t){
    t=((t%T)+T)%T; let i=0; while(i<points.length-1 && t>points[i+1].t) i++;
    const a=points[i], b=points[i+1]||a; const u=(t-a.t)/Math.max(1e-9,(b.t-a.t)); return a.v+(b.v-a.v)*clamp(u,0,1);
  }};
}
const profiles={
  urban: makeProfile([{t:0,v:0},{t:12,v:10.5},{t:22,v:11.0},{t:30,v:6.0},{t:36,v:0},{t:42,v:8.0},{t:50,v:11.0},{t:56,v:4.0},{t:60,v:0}]),
  highway: makeProfile([{t:0,v:0},{t:20,v:20},{t:45,v:25},{t:70,v:28},{t:120,v:30},{t:140,v:22},{t:160,v:30},{t:200,v:28}]),
  stopgo: makeProfile([{t:0,v:0},{t:4,v:6.5},{t:8,v:7.0},{t:12,v:0},{t:16,v:0},{t:20,v:6.5},{t:24,v:7.0},{t:30,v:0}])
};
function updateCycleInfo(){
  if(cycler.mode==='manual'){ els.cycleInfo.textContent='—'; return; }
  els.cycleInfo.textContent=`주기 ${fmt(cycler.prof.length*cycler.timeScale,1)}s`;
}
els.cycleSel.addEventListener('change',()=>{
  cycler.mode=els.cycleSel.value;
  if(cycler.mode==='manual'){ cycler.prof=null; }
  else{ cycler.prof=profiles[cycler.mode]; cycler.t=0; cycler.integ=0; }
  els.throttle.disabled = cycler.mode!=='manual'; updateCycleInfo();
});
els.cycleV.addEventListener('input',()=>{ cycler.speedScale=+els.cycleV.value; updateCycleInfo(); });
els.cycleT.addEventListener('input',()=>{ cycler.timeScale=+els.cycleT.value; updateCycleInfo(); });
els.btnCyclePlay.addEventListener('click',()=>{ cycler.playing=!cycler.playing; els.btnCyclePlay.textContent=cycler.playing?'⏸ 일시정지':'▶ 재생'; });
function speedControllerStep(P,frameDt){
  if(cycler.mode==='manual'){ els.hudVref.textContent=fmt(0,1); return P.throttle; }
  if(!cycler.prof) return P.throttle;
  if(cycler.playing) cycler.t += frameDt / cycler.timeScale;
  const vref=cycler.prof.eval(cycler.t) * cycler.speedScale; cycler.vref=vref; els.hudVref.textContent=fmt(vref,1);
  const kp=0.15, ki=0.25; const e=vref-state.v; cycler.integ=clamp(cycler.integ+e*ki*frameDt,-1,1);
  const u=clamp(kp*e+cycler.integ,-1,1);
  els.throttle.value=u; els.throttle.dispatchEvent(new Event('input'));
  els.cycleTNow.textContent=`t=${fmt(cycler.t,1)}s`;
  return u;
}

/* ===== 차량 스텝 ===== */
function vehicle_step(P,dt){
  const rho=1.2, Crr=0.012, g=9.81, eta=0.95; const Tmax=280;
  const Tref=P.throttle*Tmax;
  const omega_w=state.v/P.Rw; const wm=omega_w*P.G; const we=wm*P.p;
  let mode=P.mode, m=P.m, id=state.id, iq=state.iq;

  if(P.ctrlMode==='auto'){
    const s=Math.sign(Tref)||1;
    const sol=solve_iq_for_torque(Math.abs(Tref),P.p,P.lf,P.Ld,P.Lq); id=sol.id*s; iq=sol.iq*s;
    const {vd,vq}=volt_dq(id,iq,we,P.Rs,P.Ld,P.Lq,P.lf); const V1=magnitude(vd,vq); const mreq=required_m_for_v1(V1,P.Vdc);
    m=Math.min(1.5,mreq); mode=choose_mode_from_m(mreq);
  }

  const {vd,vq}=volt_dq(id,iq,we,P.Rs,P.Ld,P.Lq,P.lf);
  const did=(vd + we*P.Lq*state.iq - P.Rs*state.id)/P.Ld;
  const diq=(vq - we*P.Ld*state.id - we*P.lf - P.Rs*state.iq)/P.Lq;
  state.id+=did*dt; state.iq+=diq*dt;

  const Te=torque_of(state.id,state.iq,P.p,P.lf,P.Ld,P.Lq);
  const Ftrac=(Te*P.G*eta)/P.Rw, Fdrag=0.5*rho*P.CdA*state.v*state.v*Math.sign(state.v), Froll=Crr*P.mveh*g*Math.sign(state.v||1);
  const dv=(Ftrac-Fdrag-Froll)/P.mveh*dt; state.v+=dv; if(Math.abs(state.v)<0.05 && Math.abs(P.throttle)<0.02) state.v=0;
  state.rpm=wm*60/(2*Math.PI);
  return { mode, m, we, Te };
}

/* ===== 표시(UI) ===== */
function kvRow(label, value, unit='', percent=null){
  const pct = (percent!=null) ? ` style="--w:${clamp(percent,0,100)}%"` : '';
  const bar = (percent!=null) ? `<div class="bar"><i${pct}></i></div>` : '';
  return `<div class="kv-col"><div class="kv"><span><b>${label}</b>${unit?` (${unit})`:''}</span><span>${value}</span></div>${bar}</div>`;
}
function renderVoltCurr(va,vb,vc,ea,ia,ib,ic,Te){
  // 간단히 상대/절대 스케일 유추
  const vmax = Math.max(50, Math.abs(va),Math.abs(vb),Math.abs(vc),Math.abs(ea));
  const imax = Math.max(10, Math.abs(ia),Math.abs(ib),Math.abs(ic));
  els.voltList.innerHTML =
    kvRow('v_a',''+fmt(va,1),'V', Math.abs(va)/vmax*100) +
    kvRow('v_b',''+fmt(vb,1),'V', Math.abs(vb)/vmax*100) +
    kvRow('v_c',''+fmt(vc,1),'V', Math.abs(vc)/vmax*100) +
    kvRow('e_a',''+fmt(ea,1),'V', Math.abs(ea)/vmax*100);
  els.currList.innerHTML =
    kvRow('i_a',''+fmt(ia,2),'A', Math.abs(ia)/imax*100) +
    kvRow('i_b',''+fmt(ib,2),'A', Math.abs(ib)/imax*100) +
    kvRow('i_c',''+fmt(ic,2),'A', Math.abs(ic)/imax*100) +
    kvRow('T_e',''+fmt(Te,2),'Nm', Math.min(100, Math.abs(Te)/300*100));
}
function updateFFT(cycle){
  const H=FFT_HARM_MAX, N=cycle.length; if(N<96) return;
  function binMag(k){ let re=0,im=0; for(let n=0;n<N;n++){ const ang=-2*Math.PI*k*n/N; const x=cycle[n]; re+=x*Math.cos(ang); im+=x*Math.sin(ang);} return Math.sqrt(re*re+im*im)*2/N; }
  const a1=binMag(1)||1e-9; const rows=[]; for(let k=1;k<=H;k++){ const pct=binMag(k)/a1*100; rows.push({k,pct}); }
  // 상위 10개 표시
  rows.sort((a,b)=>b.pct-a.pct);
  const top=rows.slice(0,10);
  els.fftList.innerHTML = top.map(r=> kvRow(`${r.k}차`, fmt(r.pct,1)+' %','', Math.min(100,r.pct))).join('');
}

/* ===== CSV ===== */
function csvString(){
  const cols=['t','va','vb','vc','ea','ia','ib','ic','Te','vab']; const N=log.t.length; const lines=[cols.join(',')];
  for(let i=0;i<N;i++){
    lines.push([log.t[i],log.va[i],log.vb[i],log.vc[i],log.ea[i],log.ia[i],log.ib[i],log.ic[i],log.Te[i],log.vab[i]]
      .map(x=> typeof x==='number'?x.toFixed(5):x).join(','));
  }
  return lines.join('\n');
}
function downloadCSV(){
  const blob=new Blob([csvString()],{type:'text/csv'}); const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='ipmsm_sim.csv'; document.body.appendChild(a); a.click();
  setTimeout(()=>{URL.revokeObjectURL(url); a.remove();},0);
}
els.btnCSV.addEventListener('click',downloadCSV);

/* ===== 메인 루프 ===== */
let running=true;
function stepOnce(){
  const P=params();
  P.throttle = speedControllerStep(P, state.dt*state.substeps);

  const frameDt=state.dt*state.substeps;
  let mode=P.mode, m=P.m, we=0, Te=0;

  for(let k=0;k<state.substeps;k++){
    const res = (P.ctrlMode==='auto') ? vehicle_step(P,state.dt)
               : (function(){ const rpm=state.rpm||3000; we=(rpm*2*Math.PI/60)*P.p; return {mode:P.mode,m:P.m,we,Te:torque_of(state.id,state.iq,P.p,P.lf,P.Ld,P.Lq)}; })();
    mode=res.mode; m=res.m; we=res.we; Te=res.Te;

    state.theta+=we*state.dt; if(state.theta>=2*Math.PI) state.theta-=2*Math.PI;

    const {va,vb,vc}=synthesizeVoltages(state.theta,m,P.Vdc,mode);
    const ea=we*P.lf*Math.sin(state.theta);

    if(P.ctrlMode!=='auto'){
      const {vd,vq}=volt_dq(state.id,state.iq,we,P.Rs,P.Ld,P.Lq,P.lf);
      const did=(vd + we*P.Lq*state.iq - P.Rs*state.id)/P.Ld;
      const diq=(vq - we*P.Ld*state.id - we*P.lf - P.Rs*state.iq)/P.Lq;
      state.id+=did*state.dt; state.iq+=diq*state.dt;
      Te=torque_of(state.id,state.iq,P.p,P.lf,P.Ld,P.Lq);
    }

    state.vCycle.push(va); if(state.vCycle.length>4096) state.vCycle.shift();

    if(k===state.substeps-1){
      const {ia,ib,ic}=invPark(state.id,state.iq,state.theta);
      // 로깅(간단)
      log.t.push(state.t); log.va.push(va); log.vb.push(vb); log.vc.push(vc); log.ea.push(ea);
      log.ia.push(ia); log.ib.push(ib); log.ic.push(ic); log.Te.push(Te); log.vab.push(va-vb);
      // 표시 업데이트
      renderVoltCurr(va,vb,vc,ea,ia,ib,ic,Te);
    }
    // 한 전기주기마다 FFT 업데이트
    if(state.theta<1e-6){ updateFFT(state.vCycle.slice()); state.vCycle.length=0; }
  }

  state.t+=frameDt; updateModeBadge(mode);
  els.hudV.textContent=fmt(state.v,2); els.hudRPM.textContent=fmt(state.rpm,0); els.hudM.textContent=fmt(P.m,2);
}
function loop(){ stepOnce(); if(running) requestAnimationFrame(loop); }

window.addEventListener('keydown',e=>{
  if(e.key===' '){ running=!running; if(running) requestAnimationFrame(loop); }
  if(e.key==='ArrowRight'){ els.throttle.value=Math.min(1,+els.throttle.value+0.05); els.throttle.dispatchEvent(new Event('input')); }
  if(e.key==='ArrowLeft'){  els.throttle.value=Math.max(-1,+els.throttle.value-0.05); els.throttle.dispatchEvent(new Event('input')); }
  if(e.key.toLowerCase()==='s'){ els.throttle.value=0; els.throttle.dispatchEvent(new Event('input')); state.v=0; }
});
els.harmMax.addEventListener('input',()=>{ FFT_HARM_MAX=+els.harmMax.value; });

/* ===== Self-tests(요약) ===== */
(function runTests(){
  const T=[]; const okpush=(ok,name,msg='')=>T.push({ok,name,msg});
  let mx=-1e9; for(let i=0;i<=20000;i++){ const x=i*(2*Math.PI/20000); const v=Math.sin(x)+(1/6)*Math.sin(3*x); if(v>mx) mx=v; }
  okpush(Math.abs(mx-1.1547005)<1e-3,'V3H_MAX numeric');
  okpush(si(1234)==='1.23k','SI fmt');
  const ok=T.every(t=>t.ok);
  const div=$('selfTests'); if(div){ div.textContent=(ok?'✅ PASS':'⚠️ FAIL')+' · '+T.map(t=>`${t.ok?'✔':'✖'} ${t.name}${t.msg?('('+t.msg+')'):''}`).join(' | '); }
  console.log('Self-tests',T);
})();

/* ===== Boot ===== */
requestAnimationFrame(()=>{ loop(); });
</script>
</body>
</html>
