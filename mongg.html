<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>EV Free Drive â€” 3D & Regen PID</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    :root{ --bg:#0b0f14; --panel:#111826; --muted:#7d8aa3; --text:#e8eef9; --accent:#4cc9f0; --accent2:#a0e9ff; --shadow:0 10px 30px rgba(0,0,0,.35); --radius:18px }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:radial-gradient(1200px 800px at 80% -10%,#1a2330 0%,#0b0f14 55%);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Apple SD Gothic Neo,Noto Sans KR,Arial}
    /* header */
    header{display:flex;align-items:center;justify-content:space-between;padding:10px 14px;position:sticky;top:0;backdrop-filter:blur(6px);z-index:50;border-bottom:1px solid rgba(255,255,255,.06);background:linear-gradient(180deg,rgba(8,11,17,.86),rgba(8,11,17,.45))}
    header .left{display:flex;align-items:center;gap:10px}
    header h1{font-size:16px;margin:0;font-weight:800}
    header .sub{color:#9fb3cc;font-size:11px}
    .btnbar{display:flex;gap:6px;flex-wrap:wrap}
    .btn{background:linear-gradient(180deg,#1e2635,#141b27);border:1px solid rgba(255,255,255,.12);color:#e8f3ff;padding:8px 10px;border-radius:12px;font-weight:700;cursor:pointer;box-shadow:var(--shadow);font-size:12px}
    .btn.accent{background:linear-gradient(180deg,#34d5ff,#1aaadb);color:#06283b;border-color:rgba(76,201,240,.6)}
    .btn.warn{background:linear-gradient(180deg,#ffd76a,#f3b740);color:#2a1d00}
    /* drawer (Controls ë©”ë‰´ ìœ ì§€) */
    .drawer{display:none}
    .drawer.open{display:block}
    .card{background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,0));border:1px solid rgba(255,255,255,.08);border-radius:var(--radius);box-shadow:var(--shadow);margin:8px 14px}
    .card h2{font-size:12px;letter-spacing:.35px;text-transform:uppercase;color:var(--accent2);margin:0;padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.06)}
    .tabs{display:grid;grid-template-columns: repeat(4,1fr);gap:6px;padding:8px}
    .tab{cursor:pointer;text-align:center;padding:8px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:#0f1522;font-size:12px}
    .tab.active{background:linear-gradient(180deg,#34d5ff,#1aaadb);color:#052531;border-color:rgba(76,201,240,.6);font-weight:800}
    .panel{display:none;padding:10px 12px 12px}
    .panel.active{display:block}
    .group{border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:10px;margin-bottom:10px;background:rgba(255,255,255,.02)}
    .group-title{color:#b9d7ff;font-weight:800;font-size:11px;text-transform:uppercase;letter-spacing:.35px;margin-bottom:8px}
    .row{display:grid;grid-template-columns: 1fr auto;gap:8px;align-items:center;margin:6px 0}
    input[type=number],select{width:120px;background:#0d1320;color:var(--text);border:1px solid rgba(255,255,255,.12);border-radius:10px;padding:6px 8px;font-size:12px}
    input[type=range]{width:100%}
    /* layout: left(3D+íƒ€ì¼) | right(ê·¸ë˜í”„) */
    .app{display:grid;grid-template-columns: 1fr 420px;gap:10px;padding:8px 14px}
    #three-wrap{height:clamp(560px, 75vh, 920px);border-radius:18px;overflow:hidden;outline:none}
    .telemetry{display:grid;grid-template-columns: repeat(auto-fit, minmax(120px,1fr));gap:6px;padding:6px 0}
    .tile{background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:8px 10px}
    .tile .k{font-size:10px;color:#9fd3ff;text-transform:uppercase;letter-spacing:.35px}
    .tile .v{font-size:16px;font-weight:800;margin-top:2px}
    .sidebar{display:flex;flex-direction:column;gap:10px;min-height:0}
    canvas.chart{width:100%;height:180px}
    @media (max-width: 1100px){ .app{grid-template-columns:1fr} }
    footer{color:#7d8aa3;font-size:11px;text-align:center;padding:8px}
  </style>

  <!-- âœ… Import Map: fix bare module specifier for three -->
  <script type="importmap">
  {
    "imports": {
      "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
      "three/examples/jsm/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
    }
  }
  </script>
</head>
<body>
  <header>
    <div class="left">
      <button id="btnControls" class="btn">â˜° Controls</button>
      <h1>EV Free Drive â€” 3D & Regen PID</h1>
      <span class="sub">W/â†‘ ê°€ì† Â· S/â†“ ë¸Œë ˆì´í¬ Â· â†(ìš°íšŒì „) â†’(ì¢ŒíšŒì „) Â· Space ì¼ì‹œì •ì§€/ì¬ê°œ</span>
    </div>
    <div class="btnbar">
      <button id="btnStart" class="btn accent">â–¶ ì‹œì‘</button>
      <button id="btnPause" class="btn">â¸ ì¼ì‹œì •ì§€</button>
      <button id="btnReset" class="btn warn">â†º ì´ˆê¸°í™”</button>
      <button id="btnCsv" class="btn">â¤“ CSV</button>
      <button id="btnFollow" class="btn">ğŸ¥ Follow: ON</button>
    </div>
  </header>

  <!-- Controls ë©”ë‰´(ìœ ì§€) -->
  <section id="controlsDrawer" class="card drawer" aria-hidden="true">
    <h2>Controls</h2>
    <div class="tabs">
      <div class="tab active" data-tab="drive">Drive</div>
      <div class="tab" data-tab="env">Environment</div>
      <div class="tab" data-tab="adv">Advanced</div>
      <div class="tab" data-tab="help">Help</div>
    </div>

    <div class="panel active" id="panel-drive">
      <div class="group">
        <div class="group-title">ì£¼í–‰ ëª¨ë“œ</div>
        <div class="row">
          <label>ëª¨ë“œ</label>
          <select id="mode"><option value="pedal" selected>Pedal (ìŠ¤ë¡œí‹€/ë¸Œë ˆì´í¬)</option><option value="cruise">Cruise (ëª©í‘œì†ë„)</option></select>
        </div>
        <div id="cruiseBox" style="display:none">
          <div class="row"><label>ëª©í‘œ ì†ë„ (km/h)</label><input id="targetKmh" type="number" value="80" step="1"></div>
          <div class="row"><label>Kp/Ki (speed)</label>
            <span><input id="Kps" type="number" value="6" step="0.5" style="width:70px"> / <input id="Kis" type="number" value="2" step="0.2" style="width:70px"></span>
          </div>
        </div>
        <div id="pedalBox">
          <div class="row"><label>ìŠ¤ë¡œí‹€ (%)</label><input id="throttle" type="range" min="0" max="100" value="0"></div>
          <div class="row"><label>ë¸Œë ˆì´í¬ (%)</label><input id="brake" type="range" min="0" max="100" value="0"></div>
          <div class="row"><label>ì¡°í–¥ (Â°)</label><input id="steer" type="range" min="-30" max="30" value="0"></div>
          <div class="row"><label>í‚¤ ë°˜ì‘(%/s)</label>
            <select id="keyRate"><option value="50">ëŠë¦¼</option><option value="100" selected>ë³´í†µ</option><option value="180">ë¹ ë¦„</option></select>
          </div>
        </div>
        <div class="btnbar" style="margin-top:8px"><button id="btnDisturb" class="btn">âš¡ ë¶€í•˜ì‹œí—˜(+300Nm, 2s)</button></div>
      </div>
      <div class="group">
        <div class="group-title">ì¸ë²„í„°/ëª¨í„°</div>
        <div class="row"><label>Imax (A)</label><input id="Imax" type="number" value="600" step="10"></div>
        <div class="row"><label>Kp/Ki (current)</label>
          <span><input id="Kpc" type="number" value="2.0" step="0.1" style="width:70px"> / <input id="Kic" type="number" value="1000" step="50" style="width:70px"></span>
        </div>
        <div class="row"><label>Vbus (V)</label><input id="Vbus" type="number" value="400" step="10"></div>
        <div class="row"><label>R/L (Î©/H)</label>
          <span><input id="R" type="number" value="0.05" step="0.005" style="width:70px"> / <input id="L" type="number" value="0.0005" step="0.0001" style="width:90px"></span>
        </div>
        <div class="row"><label>kt / ke</label>
          <span><input id="kt" type="number" value="0.30" step="0.01" style="width:70px"> / <input id="ke" type="number" value="0.30" step="0.01" style="width:70px"></span>
        </div>
        <div class="row"><label>ì§€ì—°(ms)</label><input id="delayMs" type="number" value="1.0" step="0.5"></div>
        <div class="row"><label>FF (keÂ·Ï‰)</label><select id="ffOn"><option value="1" selected>ON</option><option value="0">OFF</option></select></div>
        <div class="row"><label>íšŒìƒ I/P (A/kW)</label>
          <span><input id="Iregen" type="number" value="400" step="10" style="width:80px"> / <input id="Pregen" type="number" value="120" step="5" style="width:80px"></span>
        </div>
      </div>
      <div class="group">
        <div class="group-title">ì°¨ëŸ‰/í™˜ê²½</div>
        <div class="row"><label>m (kg)</label><input id="mass" type="number" value="1600" step="10"></div>
        <div class="row"><label>Rw/G</label>
          <span><input id="Rw" type="number" value="0.31" step="0.01" style="width:70px"> / <input id="gear" type="number" value="9.0" step="0.1" style="width:70px"></span>
        </div>
        <div class="row"><label>Î· / CdA / c_r</label>
          <span><input id="eta" type="number" value="0.95" step="0.01" style="width:64px"> / <input id="CdA" type="number" value="0.70" step="0.05" style="width:64px"> / <input id="cr" type="number" value="0.012" step="0.002" style="width:64px"></span>
        </div>
        <div class="row"><label>Ï (kg/mÂ³)</label><input id="rho" type="number" value="1.225" step="0.01"></div>
        <div class="row"><label>ë§ˆì°° Î¼</label><input id="mu" type="number" value="1.0" step="0.05"></div>
        <div class="row"><label>ë“±íŒ(Â°)</label><input id="gradeDeg" type="number" value="0" step="0.5"></div>
        <div class="row"><label>í‘œì‹œ ìŠ¤ë¬´ë”© Ï„(ms)</label><input id="smoothMs" type="number" value="250" step="25"></div>
        <div class="row"><label>ì°¨íŠ¸ ì£¼ê¸°/ì°½</label>
          <span><input id="chartMs" type="number" value="120" step="10" style="width:80px"> / <input id="chartWindow" type="number" value="60" step="10" style="width:80px"> s</span>
        </div>
      </div>
    </div>

    <div class="panel" id="panel-env">
      <div class="group">
        <div class="group-title">ë„ì›€</div>
        <div>ì´ì œ íŠ¸ë™ ì¢…ì†ì´ ì•„ë‹ˆë¼ XY í‰ë©´ì—ì„œ ììœ  ì£¼í–‰í•©ë‹ˆë‹¤.</div>
        <div><b>ë°©í–¥í‚¤ëŠ” ë°˜ëŒ€</b>: â†(ìš°íšŒì „), â†’(ì¢ŒíšŒì „). A/DëŠ” ì¼ë°˜(ì¢Œ/ìš°)ì…ë‹ˆë‹¤.</div>
      </div>
    </div>

    <div class="panel" id="panel-adv">
      <div class="group">
        <div class="group-title">ë©”ëª¨</div>
        <div>CSV ë‚´ë³´ë‚´ê¸°, ì¹´ë©”ë¼ Follow í† ê¸€, ë¶€í•˜ì‹œí—˜ ë²„íŠ¼ ìœ ì§€.</div>
      </div>
    </div>

    <div class="panel" id="panel-help">
      <div class="group">
        <div class="group-title">í‚¤ë³´ë“œ</div>
        <div>W/â†‘ ê°€ì† Â· S/â†“ ë¸Œë ˆì´í¬ Â· â†(ìš°íšŒì „) â†’(ì¢ŒíšŒì „) Â· Space ì¬ìƒ/ì¼ì‹œì •ì§€</div>
      </div>
    </div>
  </section>

  <!-- Stage + ì˜¤ë¥¸ìª½ ì‚¬ì´ë“œ ê·¸ë˜í”„ -->
  <main class="app">
    <section class="card" style="padding:8px">
      <div class="telemetry">
        <div class="tile"><div class="k">ì†ë„</div><div class="v" id="v_kmh">0.0 km/h</div></div>
        <div class="tile"><div class="k">ëª¨í„° rpm</div><div class="v" id="rpm">0</div></div>
        <div class="tile"><div class="k">ì „ë¥˜</div><div class="v" id="i_a">0 A</div></div>
        <div class="tile"><div class="k">êµ¬ë™í† í¬</div><div class="v" id="torque">0 NÂ·m</div></div>
        <div class="tile"><div class="k">ì „ì••ëª…ë ¹</div><div class="v" id="v_cmd">0 V</div></div>
        <div class="tile"><div class="k">ì¡°í–¥</div><div class="v" id="steerDeg">0Â°</div></div>
      </div>
      <div id="three-wrap" tabindex="0"></div>
    </section>

    <aside class="sidebar">
      <div class="card" style="padding:10px">
        <div style="font-weight:800;color:#bfe3ff;margin:6px 2px">ğŸ“ˆ Telemetry (Time s)</div>
        <canvas id="chartSpeed"   class="chart"></canvas>
        <canvas id="chartCurrent" class="chart"></canvas>
        <canvas id="chartRpm"     class="chart"></canvas>
        <canvas id="chartTorque"  class="chart"></canvas>
      </div>
    </aside>
  </main>

  <footer>Â© EV Free Drive â€” ë‹¨ì¼ HTML. êµìœ¡ìš© ë‹¨ìˆœí™” ëª¨ë¸.</footer>

  <script type="module">
    import * as THREE from 'three';
    import { OrbitControls } from 'three/examples/jsm/controls/OrbitControls.js';

    // ---------- Helpers ----------
    const clamp=(x,a,b)=>Math.max(a,Math.min(b,x));
    const sign0=(x)=> Math.abs(x)<1e-6 ? 0 : (x>0?1:-1);
    const lerp =(a,b,t)=>a+(b-a)*t;

    // EMA smoother for tiles
    const smoother=(()=>{ const m=new Map(); let last=performance.now(); return{
      dt(){ const now=performance.now(); const d=now-last; last=now; return d; },
      run(k,target,tauMs,dtMs){ if(!tauMs||tauMs<=1){m.set(k,target);return target;}
        const prev=m.has(k)?m.get(k):target; const a=1-Math.exp(-dtMs/Math.max(1,tauMs));
        const out=prev+a*(target-prev); m.set(k,out); return out; }
    };})();

    const $=id=>document.getElementById(id);
    const els={
      btnControls:$('btnControls'), drawer:$('controlsDrawer'),
      btnStart:$('btnStart'), btnPause:$('btnPause'), btnReset:$('btnReset'), btnCsv:$('btnCsv'), btnFollow:$('btnFollow'), btnDisturb:$('btnDisturb'),
      tabs:[...document.querySelectorAll('.tab')], panels:{drive:$('panel-drive'), env:$('panel-env'), adv:$('panel-adv'), help:$('panel-help')},
      // controls
      mode:$('mode'), targetKmh:$('targetKmh'), Kps:$('Kps'), Kis:$('Kis'),
      throttle:$('throttle'), brake:$('brake'), steer:$('steer'), keyRate:$('keyRate'),
      Imax:$('Imax'), Kpc:$('Kpc'), Kic:$('Kic'), Vbus:$('Vbus'), R:$('R'), L:$('L'), kt:$('kt'), ke:$('ke'), delayMs:$('delayMs'), ffOn:$('ffOn'),
      Iregen:$('Iregen'), Pregen:$('Pregen'),
      mass:$('mass'), Rw:$('Rw'), gear:$('gear'), eta:$('eta'), CdA:$('CdA'), cr:$('cr'), rho:$('rho'), mu:$('mu'), gradeDeg:$('gradeDeg'),
      chartMs:$('chartMs'), chartWindow:$('chartWindow'), smoothMs:$('smoothMs'),
      // tiles
      v_kmh:$('v_kmh'), rpm:$('rpm'), i_a:$('i_a'), torque:$('torque'), v_cmd:$('v_cmd'), steerDeg:$('steerDeg')
    };

    // Drawer + tabs
    els.btnControls.addEventListener('click',()=>{ els.drawer.classList.toggle('open'); els.drawer.setAttribute('aria-hidden', !els.drawer.classList.contains('open'));});
    els.tabs.forEach(t=>t.addEventListener('click',()=>{ els.tabs.forEach(x=>x.classList.remove('active')); t.classList.add('active'); const k=t.dataset.tab; Object.values(els.panels).forEach(p=>p.classList.remove('active')); $('panel-'+k).classList.add('active');}));

    // Mode swap visibility
    const cruiseBox=document.getElementById('cruiseBox'), pedalBox=document.getElementById('pedalBox');
    els.mode.addEventListener('change',()=>{ const m=els.mode.value; cruiseBox.style.display=m==='cruise'?'':'none'; pedalBox.style.display=m==='pedal'?'':''; });

    // ---------- Charts (linear time axis) ----------
    const mkX=()=>({type:'linear', title:{display:true, text:'Time (s)', color:'#cfe4ff'}, ticks:{color:'#9fb3cc'}, grid:{color:'rgba(255,255,255,.08)'}});
    const mkY=(t)=>({title:{display:!!t, text:t, color:'#cfe4ff'}, ticks:{color:'#9fb3cc'}, grid:{color:'rgba(255,255,255,.06)'}});
    const plugins={legend:{labels:{color:'#cfe4ff'}}, decimation:{enabled:true, algorithm:'lttb', samples:800}};
    const cSpeed=new Chart($('chartSpeed'),{type:'line',data:{datasets:[
      {label:'Speed (km/h)', data:[], borderWidth:2, pointRadius:0, tension:.18},
      {label:'Ref (km/h)',   data:[], borderWidth:2, pointRadius:0, tension:.18, borderDash:[6,4]}
    ]},options:{animation:false, scales:{x:mkX(), y:mkY('km/h')}, plugins}});
    const cCurrent=new Chart($('chartCurrent'),{type:'line',data:{datasets:[
      {label:'Current (A)', data:[], yAxisID:'y1', borderWidth:2, pointRadius:0, tension:.18},
      {label:'Voltage (V)', data:[], yAxisID:'y2', borderWidth:2, pointRadius:0, tension:.18, borderDash:[6,4]}
    ]},options:{animation:false, scales:{x:mkX(), y1:mkY('A'), y2:{position:'right', grid:{drawOnChartArea:false}, ticks:{color:'#9fb3cc'}, title:{display:true, text:'V', color:'#cfe4ff'}}}, plugins}});
    const cRpm=new Chart($('chartRpm'),{type:'line',data:{datasets:[{label:'Motor RPM', data:[], borderWidth:2, pointRadius:0, tension:.18}]},options:{animation:false, scales:{x:mkX(), y:mkY('RPM')}, plugins}});
    const cTorque=new Chart($('chartTorque'),{type:'line',data:{datasets:[
      {label:'Drive Torque (Nm)', data:[], borderWidth:2, pointRadius:0, tension:.18},
      {label:'Load Torque (Nm)',  data:[], borderWidth:2, pointRadius:0, tension:.18, borderDash:[6,4]}
    ]},options:{animation:false, scales:{x:mkX(), y:mkY('Nm')}, plugins}});

    const MAX_POINTS=6000;
    function chartIntervalMs(){ return Math.max(16, +els.chartMs.value||120); }
    function timeWindowSec(){ return Math.max(5, +els.chartWindow.value||60); }
    function pushXY(chart, arr){ const t=state.t; chart.data.datasets.forEach((ds,i)=>{ ds.data.push({x:t, y:arr[i]}); if(ds.data.length>MAX_POINTS) ds.data.shift(); const win=timeWindowSec(); while(ds.data.length && ds.data[0].x < t-win) ds.data.shift();}); chart.update('none'); }

    // ---------- 3D Scene (free plane) ----------
    const wrap=$('three-wrap');
    const scene=new THREE.Scene(); scene.background=new THREE.Color(0x0b0f14);
    const camera=new THREE.PerspectiveCamera(55, wrap.clientWidth/Math.max(1,wrap.clientHeight), .1, 3000); camera.position.set(-18,10,18);
    const renderer=new THREE.WebGLRenderer({antialias:true}); renderer.setSize(wrap.clientWidth, wrap.clientHeight); wrap.appendChild(renderer.domElement);
    const controls=new OrbitControls(camera, renderer.domElement); controls.target.set(0,1,0); controls.update();
    wrap.addEventListener('pointerdown',()=>wrap.focus()); window.addEventListener('load',()=>wrap.focus(),{once:true});

    scene.add(new THREE.HemisphereLight(0xbfd1ff, 0x202020, .9));
    const dir=new THREE.DirectionalLight(0xffffff,.85); dir.position.set(10,20,10); dir.castShadow=true; scene.add(dir);
    scene.add(new THREE.GridHelper(2000, 200, 0x2b415e, 0x0e1624));
    const axes=new THREE.AxesHelper(5); axes.position.y=0.01; scene.add(axes);

    // Car (new wedge design)
    const car=new THREE.Group();
    // capsule body
    const bodyGeo=new THREE.CapsuleGeometry(0.95, 2.5, 10, 20); bodyGeo.rotateZ(Math.PI/2);
    const body=new THREE.Mesh(bodyGeo, new THREE.MeshStandardMaterial({color:0x144e7f, metalness:.6, roughness:.25}));
    body.position.y=0.9; body.castShadow=true; car.add(body);
    // wedge nose
    const nose=new THREE.Mesh(new THREE.ConeGeometry(0.95, 1.2, 18), new THREE.MeshStandardMaterial({color:0x175c99, metalness:.6, roughness:.25}));
    nose.rotation.z=-Math.PI/2; nose.position.set(1.7,0.88,0); car.add(nose);
    // glass roof
    const glass=new THREE.Mesh(new THREE.BoxGeometry(1.7,0.5,1.3), new THREE.MeshPhysicalMaterial({color:0xaad4ff, metalness:0, roughness:0.05, transmission:0.5, transparent:true, ior:1.45}));
    glass.position.set(0.2,1.4,0); car.add(glass);
    // lights
    const headL=new THREE.Mesh(new THREE.SphereGeometry(0.08), new THREE.MeshStandardMaterial({color:0x222, emissive:0xfff4d0, emissiveIntensity:3}));
    const headR=headL.clone(); headL.position.set(2.1,0.75, 0.45); headR.position.set(2.1,0.75,-0.45); car.add(headL,headR);
    const tailL=new THREE.Mesh(new THREE.SphereGeometry(0.08), new THREE.MeshStandardMaterial({color:0x222, emissive:0xff3b3b, emissiveIntensity:2.2}));
    const tailR=tailL.clone(); tailL.position.set(-2.1,0.75, 0.45); tailR.position.set(-2.1,0.75,-0.45); car.add(tailL,tailR);
    // wheels (torus tire + rim)
    function wheel(){
      const tire=new THREE.Mesh(new THREE.TorusGeometry(0.42,0.11,16,28), new THREE.MeshStandardMaterial({color:0x111, roughness:0.9, metalness:0.1}));
      tire.rotation.y=Math.PI/2;
      const rim=new THREE.Mesh(new THREE.CylinderGeometry(0.18,0.18,0.16,16), new THREE.MeshStandardMaterial({color:0xcad6e3, metalness:0.7, roughness:0.35}));
      rim.rotation.z=Math.PI/2; rim.position.x=0.02;
      const g=new THREE.Group(); g.add(tire,rim); return g;
    }
    const wFL=wheel(), wFR=wheel(), wRL=wheel(), wRR=wheel();
    wFL.position.set( 0.95,0.42, 0.82); wFR.position.set( 0.95,0.42,-0.82);
    wRL.position.set(-0.95,0.42, 0.82); wRR.position.set(-0.95,0.42,-0.82);
    car.add(wFL,wFR,wRL,wRR);
    const carAxes=new THREE.AxesHelper(1.2); carAxes.position.set(0,1,0); car.add(carAxes);
    scene.add(car);

    // ---------- Dynamics (free drive) ----------
    const state={running:false, follow:true, t:0, v:0, yaw:0, pos:new THREE.Vector3(0,0,0), i:0, ii:0, Vcmd:0, log:[]};
    const down=new Set();
    function ensurePedalMode(){ if(els.mode.value!=='pedal'){ els.mode.value='pedal'; els.mode.dispatchEvent(new Event('change')); } }

    window.addEventListener('keydown',e=>{
      const tag=(e.target?.tagName||'').toLowerCase(); if(tag==='input'||tag==='select'||tag==='textarea') return;
      if(['KeyW','KeyS','KeyA','KeyD','ArrowUp','ArrowDown','ArrowLeft','ArrowRight','Space'].includes(e.code)){ e.preventDefault(); down.add(e.code); }
    }, {capture:true});
    window.addEventListener('keyup',e=>down.delete(e.code), {capture:true});

    function P(){ return {
      mode: els.mode.value, targetKmh:+(els.targetKmh?.value||80), Kps:+(els.Kps?.value||6), Kis:+(els.Kis?.value||2),
      thr:+els.throttle.value/100, brk:+els.brake.value/100, steerDeg:+els.steer.value, keyRate:+els.keyRate.value,
      Imax:+els.Imax.value, Kpc:+els.Kpc.value, Kic:+els.Kic.value, Vbus:+els.Vbus.value, R:+els.R.value, L:+els.L.value, kt:+els.kt.value, ke:+els.ke.value, delayMs:+els.delayMs.value, ffOn:(els.ffOn.value==='1'),
      Iregen:+els.Iregen.value, Pregen:+els.Pregen.value*1000,
      m:+els.mass.value, Rw:+els.Rw.value, gear:+els.gear.value, eta:+els.eta.value, CdA:+els.CdA.value, cr:+els.cr.value, rho:+els.rho.value, mu:+els.mu.value, gradeDeg:+els.gradeDeg.value
    };}

    const kmh = v=>v*3.6;
    function motorWFromV(v,p){ return (v/p.Rw)*p.gear; } // rad/s

    function regenLimitTorque(tau, w, p){
      if(tau>=0) return tau;
      const T_i = p.kt * p.Iregen;
      const T_p = Math.abs(w)>1e-3 ? p.Pregen/Math.abs(w) : 1e9;
      return Math.max(tau, -Math.min(T_i, T_p));
    }

    function applyKey(dt){
      const p=P();
      // throttle/brake
      let thr=+els.throttle.value, brk=+els.brake.value, steer=+els.steer.value;
      if(down.has('KeyW')||down.has('ArrowUp')) thr += p.keyRate*dt;
      if(down.has('KeyS')||down.has('ArrowDown')) brk += p.keyRate*dt;
      if(!(down.has('KeyW')||down.has('ArrowUp'))) thr -= p.keyRate*0.6*dt;
      if(!(down.has('KeyS')||down.has('ArrowDown'))) brk -= p.keyRate*0.8*dt;
      thr=clamp(thr,0,100); brk=clamp(brk,0,100);
      if(thr>0&&brk>0){ if(thr>brk) brk=0; else thr=0; }
      // steering: A/D ì¼ë°˜, ë°©í–¥í‚¤ëŠ” ë°˜ëŒ€ë¡œ(ìš”ì²­)
      if(down.has('KeyA')) steer -= 120*dt;
      if(down.has('KeyD')) steer += 120*dt;
      if(down.has('ArrowLeft'))  steer += 120*dt; // â† = ìš°íšŒì „
      if(down.has('ArrowRight')) steer -= 120*dt; // â†’ = ì¢ŒíšŒì „
      steer = clamp(steer, -30, 30);

      els.throttle.value=Math.round(thr); els.brake.value=Math.round(brk); els.steer.value=Math.round(steer);
      els.steerDeg.textContent = `${Math.round(steer)}Â°`;

      if(down.has('Space')){ state.running=!state.running; down.delete('Space'); if(state.running){ last=performance.now(); requestAnimationFrame(loop);} }
      ensurePedalMode();
    }

    // Integrator step
    const DT_INT=0.001; let last=performance.now();
    function stepSim(dt){
      const p=P();
      let remain=dt; while(remain>1e-9){ const h=Math.min(DT_INT,remain);
        let i_ref;
        if(p.mode==='cruise'){
          const vref = clamp(p.targetKmh,0,220)/3.6;
          const ev = vref - state.v;
          i_ref = clamp(p.Kps*ev + (state.evInt||0)*p.Kis, -p.Imax, p.Imax);
          state.evInt = (state.evInt||0) + ev*h;
        }else{
          i_ref = p.Imax*p.thr - p.Iregen*0.9*p.brk;
          i_ref = clamp(i_ref, -p.Imax, p.Imax);
        }
        const ei = i_ref - state.i;
        const w_motor = motorWFromV(state.v,p);
        const Vff = p.ffOn ? p.ke*w_motor : 0;
        const Vunsat = p.Kpc*ei + state.ii*(p.Kic) + Vff;
        const Vcmd = clamp(Vunsat, -p.Vbus, p.Vbus);
        if((Vunsat>p.Vbus && ei<0) || (Vunsat<-p.Vbus && ei>0) || Math.abs(Vunsat)<=p.Vbus+1e-6) state.ii += ei*h;
        const a = Math.min(1, h/Math.max(1e-6, p.delayMs/1000));
        state.Vcmd = (1-a)*state.Vcmd + a*Vcmd;

        // electrical dynamics
        const di = (state.Vcmd - p.R*state.i - p.ke*w_motor)/Math.max(1e-9,p.L);
        state.i += di*h; state.i = clamp(state.i, -p.Imax, p.Imax);

        // torque + limits (regen)
        let tau_m = p.kt*state.i;
        tau_m = regenLimitTorque(tau_m, w_motor, p);

        // traction & forces
        let F_trac = (tau_m * p.gear * p.eta) / Math.max(1e-6, p.Rw);
        const F_mu = p.mu * p.m * 9.80665;
        F_trac = clamp(F_trac, -F_mu, F_mu);

        const v = state.v;
        const F_roll = p.m*9.80665*p.cr*sign0(v);
        const F_aero = 0.5*p.rho*p.CdA*v*v*sign0(v);
        const F_grade = p.m*9.80665*Math.sin((p.gradeDeg||0)*Math.PI/180);
        const F_long = F_trac - F_roll - F_aero - F_grade;

        // integrate speed
        state.v += (F_long/Math.max(1e-6,p.m)) * h;

        // bicycle kinematics
        const L = 2.6; // wheelbase
        const steer = (+els.steer.value||0) * Math.PI/180;
        const yawRate = Math.tan(steer) * state.v / L;
        state.yaw += yawRate * h;
        state.pos.x += Math.cos(state.yaw)*state.v*h;
        state.pos.z += Math.sin(state.yaw)*state.v*h;

        // tiny stickiness at rest
        if(Math.abs(state.v)<0.02 && Math.abs(i_ref)<1) state.v*=0.985;

        state.t += h; remain -= h;
      }
    }

    function updateCar(){
      car.position.set(state.pos.x, 0, state.pos.z);
      car.rotation.y = state.yaw;
      const wW = state.v / Math.max(1e-6, P().Rw);
      [wFL,wFR,wRL,wRR].forEach(w=> w.rotation.x -= wW*(1/60));
    }

    // Render
    let lastChart=0;
    function render(){
      const dtMs=smoother.dt(); const p=P();
      const kmhVal=kmh(state.v);
      const rpmVal = motorWFromV(state.v,p) * 60/(2*Math.PI);
      const tau = Math.max(0, +els.smoothMs.value||250);
      els.v_kmh.textContent = `${smoother.run('kmh',kmhVal, tau, dtMs).toFixed(1)} km/h`;
      els.rpm.textContent   = `${smoother.run('rpm', rpmVal, tau, dtMs).toFixed(0)}`;
      els.i_a.textContent   = `${smoother.run('i',   state.i, tau, dtMs).toFixed(1)} A`;
      const tqMotor = p.kt*state.i;
      els.torque.textContent= `${smoother.run('tq', tqMotor, tau, dtMs).toFixed(1)} NÂ·m`;
      els.v_cmd.textContent = `${smoother.run('vcmd',state.Vcmd, tau, dtMs).toFixed(1)} V`;
      els.steerDeg.textContent=`${(+els.steer.value||0).toFixed(0)}Â°`;
      updateCar();

      if(state.follow){
        const back = new THREE.Vector3(-10,6,0).applyAxisAngle(new THREE.Vector3(0,1,0), state.yaw);
        const camPos = new THREE.Vector3().copy(state.pos).add(back);
        camera.position.lerp(new THREE.Vector3(camPos.x, camPos.y, camPos.z), .15);
        const look = new THREE.Vector3(state.pos.x, 1, state.pos.z);
        controls.target.lerp(look, .2); controls.update();
      }

      const now=performance.now();
      if(now-lastChart>chartIntervalMs()){
        // load torque estimate for chart (roll+aero+grade at wheel to motor-side)
        const v=state.v;
        const F_roll = p.m*9.80665*p.cr*sign0(v);
        const F_aero = 0.5*p.rho*p.CdA*v*v*sign0(v);
        const F_grade= p.m*9.80665*Math.sin((p.gradeDeg||0)*Math.PI/180);
        const tau_load = (F_roll+F_aero+F_grade)*p.Rw/p.gear/Math.max(1e-6,p.eta);

        pushXY(cSpeed,   [kmh(state.v), (p.mode==='cruise'?p.targetKmh:kmh(state.v))]);
        pushXY(cCurrent, [state.i, state.Vcmd]);
        pushXY(cRpm,     [rpmVal]);
        pushXY(cTorque,  [tqMotor, tau_load]);
        lastChart=now;
      }

      state.log.push({t:state.t, kmh:kmh(state.v), ref:(p.mode==='cruise'?p.targetKmh:kmh(state.v)), i:state.i, v:state.Vcmd, tq:tqMotor});
    }

    function loop(now){ if(!state.running) return; const dt=Math.min(.05,(now-last)/1000); last=now; applyKey(dt); stepSim(dt); render(); renderer.render(scene,camera); requestAnimationFrame(loop); }

    // Resize
    new ResizeObserver(()=>{ const w=wrap.clientWidth, h=wrap.clientHeight; renderer.setSize(w,h); camera.aspect=w/Math.max(1,h); camera.updateProjectionMatrix(); }).observe(wrap);

    // Buttons
    els.btnStart.addEventListener('click',()=>{ if(!state.running){ state.running=true; last=performance.now(); requestAnimationFrame(loop);} });
    els.btnPause.addEventListener('click',()=> state.running=false);
    els.btnReset.addEventListener('click',()=>{
      state.running=false; Object.assign(state,{t:0,v:0,yaw:0,pos:new THREE.Vector3(0,0,0),i:0,ii:0,Vcmd:0,log:[]});
      [cSpeed,cCurrent,cRpm,cTorque].forEach(ch=>{ ch.data.datasets.forEach(ds=>ds.data=[]); ch.update(); });
      car.position.set(0,0,0); car.rotation.set(0,0,0);
    });
    els.btnCsv.addEventListener('click',()=>{
      if(!state.log.length) return;
      const rows=[["t(s)","speed(km/h)","speed_ref(km/h)","current(A)","voltage(V)","torque(Nm)"], ...state.log.map(d=>[d.t.toFixed(3),d.kmh.toFixed(3),d.ref.toFixed(3),d.i.toFixed(3),d.v.toFixed(3),d.tq.toFixed(3)])];
      const csv=rows.map(r=>r.join(',')).join('\n'); const blob=new Blob([csv],{type:'text/csv'}); const url=URL.createObjectURL(blob);
      const a=document.createElement('a'); a.href=url; a.download='ev_free_drive.csv'; a.click(); URL.revokeObjectURL(url);
    });
    els.btnFollow.addEventListener('click',()=>{ state.follow=!state.follow; els.btnFollow.textContent = state.follow?'ğŸ¥ Follow: ON':'ğŸ¥ Follow: OFF'; });

    // Focus
    wrap.focus();

    // ---------- Self-tests ----------
    (function(){
      const approx=(a,b,e=1e-6)=>Math.abs(a-b)<=e;
      console.assert(!!THREE.WebGLRenderer,'THREE missing');
      console.assert(typeof OrbitControls==='function','OrbitControls missing');
      console.assert(['chartSpeed','chartCurrent','chartRpm','chartTorque'].every(id=>!!document.getElementById(id)),'Charts missing');
      const p={Rw:0.31,gear:9}; const v=27.7778; const w=(v/p.Rw)*p.gear; const v2=w/p.gear*p.Rw; console.assert(approx(v,v2,1e-6),'w<->v mapping failed');
    })();
  </script>
</body>
</html>
