<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>6v6 STREET FOOTBALL · ES5 Fix + Auto-Restarts</title>
<style>
  html,body{margin:0;height:100%;background:#0c0f15;color:#e6edf3;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial}
  .wrap{display:grid;place-items:center;padding:10px}
  canvas{width:min(1200px,95vw);background:transparent;display:block;border:12px solid #1a202c;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
  #err{position:fixed;left:12px;right:12px;bottom:12px;background:rgba(0,0,0,.75);color:#ffdede;padding:10px 12px;border:1px solid #ff7b7b;border-radius:10px;font:12px/1.5 ui-sans-serif;display:none;white-space:pre-wrap;max-height:45vh;overflow:auto}
</style>
</head>
<body>
<div class="wrap"><canvas id="game" width="1100" height="680" tabindex="0" aria-label="축구게임 캔버스"></canvas></div>
<div id="err"></div>

<script>
(function(){
"use strict";

/* ===== 에러 오버레이 ===== */
var $err=document.getElementById('err');
function showErr(e){
  try{
    $err.style.display='block';
    $err.textContent='⚠ 실행 중 오류가 발생했습니다:\\n\\n'+(e&&e.stack?e.stack:e);
  }catch(_){}
}
window.addEventListener('error',function(ev){ showErr(ev.error||ev.message); });
window.addEventListener('unhandledrejection',function(ev){ showErr(ev.reason||'Unhandled promise rejection'); });

/* ===== 상수/유틸 ===== */
var W=1100,H=680,GOAL_W=120;
var CENTER={x:W/2,y:H/2};
var FRICTION=0.982, PLAYER_RADIUS=12, BALL_RADIUS=6, GRAB_DIST=16;
var PLAYER_SPEED_SCALE=0.2, SEPARATION_DIST=PLAYER_RADIUS*2.6, DIR_CONE=Math.PI/3;
var PASS_SPEED_FACTOR=0.25, PASS_HOLD_THROUGH=0.35, PASS_HOLD_MAX=0.8;
var SHOT_SPEED_MAX=6.1, SHOT_SPEED_MIN=3.2, SHOT_CHARGE_MAX=0.9;
var CURVE_DECAY=0.982;
var AI_SHOOT_DIST=200, AI_CROSS_BIAS=0.82;
var HALF_LEN=180;
var TEAM_COLOR_A="#2d7ff9", TEAM_COLOR_B="#f3533b", PLAYER_OUTLINE="#0b0f16", BALL_COLOR="#f3f3f3";
var STEAL_BASE=11, GK_ZONE_RADIUS=140, TAU=Math.PI*2;

function clamp(v,lo,hi){return Math.max(lo,Math.min(hi,v));}
function lerp(a,b,t){return a+(b-a)*t;}
function rand(a,b){a=a||0; b=b||1; return Math.random()*(b-a)+a;}

function Vec2(x,y){this.x=x||0; this.y=y||0;}
Vec2.prototype.set=function(x,y){this.x=x;this.y=y;return this;}
Vec2.prototype.clone=function(){return new Vec2(this.x,this.y);}
Vec2.prototype.add=function(v){this.x+=v.x;this.y+=v.y;return this;}
Vec2.prototype.sub=function(v){this.x-=v.x;this.y-=v.y;return this;}
Vec2.prototype.mul=function(s){this.x*=s;this.y*=s;return this;}
Vec2.prototype.len=function(){return Math.sqrt(this.x*this.x+this.y*this.y);}
Vec2.prototype.norm=function(){var l=this.len()||1;this.x/=l;this.y/=l;return this;}
Vec2.prototype.limit=function(m){var l=this.len(); if(l>m){this.mul(m/l);} return this;}
Vec2.add=function(a,b){return new Vec2(a.x+b.x,a.y+b.y);}
Vec2.sub=function(a,b){return new Vec2(a.x-b.x,a.y-b.y);}

/* 라운드 사각형 path(폴리필) */
function rrect(g,x,y,w,h,r){
  var rr=Math.max(0,Math.min(r,Math.min(w,h)/2));
  g.beginPath();
  g.moveTo(x+rr,y);
  g.arcTo(x+w,y,x+w,y+h,rr);
  g.arcTo(x+w,y+h,x,y+h,rr);
  g.arcTo(x,y+h,x,y,rr);
  g.arcTo(x,y,x+w,y,rr);
  g.closePath();
}

/* ===== 캔버스 ===== */
var canvas=document.getElementById('game');
var g=canvas.getContext('2d');
if(!g){ showErr("2D 캔버스를 초기화할 수 없습니다."); }
function resize(){
  var dpr=Math.min(2,window.devicePixelRatio||1);
  canvas.width=W*dpr; canvas.height=H*dpr;
  g.setTransform(dpr,0,0,dpr,0,0);
}
resize();
window.addEventListener('resize',resize);
canvas.addEventListener('pointerdown',function(){canvas.focus();});

/* ===== 입력 ===== */
var Keys={W:"KeyW",A:"KeyA",S:"KeyS",D:"KeyD",PASS1:"KeyJ",SHOOT1:"KeyK",SWITCH1:"KeyL",CURVE1:"KeyU",TACKLE1:"KeyH"};
function Input(){this.reset();}
Input.prototype.reset=function(){
  this.up=this.down=this.left=this.right=false;
  this.passHeld=false; this.passStart=0; this.passCharge=0; this.passTrigger=false; this.passIsThrough=false;
  this.switch=false; this.shootHeld=false; this.shootStart=0; this.shotCharge=0; this.shootRelease=false;
  this.curveHeld=false; this.tackleTap=false;
};
function handlePassKey(input,down,t){
  if(down){ if(!input.passHeld){ input.passHeld=true; input.passStart=t; } }
  else{ if(input.passHeld){ var dur=t-input.passStart; input.passIsThrough=(dur>=PASS_HOLD_THROUGH); input.passTrigger=true; } input.passHeld=false; }
}
function handleShootKey(input,down,t){
  if(down){ if(!input.shootHeld){ input.shootHeld=true; input.shootStart=t; } }
  else{ if(input.shootHeld){ input.shootHeld=false; input.shootRelease=true; } }
}

/* ===== 프로필 ===== */
var RoleProfile={
  GK:{spd:0.95, shot:0.5, tackle:0.95},
  CB:{spd:1.10, shot:0.6, tackle:1.28},
  CDM:{spd:0.95, shot:1.05, tackle:1.22},
  LW:{spd:1.18, shot:1.12, tackle:0.8},
  RW:{spd:1.18, shot:1.12, tackle:0.8},
  ST:{spd:1.16, shot:1.18, tackle:0.75}
};

/* ===== 엔티티 ===== */
function Ball(){
  this.pos=new Vec2(CENTER.x,CENTER.y);
  this.vel=new Vec2(); this.r=BALL_RADIUS; this.owner=null; this.curve=new Vec2(0,0);
  this.pk=0; this.assistTo=null; this.assistT=0; this.lastTouchTeam=null; this.lastKickInfo=null;
}
Ball.prototype.resetAt=function(left){
  this.pos.set(CENTER.x+(left?-40:40),CENTER.y);
  this.vel.set(0,0); this.owner=null; this.curve.set(0,0);
  this.pk=0; this.assistTo=null; this.assistT=0;
};
Ball.prototype.update=function(dt){
  this.pk=Math.max(0,(this.pk||0)-dt);
  this.assistT=Math.max(0,(this.assistT||0)-dt);
  if(this.owner){
    var f=this.owner.facing.clone().norm().mul(10);
    this.pos.set(this.owner.pos.x+f.x,this.owner.pos.y+f.y);
    this.vel.mul(0); this.curve.mul(0); this.assistTo=null; this.assistT=0;
    return;
  }
  this.pos.add(this.vel);
  this.vel.add(this.curve); this.curve.mul(CURVE_DECAY);
  this.vel.mul(FRICTION);
  this.boundary();
};
Ball.prototype.boundary=function(){
  var wy=this.pos.y>H/2-GOAL_W/2 && this.pos.y<H/2+GOAL_W/2;
  if(wy){
    if(this.pos.x<=30) game.goal("B");
    else if(this.pos.x>=W-30) game.goal("A");
  }
  var out=null;
  if(this.pos.y<20+this.r) out="TOP";
  else if(this.pos.y>H-20-this.r) out="BOT";
  else if(this.pos.x<20+this.r) out="LEFT";
  else if(this.pos.x>W-20-this.r) out="RIGHT";
  if(out){
    var end=(out==="LEFT"||out==="RIGHT");
    if(end){
      var defend = (this.lastTouchTeam===game.teamA)? game.teamB : game.teamA;
      if(this.lastTouchTeam===defend) game.queueCorner(out, defend.oppo);
      else game.queueGoalKick(defend, out);
    } else {
      game.queueThrowIn(out);
    }
  }
};
Ball.prototype.kick=function(to,s){ this.owner=null; this.pk=0.25; this.assistTo=null; this.assistT=0; var d=Vec2.sub(to,this.pos).norm(); this.vel=d.mul(s); };
Ball.prototype.knock=function(dir,s){ this.owner=null; this.pk=0.2; this.vel=dir.clone().norm().mul(s); };
Ball.prototype.draw=function(g){ g.save(); g.fillStyle=BALL_COLOR; g.beginPath(); g.arc(this.pos.x,this.pos.y,this.r,0,TAU); g.fill(); g.restore(); };

function Player(team,role,x,y,color){
  this.team=team; this.role=role; this.home=new Vec2(x,y);
  this.pos=new Vec2(x,y); this.vel=new Vec2(); this.r=PLAYER_RADIUS;
  this.color=color; this.controlled=0; this.facing=new Vec2(team.side==="L"?1:-1,0);
  this.tackleCd=0; this.prof=RoleProfile[role]; this.frozen=false;
}
Player.prototype.hasBall=function(){return game && game.ball.owner===this;};
Player.prototype.distBall=function(){return Vec2.sub(game.ball.pos,this.pos).len();};
Player.prototype.update=function(dt){
  if(this.frozen){ this.vel.mul(0); return; }
  this.tackleCd=Math.max(0,this.tackleCd-dt);
  if(this.controlled===1) this.updateHuman(1,dt);
  else this.updateAI(dt);

  var baseMax=(2.5+1.5)*PLAYER_SPEED_SCALE*this.prof.spd;
  var maxSpd=baseMax; if(this.hasBall()) maxSpd*=0.9;
  this.vel.limit(maxSpd);
  this.pos.add(this.vel);
  this.pos.x=clamp(this.pos.x,20+this.r,W-20-this.r);
  this.pos.y=clamp(this.pos.y,20+this.r,H-20-this.r);

  if(game && !game.ball.owner && (game.ball.pk||0)<=0 && this.distBall()<GRAB_DIST){
    game.ball.owner=this; game.ball.vel.mul(0); game.ball.curve.set(0,0);
  }
};
Player.prototype.tryTackle=function(){
  if(this.tackleCd>0) return;
  var range=STEAL_BASE + (this.prof.tackle-1)*6;
  this.tackleCd=0.48 + (1-this.prof.tackle)*0.25;
  var d=this.distBall();
  if(d<this.r+range){
    var dir=Vec2.sub(game.ball.pos,this.pos);
    if(dir.len()>0) game.ball.knock(dir,7.0*this.prof.tackle);
  }
};
Player.prototype.updateHuman=function(which,dt){
  var input=game.input1;
  var dir=new Vec2((input.right?1:0)-(input.left?1:0),(input.down?1:0)-(input.up?1:0));
  if(dir.x||dir.y) this.facing=dir.clone().norm();
  var accel=0.6*PLAYER_SPEED_SCALE*this.prof.spd; if(this.hasBall()) accel*=1.2;
  this.vel.mul(0.85).add(dir.mul(accel));

  if(input.tackleTap){ this.tryTackle(); input.tackleTap=false; }
  if(input.shootRelease){
    if(this.hasBall()){
      var pow=clamp(input.shotCharge,0,1);
      if(input.curveHeld) this.shootCurve(pow); else this.shoot(pow);
      game.onBallKicked(this.team,this,true);
    }
    input.shootRelease=false; input.shotCharge=0;
  }
  if(input.passTrigger){
    if(this.hasBall()){
      var type=input.passIsThrough ? (this.isWideArea()?"cross":"through") : "normal";
      this.pass(type);
    }
    input.passTrigger=false;
  }
  if(input.switch){ game.manualSwitch(1); input.switch=false; }
};
Player.prototype.isWideArea=function(){
  var wing=(this.pos.y< H*0.30 || this.pos.y> H*0.70);
  var forwardThird = this.team.side==="L" ? (this.pos.x>W*0.62) : (this.pos.x<W*0.38);
  return wing && forwardThird;
};
Player.prototype.pass=function(type){
  var from=game.ball.pos.clone(); var t=null;
  var dir=this.facing.clone();
  // 앞쪽 원뿔 내 동료 선택
  var bestAng=9, bestDist=1e9, i;
  for(i=0;i<this.team.players.length;i++){
    var p=this.team.players[i]; if(p===this) continue;
    var v=Vec2.sub(p.pos,this.pos); var d=v.len(); if(d<28) continue;
    var dot=(v.x/d)*dir.x+(v.y/d)*dir.y; if(dot>1)dot=1; if(dot<-1)dot=-1;
    var ang=Math.acos(dot);
    if(ang<DIR_CONE && (ang<bestAng || (Math.abs(ang-bestAng)<0.05 && d<bestDist))){ bestAng=ang; bestDist=d; t=p; }
  }
  if(type==="cross" || (!type && this.isWideArea())){ this.cross(); game.onBallKicked(this.team,this,true); return; }
  var aim,speed;
  if(type==="through"){
    var goalDir=this.team.side==="L"?1:-1;
    if(!t){ var forward=new Vec2(goalDir,0); aim=Vec2.add(from,forward.mul(150)); speed=clamp(7.0,4.2,7.8); }
    else{
      var lead=t.vel.clone(); var towardGoal=new Vec2(goalDir,0);
      var tt=0.65; var pred=t.pos.clone().add(lead.mul(tt*14)).add(towardGoal.mul(42));
      var to=Vec2.sub(pred,from); var ang=Math.atan2(to.y,to.x); var dist=Math.sqrt(to.x*to.x+to.y*to.y);
      ang+=rand(-Math.PI/48,Math.PI/48); dist+=rand(-6,6);
      aim=new Vec2(from.x+Math.cos(ang)*dist, from.y+Math.sin(ang)*dist);
      speed=clamp(dist/0.55,5.6,8.0)*PASS_SPEED_FACTOR*1.25;
    }
  }else{
    if(!t){
      var f=dir.clone().norm(); aim=Vec2.add(from,f.mul(92));
      var d0=Math.sqrt((aim.x-from.x)*(aim.x-from.x)+(aim.y-from.y)*(aim.y-from.y)); var tt0=0.5;
      speed=clamp(d0/tt0,4.2,6.5)*PASS_SPEED_FACTOR;
    }else{
      var lead2=t.vel.clone(); var tt2=0.55; var pred2=t.pos.clone().add(lead2.mul(tt2*10));
      var to2=Vec2.sub(pred2,from); var ang2=Math.atan2(to2.y,to2.x)+rand(-Math.PI/36,Math.PI/36); var dist2=Math.sqrt(to2.x*to2.x+to2.y*to2.y)+rand(-8,8);
      aim=new Vec2(from.x+Math.cos(ang2)*dist2, from.y+Math.sin(ang2)*dist2);
      speed=clamp(dist2/(0.55+0.1),4.2,7.2)*PASS_SPEED_FACTOR;
    }
  }
  game.ball.kick(aim,speed);
  if(t){ game.ball.assistTo=t; game.ball.assistT=0.65; game.ball.pk=0.15; }
  var isForward=this.team.side==="L" ? (aim.x>from.x) : (aim.x<from.x);
  game.onBallKicked(this.team,this,isForward);
};
Player.prototype.shoot=function(pow){
  if(pow===undefined) pow=0.6;
  var gx=this.team.side==="L"?W-15:15, gy=H/2+rand(-10,10);
  var aim=new Vec2(gx,gy);
  var speed=SHOT_SPEED_MIN + (SHOT_SPEED_MAX-SHOT_SPEED_MIN)*pow;
  speed*=this.prof.shot; if(speed>SHOT_SPEED_MAX) speed=SHOT_SPEED_MAX;
  game.ball.kick(aim,speed); game.ball.curve.set(0,0);
};
Player.prototype.shootCurve=function(pow){
  if(pow===undefined) pow=0.6;
  var gx=this.team.side==="L"?W-18:18, gy=H/2+rand(-8,8);
  var aim=new Vec2(gx,gy);
  var speed=SHOT_SPEED_MIN + (SHOT_SPEED_MAX-SHOT_SPEED_MIN)*pow;
  speed=Math.min(SHOT_SPEED_MAX, speed*this.prof.shot*1.02);
  game.ball.kick(aim,speed);
  var f=this.facing.clone().norm(); var perp=new Vec2(-f.y,f.x); var side=(this.team.side==="L"?1:-1);
  var base=(0.16+0.06*pow)*(0.8+this.prof.shot*0.5)*side;
  game.ball.curve=perp.mul(base); game.ball.curve.y+=0.02*(rand(0.8,1.2));
};
Player.prototype.cross=function(){
  var tx=this.team.side==="L"?W-90:90, ty=H/2+rand(-40,40);
  game.ball.kick(new Vec2(tx,ty),6.6*0.95); game.ball.curve.set(0,0);
};
Player.prototype.zoneHold=function(){ var t=this.team.shapeTarget(this); this.seek(t,0.11*this.prof.spd); };
Player.prototype.supportRun=function(){
  var dir=this.team.side==="L"?1:-1; var b=game.ball.pos; var t=this.home.clone();
  if(this.role==="ST"){ t.x=b.x+95*dir; t.y=lerp(t.y,b.y,0.28); }
  else if(this.role==="LW"){ t.x=b.x+80*dir; t.y=this.team.side==="L"?H*0.22:H*0.78; }
  else if(this.role==="RW"){ t.x=b.x+80*dir; t.y=this.team.side==="L"?H*0.78:H*0.22; }
  else if(this.role==="CDM"){ t.x=b.x-20*dir; t.y=lerp(t.y,b.y,0.24); }
  else if(this.role==="CB"){ t.x=lerp(t.x,this.team.side==="L"?190:W-190,0.85); t.y=lerp(t.y,H*0.55,0.18); }
  this.seek(t,0.12*this.prof.spd);
};
Player.prototype.blockLane=function(owner){
  var mid=new Vec2((owner.pos.x+game.ball.pos.x)/2,(owner.pos.y+game.ball.pos.y)/2); this.seek(mid,0.12*this.prof.spd);
};
Player.prototype.updateAI=function(dt){
  if(game.state==="restart"){ this.vel.mul(0); return; }
  if(this.role==="GK"){ this.updateGK(); return; }

  var ball=game.ball, have=(ball.owner&&ball.owner.team===this.team);
  if(!ball.owner){
    this.zoneHold();
    if(this.distBall()<GRAB_DIST && (ball.pk||0)<=0){ ball.owner=this; return; }
    return;
  }
  if(have){
    if(this.hasBall()){
      var goal=new Vec2(this.team.side==="L"?W-40:40,H/2);
      var d=Vec2.sub(goal,this.pos).len();
      if(this.role==="LW"||this.role==="RW"){
        if(this.isWideArea() && Math.random()<AI_CROSS_BIAS){ this.cross(); return; }
      }
      if(d<AI_SHOOT_DIST && (this.role!=="CB")){
        if(Math.random()<0.65) this.shoot(rand(0.5,0.9)); else this.shootCurve(rand(0.5,0.9)); return;
      }
      this.seek(goal,0.6*this.prof.spd);
    } else {
      this.supportRun();
    }
  } else {
    if(this.role==="CB"){ this.blockLane(ball.owner); if(this.distBall()<24) this.tryTackle(); return; }
    this.zoneHold();
    if(this.distBall()<22) this.tryTackle();
  }
};
Player.prototype.updateGK=function(){
  var left=this.team.side==="L", gx=left?26:W-26;
  var goalY=clamp(game.ball.pos.y,H/2-GOAL_W/2+10,H/2+GOAL_W/2-10);
  var target=new Vec2(gx+(left?10:-10), goalY);
  this.seek(target,0.16*this.prof.spd);

  var d=this.distBall();
  var owner=game.ball.owner;

  // 펀칭
  if(!owner){
    var towardGoal = left? (game.ball.pos.x<80) : (game.ball.pos.x>W-80);
    var speed=Math.sqrt(game.ball.vel.x*game.ball.vel.x+game.ball.vel.y*game.ball.vel.y);
    if(towardGoal && d<28 && speed>3.4){
      var away = left? new Vec2(1,rand(-0.4,0.4)) : new Vec2(-1,rand(-0.4,0.4));
      game.ball.lastTouchTeam=this.team; game.ball.knock(away, rand(3.6,5.0));
      return;
    }
  }
  // 인터셉트/돌진
  if(owner && owner.team!==this.team){
    var toOwner = Vec2.sub(owner.pos,this.pos);
    var inZone = toOwner.len()<GK_ZONE_RADIUS;
    var ownerAdvancing = left ? (owner.pos.x < this.pos.x+40) : (owner.pos.x > this.pos.x-40);
    if(inZone && ownerAdvancing){
      this.seek(owner.pos,0.28*this.prof.spd);
      if(this.distBall()<26) this.tryTackle();
      return;
    }
  }
  // 캐치 → 분배
  if(d<GRAB_DIST+4 && (game.ball.pk||0)<=0){ game.ball.owner=this; this._holdT=(game.t||0); return; }
  if(this.hasBall()){
    if((game.t - (this._holdT||0))>0.35){
      var opts=["LW","RW","CDM","ST"], i;
      for(i=0;i<opts.length;i++){
        var p=seekRole(this.team,opts[i]);
        if(p){
          var forward = left? p.pos.x>this.pos.x : p.pos.x<this.pos.x;
          if(forward){ this.pass("normal"); break; }
        }
      }
    }
  }
};
function seekRole(team,role){
  for(var i=0;i<team.players.length;i++){ if(team.players[i].role===role) return team.players[i]; }
  return null;
}
Player.prototype.seek=function(t,k){ if(k===undefined)k=0.1; var d=Vec2.sub(t,this.pos); if(d.len()>1)d.norm(); this.vel.add(d.mul(k)); if(d.x||d.y)this.facing=d; };
Player.prototype.draw=function(g){
  g.save();
  g.lineWidth=2; g.fillStyle=this.color; g.strokeStyle=PLAYER_OUTLINE;
  g.beginPath(); g.arc(this.pos.x,this.pos.y,this.r,0,TAU); g.fill(); g.stroke();

  // 방향 삼각
  var f=this.facing.clone().norm(), right=new Vec2(-f.y,f.x);
  var nose=Vec2.add(this.pos,f.clone().mul(this.r));
  var p1=Vec2.add(this.pos,right.clone().mul(this.r*0.7));
  var p2=Vec2.add(this.pos,right.clone().mul(-this.r*0.7));
  g.beginPath(); g.moveTo(nose.x,nose.y); g.lineTo(p1.x,p1.y); g.lineTo(p2.x,p2.y); g.closePath();
  g.globalAlpha=0.15; g.fillStyle="#000"; g.fill(); g.globalAlpha=1;

  // 컨트롤/골키퍼 링 (GK는 두께 2배)
  var controlled=this.controlled>0;
  if(controlled || this.role==="GK"){
    g.strokeStyle=controlled ? "#fff" : "rgba(255,255,255,.35)";
    g.lineWidth=(this.role==="GK"?4:2);
    if(controlled){ g.setLineDash([4,4]); }
    g.beginPath(); g.arc(this.pos.x,this.pos.y,this.r+6,0,TAU); g.stroke();
    if(controlled){ g.setLineDash([]); }
  }
  // GK 영향 범위
  if(this.role==="GK"){
    g.strokeStyle="rgba(255,255,255,.08)";
    g.lineWidth=4; g.beginPath(); g.arc(this.pos.x,this.pos.y,GK_ZONE_RADIUS,0,TAU); g.stroke();
  }

  // 원 안에 포지션 텍스트
  g.font="bold 10px ui-sans-serif"; g.textAlign="center"; g.textBaseline="middle";
  g.shadowColor="rgba(0,0,0,.4)"; g.shadowBlur=2; g.fillStyle="#e8f2ff";
  g.fillText(this.role, this.pos.x, this.pos.y);
  g.shadowBlur=0;

  // 볼 점등
  if(this.hasBall()){
    g.fillStyle="#ffd84d"; g.beginPath(); g.arc(this.pos.x,this.pos.y-this.r-6,3.5,0,TAU); g.fill();
  }
  g.restore();
};

/* ===== 팀(전역 참조 제거) ===== */
function Team(name,side,color){ this.name=name; this.side=side; this.color=color; this.players=[]; this.score=0; this.oppo=null; this.game=null; }
Team.prototype._ball = function(){
  var gme=this.game || (typeof window!=="undefined" && window.game) || null;
  return gme ? gme.ball : { pos:new Vec2(W/2,H/2) };
};
Team.prototype.formation=function(){ var L=this.side==="L",sx=function(x){return L?x:(W-x)}; return [["GK",sx(60),H/2],["CB",sx(210),H*0.55],["CDM",sx(330),H*0.45],["LW",sx(420),L?H*0.28:H*0.72],["RW",sx(420),L?H*0.72:H*0.28],["ST",sx(560),H*0.50]]; };
Team.prototype.spawn=function(){ this.players=[]; var f=this.formation(), i; for(i=0;i<f.length;i++){ var r=f[i]; this.players.push(new Player(this,r[0],r[1],r[2],this.color)); } };
Team.prototype.shapeTarget=function(p){ var bpos=this._ball().pos; var t=p.home.clone(),has=(this.game && this.game.ball.owner && this.game.ball.owner.team===this),dir=this.side==="L"?1:-1; if(has){ if(p.role==="ST")t.x+=32*dir; if(p.role==="LW"||p.role==="RW")t.x+=26*dir; if(p.role==="CDM")t.x+=10*dir; } else { if(p.role==="CB")t.x-=20*dir; if(p.role==="CDM")t.x-=10*dir; } t.y=lerp(t.y,bpos.y,0.08); return t; };
Team.prototype.nearestForSwitch=function(){ var bpos=this._ball().pos; var best=null,sc=-1e9,i; for(i=0;i<this.players.length;i++){ var pl=this.players[i]; var d=Vec2.sub(bpos,pl.pos).len(),tow=this.side==="L"?(bpos.x-pl.pos.x):(pl.pos.x-bpos.x),s=-d+tow*0.4+(pl.role==="ST"?8:0); if(s>sc){sc=s;best=pl;} } return best; };
Team.prototype.pickPressers=function(){ var bpos=this._ball().pos; var arr=this.players.slice().sort(function(a,b){ return Vec2.sub(bpos,a.pos).len()-Vec2.sub(bpos,b.pos).len(); }); return {primary:arr[0],secondary:arr[1]}; };
Team.prototype.computeOffsideLine=function(){ var xs=[], i; for(i=0;i<this.oppo.players.length;i++){ xs.push(this.oppo.players[i].pos.x); } xs.sort(function(a,b){return a-b;}); return this.side==="L" ? xs[xs.length-2] : xs[1]; };
Team.prototype.isOffsidePos=function(p){ var line=this.computeOffsideLine(), bx=this._ball().pos.x; if(this.side==="L"){ return (p.pos.x>Math.max(line,bx) && p.pos.x>W/2); } else { return (p.pos.x<Math.min(line,bx) && p.pos.x<W/2); } };

/* ===== 게임 ===== */
function Game(){
  this.state="play"; this.t=0; this.timeLeft=HALF_LEN;
  this.ball=new Ball();
  this.teamA=new Team("A","L",TEAM_COLOR_A);
  this.teamB=new Team("B","R",TEAM_COLOR_B);
  this.teamA.oppo=this.teamB; this.teamB.oppo=this.teamA;
  this.teamA.game=this; this.teamB.game=this;  /* ← 전역 의존 제거 */
  this.input1=new Input();
  this.humanTeam1=this.teamA;
  this.lastTs=0; this.dt=0;
  this.offside=null; this.restart=null;
  this.kickoffIdleAutoAt=0;

  this.teamA.spawn(); this.teamB.spawn();
  this.assignControllers();
  this.resetAfterGoal(true);
}
Game.prototype.assignControllers=function(){
  var i; for(i=0;i<this.teamA.players.length;i++) this.teamA.players[i].controlled=0;
  for(i=0;i<this.teamB.players.length;i++) this.teamB.players[i].controlled=0;
  var p1=this.humanTeam1.nearestForSwitch(); p1.controlled=1;
};
Game.prototype.manualSwitch=function(which){
  var team=this.humanTeam1; var n=team.nearestForSwitch(); var i;
  for(i=0;i<team.players.length;i++){ if(team.players[i].controlled===1) team.players[i].controlled=0; }
  n.controlled=1;
};
Game.prototype.goal=function(who){
  if(this.state!=="play")return;
  if(who==="A")this.teamA.score++; else this.teamB.score++;
  this.banner("GOAL!");
  var self=this; setTimeout(function(){ var leftKick=(who==="B"); self.resetAfterGoal(leftKick); },900);
};
Game.prototype.resetAfterGoal=function(leftKick){
  this.ball.resetAt(leftKick);
  this.teamA.spawn(); this.teamB.spawn();
  this.teamA.game=this; this.teamB.game=this;
  var kicker=(leftKick?this.teamA:this.teamB).players[2]; // CDM
  this.ball.owner=kicker;
  this.assignControllers();
  this.offside=null; this.restart=null;
  this.kickoffIdleAutoAt=this.t+1.2;
};
Game.prototype.onBallKicked=function(attTeam,passer,isForward){ this.ball.lastKickInfo={team:attTeam,pos:passer.pos.clone()}; this.ball.lastTouchTeam=attTeam; };
Game.prototype.ballPlayerCollisions=function(){
  var all=this.teamA.players.concat(this.teamB.players), i;
  for(i=0;i<all.length;i++){
    var p=all[i], d=Vec2.sub(this.ball.pos,p.pos), L=d.len(), min=p.r+this.ball.r;
    if(L>0&&L<min){
      if(!this.ball.owner && (this.ball.pk||0)<=0){
        this.ball.owner=p; this.ball.vel.mul(0); this.ball.curve.set(0,0);
        var f=p.facing.clone().norm().mul(10); this.ball.pos.set(p.pos.x+f.x,p.pos.y+f.y);
        this.ball.lastTouchTeam=p.team;
      }
    }
  }
};
/* 재시작 큐 & 자동 킥 */
Game.prototype.queueThrowIn=function(side){
  var defend = (this.ball.lastTouchTeam===this.teamA)? this.teamB : this.teamA;
  var pos={x:(side==="LEFT"?28:side==="RIGHT"?W-28:clamp(this.ball.pos.x,40,W-40)),
           y:(side==="TOP"?28:side==="BOT"?H-28:clamp(this.ball.pos.y,40,H-40))};
  var taker = defend.players[2]; // CDM 대리
  this.startRestart("THROW-IN", defend, taker, pos);
};
Game.prototype.queueCorner=function(outSide,attackTeam){
  var x=(outSide==="LEFT")?24:W-24; var y=(this.ball.pos.y<H/2)?24:H-24;
  var taker = attackTeam.players[3]; // LW/RW 느낌
  this.startRestart("CORNER", attackTeam, taker, {x:x,y:y});
};
Game.prototype.queueGoalKick=function(defendTeam){
  var taker=seekRole(defendTeam,"GK")||defendTeam.players[0]; var x=(defendTeam.side==="L")?60:W-60; var y=H/2;
  this.startRestart("GOAL-KICK", defendTeam, taker, {x:x,y:y});
};
Game.prototype.startRestart=function(kind,team,taker,pos){
  this.state="restart";
  this.restart={kind:kind,team:team,taker:taker,pos:new Vec2(pos.x,pos.y),autoKickAt:this.t+(kind==="CORNER"?1.1:0.9)};
  taker.pos.set(pos.x,pos.y); this.ball.owner=taker; this.ball.pos.set(pos.x,pos.y);
  // 모두 정지(키커 고정)
  var all=team.players.concat(team.oppo.players), i;
  for(i=0;i<all.length;i++){ all[i].frozen=true; all[i].vel.mul(0); }
  taker.frozen=true;
};
Game.prototype.autoKickNow=function(){
  var r=this.restart; if(!r) return; var k=r.taker;
  if(r.kind==="CORNER") k.cross();
  else if(r.kind==="GOAL-KICK") k.shoot(0.6);
  else k.pass("normal");
  this.state="play"; this.restart=null;
  var all=this.teamA.players.concat(this.teamB.players), i; for(i=0;i<all.length;i++) all[i].frozen=false;
};
Game.prototype.maybeAutoRestart=function(){
  var r=this.restart; if(!r) return;
  if(this.t>r.autoKickAt) this.autoKickNow();
};
Game.prototype.endRestartIfKicked=function(){
  if(this.state!=="restart" || !this.restart || !this.restart.taker) return;
  var k=this.restart.taker, i=this.input1, acted=false;
  if(i.shootRelease){ var pow=clamp(i.shotCharge,0,1); if(i.curveHeld) k.shootCurve(pow); else k.shoot(pow); acted=true; i.shootRelease=false; i.shotCharge=0; }
  if(i.passTrigger){ var type=i.passIsThrough ? (k.isWideArea()?"cross":"through") : "normal"; k.pass(type); i.passTrigger=false; acted=true; }
  if(acted){ this.state="play"; this.restart=null; var all=this.teamA.players.concat(this.teamB.players), j; for(j=0;j<all.length;j++) all[j].frozen=false; }
};
Game.prototype.separate=function(arr){
  var i,j;
  for(i=0;i<arr.length;i++) for(j=i+1;j<arr.length;j++){
    var a=arr[i], b=arr[j];
    var d=Vec2.sub(b.pos,a.pos); var L=d.len(); var min=SEPARATION_DIST;
    if(L>0&&L<min){
      d.norm(); var push=(min-L)/2;
      a.pos.add(new Vec2(-d.x*push,-d.y*push)); b.pos.add(new Vec2(d.x*push,d.y*push));
      a.vel.mul(0.8); b.vel.mul(0.8);
    }
  }
};
Game.prototype.tick=function(ts){
  var dt=Math.min(0.033,(ts-this.lastTs)/1000||0); this.lastTs=ts; this.dt=dt;
  this.update(dt); this.render();
  window.requestAnimationFrame(this.tick.bind(this));
};
Game.prototype.update=function(dt){
  this.t+=dt; this.timeLeft=Math.max(0,this.timeLeft-dt); if(this.timeLeft<=0) this.timeLeft=HALF_LEN;
  if(this.state==="restart"){ this.maybeAutoRestart(); return; }
  var i1=this.input1;
  if(i1.passHeld) i1.passCharge=clamp((this.t - i1.passStart)/PASS_HOLD_MAX,0,1); else i1.passCharge*=0.9;
  if(i1.shootHeld) i1.shotCharge=clamp((this.t - i1.shootStart)/SHOT_CHARGE_MAX,0,1); else i1.shotCharge*=0.9;

  var k;
  for(k=0;k<this.teamA.players.length;k++) this.teamA.players[k].update(dt);
  for(k=0;k<this.teamB.players.length;k++) this.teamB.players[k].update(dt);
  this.separate(this.teamA.players.concat(this.teamB.players));

  var prev=this.ball.owner; this.ball.update(dt);
  if(prev!==this.ball.owner && this.ball.owner && this.ball.owner.team===this.humanTeam1){
    for(k=0;k<this.humanTeam1.players.length;k++) if(this.humanTeam1.players[k].controlled===1) this.humanTeam1.players[k].controlled=0;
    this.ball.owner.controlled=1;
  }
  this.ballPlayerCollisions();

  // 킥오프 시 무입력 → 자동 패스
  if(this.ball.owner && this.ball.owner.controlled===1 && (this.t>this.kickoffIdleAutoAt)){
    this.ball.owner.pass("normal");
    this.kickoffIdleAutoAt = 1e9;
  }
};
Game.prototype.pitch=function(g){
  g.save();
  g.strokeStyle="#e7f5e9"; g.globalAlpha=0.6; g.lineWidth=2;
  g.strokeRect(20,20,W-40,H-40);
  g.beginPath(); g.moveTo(W/2,20); g.lineTo(W/2,H-20); g.stroke();
  g.beginPath(); g.arc(W/2,H/2,70,0,TAU); g.stroke();
  g.lineWidth=3; g.strokeRect(20,H/2-H*0.25,70,H*0.5); g.strokeRect(W-90,H/2-H*0.25,70,H*0.5);
  g.restore();
};
Game.prototype.goal3D=function(g){
  var y1=H/2-GOAL_W/2, y2=H/2+GOAL_W/2, lw=6;
  g.save();
  g.fillStyle="rgba(255,255,255,0.9)"; g.fillRect(14,y1,lw,GOAL_W); g.fillRect(14, y1-6, 50, 6);
  g.globalAlpha=0.25; g.fillStyle="#fff"; g.fillRect(14+lw, y1, 12, GOAL_W);
  g.globalAlpha=0.15; g.fillRect(14, y1, 50, 2); g.fillRect(14, y2-2, 50, 2);
  g.globalAlpha=1; g.fillStyle="rgba(255,255,255,0.9)"; g.fillRect(W-20-lw,y1,lw,GOAL_W); g.fillRect(W-20-50, y1-6, 50, 6);
  g.globalAlpha=0.25; g.fillStyle="#fff"; g.fillRect(W-20-lw-12, y1, 12, GOAL_W);
  g.globalAlpha=0.15; g.fillRect(W-20-50, y1, 50, 2); g.fillRect(W-20-50, y2-2, 50, 2);
  g.restore();
};
Game.prototype.banner=function(text){ this._banner={text:text, until:this.t+0.85}; };
Game.prototype.drawUI=function(g){
  // 중앙 상단 박스(타이머 + 점수)
  var boxW=270, boxH=40, x=(W-boxW)/2, y=10;
  g.save();
  g.fillStyle="rgba(0,0,0,.45)"; g.strokeStyle="rgba(255,255,255,.12)"; g.lineWidth=1.5;
  rrect(g,x,y,boxW,boxH,10); g.fill(); g.stroke();
  g.font="900 16px ui-sans-serif"; g.textBaseline="middle"; g.textAlign="center"; g.fillStyle="#cde5ff";
  g.fillText((("0"+((this.timeLeft/60)|0)).slice(-2))+":"+(("0"+((this.timeLeft%60)|0)).slice(-2)), W/2, y+boxH/2);
  g.font="900 15px ui-sans-serif"; g.fillStyle=TEAM_COLOR_A; g.fillText("A "+this.teamA.score, x+48, y+boxH/2);
  g.fillStyle=TEAM_COLOR_B; g.fillText("B "+this.teamB.score, x+boxW-48, y+boxH/2);

  // 소유 표시
  var o=this.ball.owner; g.font="bold 12px ui-sans-serif"; g.textAlign="left"; g.fillStyle="#a7ffe0";
  g.fillText("POS: "+(o?(o.team.name+"-"+o.role):"-"), 26, 22);

  // 배너(골/오프사이드 등)
  if(this._banner && this.t<this._banner.until){
    g.font="900 56px ui-sans-serif"; g.textAlign="center"; g.textBaseline="middle";
    g.fillStyle="#fff"; g.fillText(this._banner.text, W/2, H/2);
  }

  // 통합 게이지(PASS/SHOT)
  var i1=game.input1; var value=clamp(Math.max(i1.passCharge,i1.shotCharge),0,1);
  if(value>0.02){
    var gw=320, gh=14, gx=(W-gw)/2, gy=H-26;
    g.fillStyle="rgba(0,0,0,.45)"; g.strokeStyle="rgba(255,255,255,.12)"; g.lineWidth=1;
    rrect(g,gx,gy,gw,gh,8); g.fill(); g.stroke();
    g.fillStyle="rgba(35,165,89,.9)"; rrect(g,gx,gy,gw*value,gh,8); g.fill();
    g.font="bold 11px ui-sans-serif"; g.textAlign="center"; g.fillStyle="#e8ffe8";
    g.fillText("ACTION POWER "+((value*100)|0)+"%", gx+gw/2, gy-8);
  }
  g.restore();
};
Game.prototype.render=function(){
  g.clearRect(0,0,canvas.width,canvas.height);
  g.fillStyle="#0b5f2a"; g.fillRect(0,0,W,H); // 잔디
  this.pitch(g); this.goal3D(g);
  this.ball.draw(g);
  var i; for(i=0;i<this.teamA.players.length;i++) this.teamA.players[i].draw(g);
  for(i=0;i<this.teamB.players.length;i++) this.teamB.players[i].draw(g);
  this.drawUI(g);
};

/* ===== 실행 ===== */
window.game=new Game();
window.requestAnimationFrame(function(ts){ game.tick(ts); });

/* ===== 키보드 ===== */
window.addEventListener("keydown",function(e){
  var k=e.code; var t=game.t; var i1=game.input1;
  if(k===Keys.W)i1.up=true; if(k===Keys.S)i1.down=true; if(k===Keys.A)i1.left=true; if(k===Keys.D)i1.right=true;
  if(k===Keys.PASS1){ handlePassKey(i1,true,t); game.endRestartIfKicked(); }
  if(k===Keys.SHOOT1){ handleShootKey(i1,true,t); game.endRestartIfKicked(); }
  if(k===Keys.SWITCH1) i1.switch=true;
  if(k===Keys.CURVE1) i1.curveHeld=true;
  if(k===Keys.TACKLE1) i1.tackleTap=true;
  e.preventDefault();
},{passive:false});

window.addEventListener("keyup",function(e){
  var k=e.code; var t=game.t; var i1=game.input1;
  if(k===Keys.W)i1.up=false; if(k===Keys.S)i1.down=false; if(k===Keys.A)i1.left=false; if(k===Keys.D)i1.right=false;
  if(k===Keys.PASS1){ handlePassKey(i1,false,t); game.endRestartIfKicked(); }
  if(k===Keys.SHOOT1){ handleShootKey(i1,false,t); game.endRestartIfKicked(); }
  if(k===Keys.SWITCH1) i1.switch=false;
  if(k===Keys.CURVE1) i1.curveHeld=false;
  e.preventDefault();
},{passive:false});

})();
</script>
</body>
</html>
