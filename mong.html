<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>6v6 축구 게임 · 득점고정/파워슛 직진/군집반발</title>
<style>
:root{--bg:#0c0f15;--panel:#111624;--panel-2:#0f1520;--ink:#e6edf3;--muted:#9da6b2;--accent:#23a559;--accent-2:#2d7ff9;--accent-3:#f3533b;--shadow:0 10px 30px rgba(0,0,0,.35);--radius:16px}
html,body{margin:0;height:100%;background:var(--bg);color:var(--ink);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial}
#root{display:grid;grid-template-rows:auto 1fr;min-height:100dvh}
header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;background:linear-gradient(0deg,#0b0f18,#0f1422);border-bottom:1px solid #1f2631}
header h1{margin:0;font-size:18px;font-weight:900;letter-spacing:.4px}
header .hint{color:var(--muted);font-size:12px}
.wrap{position:relative;display:grid;place-items:center;padding:12px}
.stage{position:relative;width:min(1200px,95vw);aspect-ratio:55/34;background:#0b5f2a radial-gradient(1000px 600px at 50% 40%,rgba(255,255,255,.06),transparent);border:12px solid #1a202c;border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden}
canvas{width:100%;height:100%;display:block;background:transparent}
.hud{position:absolute;inset:10px 10px auto 10px;display:flex;gap:8px;align-items:center;padding:8px 10px;background:rgba(0,0,0,.35);backdrop-filter:blur(6px);border:1px solid rgba(255,255,255,.08);border-radius:12px;font-weight:800}
.badge{padding:4px 8px;border-radius:999px;font-size:12px}
.teamA{background:rgba(45,127,249,.25);border:1px solid rgba(45,127,249,.4)}
.teamB{background:rgba(243,83,59,.25);border:1px solid rgba(243,83,59,.4)}
.timer{color:#fff;opacity:.9;margin-left:6px;min-width:62px;text-align:center}
.pos{padding:2px 8px;border-radius:10px;border:1px dashed rgba(255,255,255,.15);font-size:11px;color:#d6ffe9}
.menu{position:absolute;inset:0;display:grid;place-items:center;background:rgba(0,0,0,.6);backdrop-filter:blur(6px)}
.card{width:min(920px,92%);background:var(--panel);border:1px solid #263142;border-radius:20px;box-shadow:var(--shadow);padding:18px;display:grid;gap:14px}
.titleRow{display:flex;align-items:center;justify-content:space-between}
.title{font-weight:900;letter-spacing:.6px}
.seg{display:flex;gap:8px}
.seg button{flex:1;padding:12px 14px;font-weight:900;border-radius:12px;border:1px solid #2a3546;background:#0f1520;color:var(--ink);cursor:pointer}
.seg button.active{outline:2px solid var(--accent)}
.kbwrap{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.kb{background:var(--panel-2);border:1px solid #2a3546;border-radius:14px;padding:12px}
.kb h3{margin:0 0 8px 0;color:#a7ffe0;font-size:14px}
.grid2{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;font-size:12px;color:#cde5ff}
.grid2 .t{color:#8db1ff}
.actions{display:flex;gap:10px;justify-content:flex-end}
.btn{padding:12px 16px;border-radius:12px;border:1px solid #2a3546;background:#111a29;color:var(--ink);cursor:pointer;font-weight:900}
.btn.primary{background:var(--accent);border-color:#1f7e4a;color:#07160f}
.toast{position:absolute;left:50%;bottom:16px;transform:translateX(-50%);background:rgba(0,0,0,.6);padding:8px 12px;border-radius:999px;border:1px solid rgba(255,255,255,.08);font-size:12px;color:#e2f7eb;display:none}
.goalBanner{position:absolute;inset:0;display:none;place-items:center;color:white;font-weight:900;font-size:clamp(32px,6vw,72px);text-shadow:0 6px 30px rgba(0,0,0,.6);pointer-events:none}
.gwrap{position:absolute;left:12px;right:12px;bottom:12px;display:flex;justify-content:space-between;pointer-events:none}
.gpanel{display:grid;gap:6px;min-width:200px;max-width:40%;background:rgba(0,0,0,.35);border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:8px;backdrop-filter:blur(6px)}
.gtitle{font-size:10px;color:var(--muted);text-align:left}
.hbar{position:relative;height:12px;background:#0f1520;border:1px solid #2a3546;border-radius:8px;overflow:hidden}
.fill{position:absolute;left:0;top:0;bottom:0;width:0%;background:linear-gradient(90deg, rgba(35,165,89,.9), rgba(35,165,89,.25));transition:width .06s}
.labels{display:flex;justify-content:space-between;font-size:10px;color:#a8ffd7}
</style>
</head>
<body>
<div id="root">
<header>
  <h1>⚽ 6v6 STREET FOOTBALL</h1>
  <div class="hint">1P: WASD · <b>슛 J</b>(길게=파워) · <b>패스 K</b>(길게=쓰루) · 파워 U(누른채 J=×2) · 태클 H · 변경 L | 2P: ←↑→↓/1·2·3·4·5</div>
</header>
<div class="wrap">
  <div class="stage" id="stage">
    <canvas id="game" width="1100" height="680" tabindex="0"></canvas>
    <div class="hud" id="hud">
      <span class="badge teamA" id="scoreA">A 0</span>
      <span class="badge teamB" id="scoreB">B 0</span>
      <span class="timer" id="timer">03:00</span>
      <span class="pos" id="who">POS: -</span>
    </div>
    <div class="goalBanner" id="goalBanner">GOAL!</div>
    <div class="menu" id="menu">
      <div class="card">
        <div class="titleRow">
          <div class="title">KICK-OFF</div>
          <div class="seg" role="tablist">
            <button id="mode1" class="active" aria-pressed="true">SOLO (1P vs AI)</button>
            <button id="mode2" aria-pressed="false">DUO (1P vs 2P)</button>
          </div>
        </div>
        <div class="kbwrap">
          <div class="kb">
            <h3>조작</h3>
            <div class="grid2">
              <div class="t">1P</div><div>이동 WASD · <b>슛 J</b>(길게=파워) · <b>패스 K</b>(길게=쓰루) · 파워 U(누른채 J=×2) · 태클 H · 변경 L</div>
              <div class="t">2P</div><div>이동 ←↑→↓ · 패스 1(길게=쓰루) · 파워 4(누른채 2=×2) · 슛 2 · 태클 5 · 변경 3</div>
            </div>
          </div>
          <div class="kb">
            <h3>포지션 특성</h3>
            <div class="grid2">
              <div class="t">CB</div><div>빠른 이동 · 강한 태클 · 약한 슛</div>
              <div class="t">CDM</div><div>느린 이동 · 강한 태클 · 좋은 슛</div>
              <div class="t">LW/RW</div><div>빠른 이동 · 좋은 슛 · 약한 태클</div>
              <div class="t">ST</div><div>빠른 이동 · 매우 좋은 슛 · 약한 태클</div>
            </div>
          </div>
        </div>
        <div class="actions">
          <button class="btn primary" id="startBtn">게임 시작</button>
        </div>
      </div>
    </div>
    <div class="gwrap">
      <div class="gpanel" id="g1">
        <div class="gtitle">1P</div>
        <div class="labels"><span>PASS</span><span id="g1_pass_pct">0%</span></div>
        <div class="hbar"><div class="fill" id="g1_pass"></div></div>
        <div class="labels"><span>SHOT</span><span id="g1_shot_pct">0%</span></div>
        <div class="hbar"><div class="fill" id="g1_shot"></div></div>
      </div>
      <div class="gpanel" id="g2">
        <div class="gtitle">2P</div>
        <div class="labels"><span>PASS</span><span id="g2_pass_pct">0%</span></div>
        <div class="hbar"><div class="fill" id="g2_pass"></div></div>
        <div class="labels"><span>SHOT</span><span id="g2_shot_pct">0%</span></div>
        <div class="hbar"><div class="fill" id="g2_shot"></div></div>
      </div>
    </div>
    <div class="toast" id="toast">캔버스를 클릭해 포커스를 주세요 (키보드 조작 활성화)</div>
  </div>
</div>
</div>
<script>
;(function(){
"use strict";
var game=null;
// ===== Util =====
var clamp=(v,lo,hi)=>Math.max(lo,Math.min(hi,v));
var lerp=(a,b,t)=>a+(b-a)*t;
var rand=(a=0,b=1)=>Math.random()*(b-a)+a;
var TAU=Math.PI*2;
function Vec2(x,y){this.x=x||0;this.y=y||0;}
Vec2.prototype.set=function(x,y){this.x=x;this.y=y;return this;};
Vec2.prototype.clone=function(){return new Vec2(this.x,this.y);};
Vec2.prototype.add=function(v){this.x+=v.x;this.y+=v.y;return this;};
Vec2.prototype.sub=function(v){this.x-=v.x;this.y-=v.y;return this;};
Vec2.prototype.mul=function(s){this.x*=s;this.y*=s;return this;};
Vec2.prototype.len=function(){return Math.hypot(this.x,this.y);};
Vec2.prototype.norm=function(){var l=this.len()||1;this.x/=l;this.y/=l;return this;};
Vec2.prototype.limit=function(m){var l=this.len();if(l>m){this.mul(m/l);}return this;};
Vec2.add=(a,b)=>new Vec2(a.x+b.x,a.y+b.y);
Vec2.sub=(a,b)=>new Vec2(a.x-b.x,a.y-b.y);
// ===== Field/const =====
var W=1100,H=680,GOAL_W=Math.round(120*1.56); // 골문 1.56배
var CENTER=new Vec2(W/2,H/2);
var FRICTION=0.982,PLAYER_RADIUS=12,BALL_RADIUS=6,GRAB_DIST=16;
var PASS_SPEED_FACTOR=0.25*1.15; // 🔧 패스 파워 +15%
var SHOT_BOOST=1.21;
// 직진 파워슛(커브 없음)
var SHOT_SPEED_MAX=6.1*SHOT_BOOST, SHOT_SPEED_MIN=3.2*SHOT_BOOST;
var SHOT_CHARGE_MAX=0.9;
var PLAYER_SPEED_SCALE=0.2; var SEPARATION_DIST=PLAYER_RADIUS*2.6;
var AI_SHOOT_DIST=260,AI_CROSS_BIAS=0.82;
var HALF_LEN=3*60;
var TEAM_COLOR_A="#2d7ff9",TEAM_COLOR_B="#f3533b",PLAYER_OUTLINE="#0b0f16",BALL_COLOR="#f3f3f3";
var STEAL_BASE=11;
var PASS_HOLD_THROUGH=0.35; var PASS_HOLD_MAX=0.8;
var FIELD={MINX:20, MAXX:W-20, MINY:20, MAXY:H-20, SAFE:28};
function clampPoint(p){p.x=clamp(p.x,FIELD.MINX+FIELD.SAFE,FIELD.MAXX-FIELD.SAFE);p.y=clamp(p.y,FIELD.MINY+FIELD.SAFE,FIELD.MAXY-FIELD.SAFE);return p;}
// Keeper box (확대 유지)
var BOX_W=100, BOX_H=H*0.5, BOX_Y=H/2-BOX_H/2, BOX_X_L=FIELD.MINX, BOX_X_R=W-(FIELD.MINX+BOX_W);
// Keys
var Keys={W:"KeyW",A:"KeyA",S:"KeyS",D:"KeyD",PASS1:"KeyK",SHOOT1:"KeyJ",SWITCH1:"KeyL",POWER1:"KeyU",TACKLE1:"KeyH",UP:"ArrowUp",DOWN:"ArrowDown",LEFT:"ArrowLeft",RIGHT:"ArrowRight",PASS2:"Digit1",SHOOT2:"Digit2",SWITCH2:"Digit3",POWER2:"Digit4",TACKLE2:"Digit5"};
function get(id){var el=document.getElementById(id); if(!el) throw new Error("Missing #"+id); return el;}
var canvas=get("game"), ctx=canvas.getContext("2d");
var hudScoreA=get("scoreA"), hudScoreB=get("scoreB"), hudTimer=get("timer"), hudWho=get("who"), toast=get("toast"), goalBanner=get("goalBanner");
var menu=get("menu"), mode1Btn=get("mode1"), mode2Btn=get("mode2"), startBtn=get("startBtn");
// Gauges
var g1_pass=get("g1_pass"), g2_pass=get("g2_pass"), g1_shot=get("g1_shot"), g2_shot=get("g2_shot");
var g1_pass_pct=get("g1_pass_pct"), g2_pass_pct=get("g2_pass_pct"), g1_shot_pct=get("g1_shot_pct"), g2_shot_pct=get("g2_shot_pct");
// Roles
var CDM_SPD=2.95, WING_SPD=CDM_SPD*1.30*1.20; // 🔧 윙 속도 +20%
var RoleProfile={GK:{spd:0.81,shot:0.5,tackle:0.95},CB:{spd:2.10,shot:0.6,tackle:1.28},CDM:{spd:CDM_SPD,shot:6.05,tackle:1.22},LW:{spd:WING_SPD,shot:4.12,tackle:0.8},RW:{spd:WING_SPD,shot:4.12,tackle:0.8},ST:{spd:3.16,shot:4.18,tackle:0.75}};
// Rules
var CM=10, HOLD_PUSH_CB=0.5*CM, HOLD_PUSH_OTH=0.8*CM, GK_SAFE_RADIUS=2*CM;
var CROWD_RAD=26, CROWD_TIME=0.8, CROWD_PUSH=0.3*CM; // 🔧 군집 0.8초 후 0.3cm(=3px) 반발
// ===== Engine =====
function Ball(){this.pos=CENTER.clone();this.vel=new Vec2();this.r=BALL_RADIUS;this.owner=null;this.pk=0;this.assistTo=null;this.assistT=0;this.lastTouchTeam=null;this.lastKickInfo=null;}
Ball.prototype.resetAt=function(left){this.pos.set(CENTER.x+(left?-40:40),CENTER.y);this.vel.set(0,0);this.owner=null;this.pk=0;this.assistTo=null;this.assistT=0;};
Ball.prototype.update=function(dt){
  this.pk=Math.max(0,(this.pk||0)-(dt||0));
  this.assistT=Math.max(0,(this.assistT||0)-(dt||0));

  if(this.owner){
    // 소유자 앞에 붙어서 이동
    var f=this.owner.facing.clone().norm().mul(10);
    this.pos.set(this.owner.pos.x+f.x,this.owner.pos.y+f.y);
    this.vel.mul(0); 
    this.assistTo=null; 
    this.assistT=0;

    // ✅ 소유 중에도 골라인 판정 수행 (드리블 골 허용)
    var inPost = (this.pos.y > H/2 - GOAL_W/2 && this.pos.y < H/2 + GOAL_W/2);
    if (inPost) {
      var LGL = FIELD.MINX + this.r;     // 왼쪽 골 라인
      var RGL = FIELD.MAXX - this.r;     // 오른쪽 골 라인
      if (this.pos.x <= LGL) { game.goal("B"); return; }
      if (this.pos.x >= RGL) { game.goal("A"); return; }
    }
    return;
  }

  // 패스 살짝 유도(보정 +15%)
  if(this.assistTo && this.assistT>0){
    var to=Vec2.sub(this.assistTo.pos,this.pos); var L=to.len(); if(L>1){ to.norm(); this.vel.add(to.mul(0.069)); } // 0.06 -> 0.069
  }
  this.pos.add(this.vel);
  this.vel.mul(FRICTION);
  this.boundary();
};
Ball.prototype.boundary=function(){
  // 득점 판정: 골문 사이(y) && x가 '필드 라인'을 공 반지름만큼 넘음
  var inPost=(this.pos.y>H/2-GOAL_W/2 && this.pos.y<H/2+GOAL_W/2);
  var LGL = FIELD.MINX + this.r;     
  var RGL = FIELD.MAXX - this.r;
  if(inPost && this.pos.x<=LGL){ game.goal("B"); return; }
  if(inPost && this.pos.x>=RGL){ game.goal("A"); return; }

  // 아웃 (골이 아니면 스로인/골킥/코너)
  var outSide=null;
  if(this.pos.y<FIELD.MINY+this.r) outSide="TOP";
  else if(this.pos.y>FIELD.MAXY-this.r) outSide="BOT";
  else if(this.pos.x<FIELD.MINX+this.r) outSide="LEFT";
  else if(this.pos.x>FIELD.MAXX-this.r) outSide="RIGHT";
  if(outSide){
    var endLine=(outSide==="LEFT"||outSide==="RIGHT");
    if(endLine){
      var defend=(this.lastTouchTeam===game.teamA)?game.teamB:game.teamA;
      var attack=defend.oppo;
      if(this.lastTouchTeam===defend){ game.queueCorner(outSide,attack); }
      else { game.queueGoalKick(defend,outSide); }
    } else {
      game.queueThrowIn(outSide);
    }
  }
};
Ball.prototype.kick=function(to,s){this.owner=null;this.pk=0.25;this.assistTo=null;this.assistT=0;var d=Vec2.sub(to,this.pos).norm();this.vel=d.mul(s);};
Ball.prototype.knock=function(dir,s){this.owner=null;this.pk=0.2;this.vel=dir.clone().norm().mul(s);};
Ball.prototype.draw=function(g){g.save();g.fillStyle=BALL_COLOR;g.beginPath();g.arc(this.pos.x,this.pos.y,this.r,0,TAU);g.fill();g.restore();};
// Player
function Player(team,role,x,y,color){this.team=team;this.role=role;this.home=new Vec2(x,y);this.pos=new Vec2(x,y);this.vel=new Vec2();this.r=PLAYER_RADIUS;this.color=color;this.controlled=0;this.facing=new Vec2(team.side==="L"?1:-1,0);this.tackleCd=0;this.prof=RoleProfile[role];this.frozen=false;this._holdT=0;this._crowdT=0;}
Player.prototype.hasBall=function(){return game&&game.ball.owner===this;};
Player.prototype.distBall=function(){return Vec2.sub(game.ball.pos,this.pos).len();};
Player.prototype.nearestMate=function(filter){var mates=this.team.players,best=null,bd=1e9;for(var i=0;i<mates.length;i++){var p=mates[i];if(p===this)continue;if(filter&&!filter(p))continue;var d=Vec2.sub(p.pos,this.pos).len();if(d<bd){bd=d;best=p;}}return best;};
// 패스 스냅(보정 +15%)
Player.prototype.findPassSnap=function(dir,type){
  var from=game.ball.pos.clone();
  var maxAngle=(50*1.15)*Math.PI/180; // 50° → 57.5°
  var maxDist=((type==="through")?340:280)*1.15; // 범위 +15%
  var best=null,bestProj=-1;
  for(var i=0;i<this.team.players.length;i++){
    var p=this.team.players[i]; if(p===this)continue;
    var v=Vec2.sub(p.pos,from); var d=v.len(); if(d<26||d>maxDist)continue;
    var vn=v.clone().norm(); var dot=vn.x*dir.x+vn.y*dir.y;
    if(dot<=Math.cos(maxAngle))continue;
    var proj=d*dot; if(proj>bestProj){bestProj=proj;best=p;}
  }
  return best;
};
function applyPassPowerForHuman(s){return s;}
Player.prototype.passTo=function(target,type,which){
  if(!target)return;
  var from=game.ball.pos.clone();
  var dirTo=Vec2.sub(target.pos,from);
  var dist=dirTo.len();
  var dir=dist?dirTo.norm():this.facing.clone().norm();
  var lead=(type==="through")?clamp(dist*0.22,20,44):clamp(dist*0.14,10,22);
  var leadDir=(target.facing&&(target.facing.x||target.facing.y))?target.facing.clone().norm():dir.clone();
  var aim=Vec2.add(target.pos,leadDir.mul(lead));clampPoint(aim);
  var baseDist=Vec2.sub(aim,from).len();
  var speed=clamp(baseDist/0.6,4.2,8.0)*PASS_SPEED_FACTOR; // 🔧 파워 계수 반영
  speed=applyPassPowerForHuman(speed);
  game.ball.kick(aim,speed);
  game.ball.assistTo=target; game.ball.assistT=(type==="through")?1.0:0.8;
  var isForward=this.team.side==="L"?(aim.x>from.x):(aim.x<from.x);
  game.onBallKicked(this.team,this,isForward);
};
Player.prototype.passRestartSmart=function(type,which){
  var safeMate=this.nearestMate(function(p){var mx=40,my=36;return(p.pos.x>FIELD.MINX+mx&&p.pos.x<FIELD.MAXX-mx&&p.pos.y>FIELD.MINY+my&&p.pos.y<FIELD.MAXY-my);})||this.nearestMate();
  this.passTo(safeMate,type,which);
};
Player.prototype.update=function(dt){
  if(this.frozen){this.vel.mul(0);return;}
  this.tackleCd=Math.max(0,this.tackleCd-dt);
  if(this.controlled===1)this.updateHuman(1,dt);
  else if(this.controlled===2)this.updateHuman(2,dt);
  else this.updateAI(dt);
  var baseMax=(2.5+1.5)*PLAYER_SPEED_SCALE*this.prof.spd,maxSpd=baseMax;if(this.hasBall())maxSpd*=0.9;
  this.vel.limit(maxSpd);this.pos.add(this.vel);
  game&&game._repelIfInsideGkNoGo(this);
  this.pos.x=clamp(this.pos.x,FIELD.MINX+this.r,FIELD.MAXX-this.r);
  this.pos.y=clamp(this.pos.y,FIELD.MINY+this.r,FIELD.MAXY-this.r);
  if(game&&!game.ball.owner&&(game.ball.pk||0)<=0&&this.distBall()<GRAB_DIST){if(!game.isInsideGkNoGo(this)&&!game.isInsideLockedKeeperBox(this)){game.ball.owner=this;this._holdT=game.t;game.ball.vel.mul(0);}}
  if(this.hasBall()){
    var held=game.t-(this._holdT||game.t);
    if(held>2){var dirBack=(this.team.side==="L"?-1:1);var pushPerSec=(this.role==="CB"?HOLD_PUSH_CB:HOLD_PUSH_OTH);this.pos.x+=dirBack*pushPerSec*dt;}
  }
};
Player.prototype.tryTackle=function(){if(this.tackleCd>0)return;if(game&&(game.isInsideGkNoGo(this)||game.isInsideLockedKeeperBox(this)))return;var range=STEAL_BASE+(this.prof.tackle-1)*6;this.tackleCd=0.48+(1-this.prof.tackle)*0.25;var d=this.distBall();if(d<this.r+range){var dir=Vec2.sub(game.ball.pos,this.pos);if(dir.len()>0)game.ball.knock(dir,7.0*this.prof.tackle);}};
Player.prototype._currentDir=function(which){var input=(which===1)?game.input1:game.input2;var dir=new Vec2((input.right?1:0)-(input.left?1:0),(input.down?1:0)-(input.up?1:0));if(dir.x||dir.y){this.facing=dir.clone().norm();return this.facing.clone();}return this.facing.clone();};
Player.prototype._goalTargetY=function(inputDir){var mid=H/2,pad=GOAL_W/2-8,top=mid-pad,bot=mid+pad;if(!inputDir||(!inputDir.x&&!inputDir.y))return mid;if(inputDir.y<-0.2)return lerp(mid,top,0.9);if(inputDir.y>0.2)return lerp(mid,bot,0.9);return mid;};
// 커브/호밍 없음. 파워는 속도만 ×2
Player.prototype.shootAimed=function(pow,inputDir,isPowerShot){
  pow=(pow===undefined)?0.6:pow;
  var left=(this.team.side==="L"), gx=left?(W-18):18, gy=this._goalTargetY(inputDir);
  var aim=new Vec2(gx,gy);
  var speed=SHOT_SPEED_MIN+(SHOT_SPEED_MAX-SHOT_SPEED_MIN)*pow;
  speed*=this.prof.shot;
  if(isPowerShot) speed*=2.0;
  speed=Math.min(speed,SHOT_SPEED_MAX*2.0);
  game.ball.kick(aim,speed);
};
Player.prototype.updateHuman=function(which,dt){
  var input=(which===1)?game.input1:game.input2;
  var move=this._currentDir(which);
  var accel=0.6*PLAYER_SPEED_SCALE*this.prof.spd;if(this.hasBall())accel*=1.2;
  var raw=new Vec2((input.right?1:0)-(input.left?1:0),(input.down?1:0)-(input.up?1:0));
  this.vel.mul(0.85).add(raw.mul(accel));
  if(input.tackleTap){this.tryTackle();input.tackleTap=false;}
  if(input.shootRelease){
    if(!(game.state==="restart"&&game.restart&&game.restart.kind==="GOAL-KICK"&&this.role==="GK")){
      if(this.hasBall()){
        var pow=clamp(input.shotCharge,0,1);
        var isPower=input.powerHeld===true;
        this.shootAimed(pow,move,isPower);
        game.onBallKicked(this.team,this,true);
      }
    }
    input.shootRelease=false;input.shotCharge=0;
  }
  if(input.passTrigger){
    if(this.hasBall()){
      var type=input.passIsThrough?"through":"normal";
      if(game.state==="restart"){this.passRestartSmart(type,which);}
      else{
        var dir=(move&&(move.x||move.y))?move.clone().norm():this.facing.clone().norm();
        var snap=this.findPassSnap(dir,type);
        if(snap)this.passTo(snap,type,which);
        else if(!(move.x||move.y))this.passTo(this.nearestMate(),type,which);
        else this.pass(type,move,which);
      }
    }
    input.passTrigger=false;
  }
  if(input.switch){game.manualSwitch(which);input.switch=false;}
};
Player.prototype.pass=function(type,aimDir,which){
  var from=game.ball.pos.clone();
  var input=(which===1)?game.input1:game.input2;
  var dir=(aimDir&&(aimDir.x||aimDir.y))?aimDir.clone().norm():this.facing.clone().norm();
  var ch=clamp(input.passCharge,0,1);
  // 🔧 게이지 차등 강화
  var baseDist = (type==="through")
    ? lerp(120,260,ch)   // 140~220 → 120~260
    : lerp(70,180,ch);   // 90~150  → 70~180
  var rangeBoost = (type==="through")
    ? 1 + 2.4*ch        // 1 + 1.5ch → 1 + 2.4ch
    : 1 + 2.0*ch;
  baseDist *= rangeBoost;

  var aim=Vec2.add(from,dir.clone().mul(baseDist));clampPoint(aim);
  var speed=clamp(baseDist/0.6,4.2,8.0)*PASS_SPEED_FACTOR; // 🔧 파워 +15%
  speed=applyPassPowerForHuman(speed);
  game.ball.kick(aim,speed);game.ball.assistTo=null;game.ball.assistT=0.0;
  var isForward=this.team.side==="L"?(aim.x>from.x):(aim.x<from.x);
  game.onBallKicked(this.team,this,isForward);
};
// ==== AI(엉킴 보정 포함) ====
function defenderUnstuck(team){var cdm=team.players.find(p=>p.role==="CDM"),cb=team.players.find(p=>p.role==="CB");if(!cdm||!cb)return;var d=Vec2.sub(cdm.pos,cb.pos);var L=d.len();var slow=(cdm.vel.len()<0.05&&cb.vel.len()<0.05);if(L<28&&slow){d=(L>0?d.norm():new Vec2(1,0));var perp=new Vec2(-d.y,d.x);cdm.pos.add(perp.clone().mul(6));cb.pos.add(perp.clone().mul(-6));cdm.vel.mul(0.5);cb.vel.mul(0.5);}}
function isCounter(team){return game&&(game.t<= (team._counterUntil||0));}
Player.prototype.isWideArea=function(){var wing=(this.pos.y<H*0.30||this.pos.y>H*0.70);var fwd=this.team.side==="L"?(this.pos.x>W*0.62):(this.pos.x<W*0.38);return wing&&fwd;};
Player.prototype.zoneHold=function(){var t=this.team.shapeTarget(this);this.seek(t,0.11*this.prof.spd);};
function threatYAgainst(team){var opp=team.oppo,owner=game.ball.owner;if(owner&&owner.team===opp)return owner.pos.y;var dir=team.side==="L"?-1:1;var best=null,sc=-1e9;for(var i=0;i<opp.players.length;i++){var p=opp.players[i];var toward=dir*(p.pos.x-(team.side==="L"?FIELD.MINX:FIELD.MAXX));var s=-toward+Math.abs(p.pos.y-H/2)*0.2;if(s>sc){sc=s;best=p;}}return best?best.pos.y:H/2;}
Player.prototype.supportRun=function(){
  var dir=this.team.side==="L"?1:-1, b=game.ball.pos, t=this.home.clone();
  var counter=isCounter(this.team), defending=(game.ball.owner&&game.ball.owner.team!==this.team);
  if(this.role==="ST"){if(counter){t.x=b.x+120*dir;t.y=lerp(t.y,b.y,0.25);}else if(defending){t.x=this.home.x-20*dir;t.y=lerp(t.y,b.y,0.15);}else{t.x=b.x+95*dir;t.y=lerp(t.y,b.y,0.28);}}
  else if(this.role==="LW"){if(defending){t.x=this.home.x-70*dir;t.y=this.team.side==="L"?H*0.20:H*0.80;}else if(counter){t.x=b.x+120*dir;t.y=this.team.side==="L"?H*0.20:H*0.80;}else{t.x=b.x+80*dir;t.y=this.team.side==="L"?H*0.22:H*0.78;}}
  else if(this.role==="RW"){if(defending){t.x=this.home.x-70*dir;t.y=this.team.side==="L"?H*0.80:H*0.20;}else if(counter){t.x=b.x+120*dir;t.y=this.team.side==="L"?H*0.80:H*0.20;}else{t.x=b.x+80*dir;t.y=this.team.side==="L"?H*0.78:H*0.22;}}
  else if(this.role==="CDM"){if(defending){t.x=b.x-30*dir;t.y=lerp(t.y,b.y,0.32);}else if(counter){t.x=b.x+30*dir;t.y=lerp(t.y,b.y,0.28);}else{t.x=b.x-20*dir;t.y=lerp(t.y,b.y,0.24);}}
  else if(this.role==="CB"){var baseX=this.team.side==="L"?190:W-190,thY=threatYAgainst(this.team);if(defending){t.x=lerp(this.pos.x,baseX-10*dir,0.6);t.y=lerp(this.pos.y,thY,0.25);}else if(counter){t.x=lerp(this.pos.x,baseX,0.5);t.y=lerp(this.pos.y,H*0.55,0.20);}else{t.x=lerp(this.pos.x,baseX,0.85);t.y=lerp(this.pos.y,H*0.55,0.18);}}
  this.stayOnside(t);this.seek(t,0.12*this.prof.spd);
};
Player.prototype.blockLane=function(owner){var mid=new Vec2((owner.pos.x+game.ball.pos.x)/2,(owner.pos.y+game.ball.pos.y)/2);this.seek(mid,0.12*this.prof.spd);};
Player.prototype.stayOnside=function(t){var line=this.team.computeOffsideLine();if(this.team.side==="L"&&t.x>line-8)t.x=line-8;if(this.team.side==="R"&&t.x<line+8)t.x=line+8;};
Player.prototype.updateAI=function(dt){
  if(game.state==="restart"){this.vel.mul(0);return;}
  if(this.role==="GK"){this.updateGK();return;}
  var ball=game.ball, haveBall=(ball.owner&&ball.owner===this);
  if(!ball.owner){
    var prs=this.team.pickPressers();
    if(prs.primary===this)this.seek(ball.pos,0.95*this.prof.spd);
    else if(prs.secondary===this){var lane=Vec2.add(ball.pos,new Vec2(this.team.side==="L"?-20:20,0));this.seek(lane,0.10*this.prof.spd);}
    else this.zoneHold();
    if(this.distBall()<GRAB_DIST&&(ball.pk||0)<=0){if(!game.isInsideGkNoGo(this)&&!game.isInsideLockedKeeperBox(this)){ball.owner=this;this._holdT=game.t;}return;}
    if(this.role==="CDM"||this.role==="CB")defenderUnstuck(this.team);
    return;
  }
  if(ball.owner.team===this.team){
    if(haveBall){
      if(this.role==="LW"||this.role==="RW"){var st=this.team.players.find(pp=>pp.role==="ST");var t=st||this.nearestMate();this.passTo(t,"through",(this.controlled===1)?1:2);return;}
      if(this.role==="CDM"||this.role==="CB"){this.passTo(this.nearestMate(),"normal",(this.controlled===1)?1:2);return;}
      var dGoal=Math.abs((this.team.side==="L"?W-40:40)-this.pos.x);
      if(dGoal<AI_SHOOT_DIST){this.shootAimed(rand(0.6,0.95),this.facing.clone(),Math.random()<0.35);return;}
      this.supportRun();
    }else this.supportRun();
  }else{
    if(this.role==="CB"){this.blockLane(ball.owner);if(this.distBall()<24)this.tryTackle();defenderUnstuck(this.team);return;}
    if(this.role==="CDM"){this.seek(ball.pos,1.0*this.prof.spd);if(this.distBall()<27)this.tryTackle();defenderUnstuck(this.team);return;}
    var prs2=this.team.pickPressers();
    if(prs2.primary===this)this.seek(ball.pos,0.97*this.prof.spd);
    else if(prs2.secondary===this)this.blockLane(ball.owner);
    else this.zoneHold();
    if(this.distBall()<22)this.tryTackle();
    if(this.role==="CB"||this.role==="CDM")defenderUnstuck(this.team);
  }
};
Player.prototype.updateGK=function(){
  var left=this.team.side==="L", gx=left?26:W-26, goalY=clamp(game.ball.pos.y,H/2-GOAL_W/2+10,H/2+GOAL_W/2-10);
  var target=new Vec2(gx+(left?10:-10),goalY);
  this.seek(target,0.16*this.prof.spd);
  var d=this.distBall();
  if(!game.ball.owner){
    var towardGoal= left?(game.ball.pos.x<80):(game.ball.pos.x>W-80);
    var speed=Math.hypot(game.ball.vel.x,game.ball.vel.y);
    if(towardGoal&&d<28&&speed>3.4){var away=left?new Vec2(1,rand(-0.4,0.4)):new Vec2(-1,rand(-0.4,0.4));game.ball.lastTouchTeam=this.team;game.ball.knock(away,rand(3.6,5.0));return;}
  }
  if(d<GRAB_DIST+4&&(game.ball.pk||0)<=0){game.ball.owner=this;this._holdT=(game.t||0);return;}
  if(this.hasBall()){
    if((game.t-(this._holdT||0))>0.30){
      var t=this.nearestMate(function(p){var mx=40,my=36;return(p.pos.x>FIELD.MINX+mx&&p.pos.x<FIELD.MAXX-mx&&p.pos.y>FIELD.MINY+my&&p.pos.y<FIELD.MAXY-my);})||this.nearestMate();
      this.passTo(t,"normal",(this.controlled===1)?1:2);
    }
  }
};
// Common helpers
Player.prototype.seek=function(t,k){if(k===void 0)k=0.1;var d=Vec2.sub(t,this.pos);if(d.len()>1)d.norm();this.vel.add(d.mul(k));if(d.x||d.y)this.facing=d;};
Player.prototype.draw=function(g){
  g.save();g.lineWidth=2;g.fillStyle=this.color;g.strokeStyle=PLAYER_OUTLINE;g.beginPath();g.arc(this.pos.x,this.pos.y,this.r,0,TAU);g.fill();g.stroke();
  g.globalAlpha=0.85;g.fillStyle="rgba(0,0,0,0.45)";g.fillRect(this.pos.x-12,this.pos.y+12,24,9);g.fillStyle="#dfe7ff";g.font="9px sans-serif";g.textAlign="center";g.fillText(this.role,this.pos.x,this.pos.y+20);g.globalAlpha=1;
  var nose=Vec2.add(this.pos,this.facing.clone().norm().mul(this.r));g.beginPath();g.moveTo(nose.x,nose.y);var f=this.facing.clone().norm(),right=new Vec2(-f.y,f.x),p1=Vec2.add(this.pos,right.clone().mul(this.r*0.7)),p2=Vec2.add(this.pos,right.clone().mul(-this.r*0.7));g.lineTo(p1.x,p1.y);g.lineTo(p2.x,p2.y);g.closePath();g.globalAlpha=0.15;g.fillStyle="#000";g.fill();g.globalAlpha=1;
  if(this.controlled>0){g.strokeStyle="#fff";g.lineWidth=2;g.setLineDash([4,4]);g.beginPath();g.arc(this.pos.x,this.pos.y,this.r+6,0,TAU);g.stroke();g.setLineDash([]);}
  if(this.hasBall()){g.fillStyle="#ffd84d";g.beginPath();g.arc(this.pos.x,this.pos.y-this.r-6,3.5,0,TAU);g.fill();}
  g.restore();
};
// Team
function Team(name,side,color){this.name=name;this.side=side;this.color=color;this.players=[];this.score=0;this.oppo=null;this._counterUntil=0;}
Team.prototype.formation=function(){var L=this.side==="L",sx=(x)=>L?x:(W-x);return [["GK",sx(60),H/2],["CB",sx(210),H*0.55],["CDM",sx(330),H*0.45],["LW",sx(420),L?H*0.28:H*0.72],["RW",sx(420),L?H*0.72:H*0.28],["ST",sx(560),H*0.50]];};
Team.prototype.spawn=function(){this.players=[];var f=this.formation();for(var i=0;i<f.length;i++){var r=f[i];this.players.push(new Player(this,r[0],r[1],r[2],this.color));}};
Team.prototype.shapeTarget=function(p){var t=p.home.clone(),has=(game.ball.owner&&game.ball.owner.team===this),dir=this.side==="L"?1:-1;if(has){if(p.role==="ST")t.x+=32*dir;if(p.role==="LW"||p.role==="RW")t.x+=26*dir;if(p.role==="CDM")t.x+=10*dir;}else{if(p.role==="CB")t.x-=20*dir;if(p.role==="CDM")t.x-=10*dir;}t.y=lerp(t.y,game.ball.pos.y,0.08);return t;};
Team.prototype.nearestForSwitch=function(){var best=null,sc=-1e9;for(var i=0;i<this.players.length;i++){var pl=this.players[i];var d=Vec2.sub(game.ball.pos,pl.pos).len(),tow=this.side==="L"?(game.ball.pos.x-pl.pos.x):(pl.pos.x-game.ball.pos.x),s=-d+tow*0.4+(pl.role==="ST"?8:0);if(s>sc){sc=s;best=pl;}}return best;};
Team.prototype.pickPressers=function(){var ball=game.ball;var arr=this.players.slice().sort(function(a,b){return Vec2.sub(ball.pos,a.pos).len()-Vec2.sub(ball.pos,b.pos).len()});return {primary:arr[0],secondary:arr[1]};};
Team.prototype.computeOffsideLine=function(){var xs=this.oppo.players.map(p=>p.pos.x).sort((a,b)=>a-b);return this.side==="L"?xs[xs.length-2]:xs[1];};
Team.prototype.isOffsidePos=function(p){var line=this.computeOffsideLine(),bx=game.ball.pos.x;if(this.side==="L"){return(p.pos.x>Math.max(line,bx)&&p.pos.x>W/2);}else{return(p.pos.x<Math.min(line,bx)&&p.pos.x<W/2);}};
// Input
function Input(){this.reset();}
Input.prototype.reset=function(){this.up=false;this.down=false;this.left=false;this.right=false;this.passHeld=false;this.passStart=0;this.passCharge=0;this.passTrigger=false;this.passIsThrough=false;this.switch=false;this.shootHeld=false;this.shootStart=0;this.shotCharge=0;this.shootRelease=false;this.powerHeld=false;this.tackleTap=false;};
// Game
function Game(){this.state="menu";this.mode="1P";this.t=0;this.timeLeft=HALF_LEN;this.ball=new Ball();this.teamA=new Team("A","L",TEAM_COLOR_A);this.teamB=new Team("B","R",TEAM_COLOR_B);this.teamA.oppo=this.teamB;this.teamB.oppo=this.teamA;this.input1=new Input();this.input2=new Input();this.humanTeam1=this.teamA;this.humanTeam2=null;this.lastTs=0;this.kickoffSide="L";this.dt=0;this.offside=null;this.restart=null;}
Game.prototype.start=function(){this.state="play";menu.style.display="none";this.teamA.spawn();this.teamB.spawn();this.teamA.players.forEach(p=>p.controlled=0);this.teamB.players.forEach(p=>p.controlled=0);this.humanTeam1=this.teamA;this.humanTeam2=this.mode==="2P"?this.teamB:null;this.resetAfterGoal(this.kickoffSide==="L");this.updateHUD();toast.style.display="block";canvas.focus();};
Game.prototype.goal=function(who){
  if(this.state!=="play")return;
  if(who==="A")this.teamA.score++; else this.teamB.score++;
  this.updateHUD();
  goalBanner.textContent="GOAL!"; goalBanner.style.display="grid";
  var self=this; setTimeout(function(){
    goalBanner.style.display="none";
    var leftKick=(who==="B");
    self.resetAfterGoal(leftKick);
    self.input1.reset(); self.input2.reset();
    canvas.focus(); toast.style.display="none";
  },900);
};
Game.prototype.resetAfterGoal=function(leftKick){
  this.ball.resetAt(leftKick);
  this.teamA.spawn(); this.teamB.spawn();
  var kicker=(leftKick?this.teamA:this.teamB).players.find(p=>p.role==="CDM");
  this.ball.owner=kicker; kicker._holdT=this.t;
  this.assignControllers();
  this.offside=null; this.restart=null;
  this.teamA.players.concat(this.teamB.players).forEach(p=>p.frozen=false);
  this.teamA._counterUntil=0; this.teamB._counterUntil=0;
  this.state="play";
  this.possessionChanged();
  this.updateHUD();
};
Game.prototype.assignControllers=function(){this.teamA.players.forEach(p=>p.controlled=0);this.teamB.players.forEach(p=>p.controlled=0);var p1=this.humanTeam1.nearestForSwitch();p1.controlled=1;if(this.mode==="2P"){var p2=this.teamB.nearestForSwitch();p2.controlled=2;}};
Game.prototype.manualSwitch=function(which){var team=which===1?this.humanTeam1:this.teamB;var n=team.nearestForSwitch();team.players.forEach(p=>{if(p.controlled===which)p.controlled=0;});n.controlled=which;};
Game.prototype._maybeSetCounter=function(owner){var left=owner.team.side==="L";var inOwnHalf=left?(owner.pos.x<W*0.5):(owner.pos.x>W*0.5);if(inOwnHalf){owner.team._counterUntil=this.t+4.0;}};
Game.prototype.possessionChanged=function(){var o=this.ball.owner;if(!o)return;hudWho.textContent="POS: "+o.team.name+"-"+o.role;if(o.team===this.humanTeam1){this.humanTeam1.players.forEach(p=>{if(p.controlled===1)p.controlled=0;});o.controlled=1;}else if(this.mode==="2P"&&o.team===this.teamB){this.teamB.players.forEach(p=>{if(p.controlled===2)p.controlled=0;});o.controlled=2;}o._holdT=this.t;this._maybeSetCounter(o);};
Game.prototype.updateHUD=function(){hudScoreA.textContent="A "+this.teamA.score;hudScoreB.textContent="B "+this.teamB.score;};
Game.prototype.tick=function(ts){var dt=Math.min(0.033,(ts-this.lastTs)/1000||0);this.lastTs=ts;this.dt=dt;if(this.state!=="menu"){this.update(dt);this.render();}requestAnimationFrame(this.tick.bind(this));};
Game.prototype.update=function(dt){
  this.t+=dt;
  this.timeLeft=Math.max(0,this.timeLeft-dt);hudTimer.textContent=this.formatTime(this.timeLeft);
  if(this.timeLeft<=0){this.timeLeft=HALF_LEN;}
  if(this.state==="restart"){this.freezeForRestart();this.updateRestartAllowedMovers();this.maybeAIRestart();this.enforceGkSafety();this.enforceKeeperBoxLock();return;}
  this.updateGauges(dt);
  this.teamA.players.forEach(p=>p.update(dt));this.teamB.players.forEach(p=>p.update(dt));
  this.enforceGkSafety();this.enforceKeeperBoxLock();
  this.separate(this.teamA.players.concat(this.teamB.players));
  this.applyCrowdRepel(dt); // 군집 반발(0.8초→0.3cm)
  var prev=this.ball.owner;this.ball.update(dt);if(prev!==this.ball.owner)this.possessionChanged();
  this.ballPlayerCollisions();
  if(this.offside&&this.t>this.offside.until){this.offside=null;}
};
Game.prototype.updateGauges=function(dt){
  var i1=this.input1,i2=this.input2;
  if(i1.passHeld)i1.passCharge=clamp((this.t-i1.passStart)/PASS_HOLD_MAX,0,1);else i1.passCharge*=0.9;
  if(i2.passHeld)i2.passCharge=clamp((this.t-i2.passStart)/PASS_HOLD_MAX,0,1);else i2.passCharge*=0.9;
  g1_pass.style.width=(i1.passCharge*100).toFixed(0)+"%";g2_pass.style.width=(i2.passCharge*100).toFixed(0)+"%";
  g1_pass_pct.textContent=((i1.passCharge*100)|0)+"%";g2_pass_pct.textContent=((i2.passCharge*100)|0)+"%";
  if(i1.shootHeld)i1.shotCharge=clamp((this.t-i1.shootStart)/SHOT_CHARGE_MAX,0,1);else i1.shotCharge*=0.9;
  if(i2.shootHeld)i2.shotCharge=clamp((this.t-i2.shootStart)/SHOT_CHARGE_MAX,0,1);else i2.shotCharge*=0.9;
  g1_shot.style.width=(i1.shotCharge*100).toFixed(0)+"%";g2_shot.style.width=(i2.shotCharge*100).toFixed(0)+"%";
  g1_shot_pct.textContent=((i1.shotCharge*100)|0)+"%";g2_shot_pct.textContent=((i2.shotCharge*100)|0)+"%";
};
Game.prototype.onBallKicked=function(attTeam,passer,isForward){
  this.ball.lastKickInfo={team:attTeam,pos:passer.pos.clone()};
  if(!isForward){this.offside=null;return;}
  var offenders=new Set();
  for(var i=0;i<attTeam.players.length;i++){var p=attTeam.players[i];if(p===passer)continue;if(attTeam.isOffsidePos(p))offenders.add(p);}
  this.offside={active:true,team:attTeam,offenders:offenders,until:this.t+2.6};
  this.ball.lastTouchTeam=attTeam;
};
Game.prototype.isInsideGkNoGo=function(p){
  var gkA=this.teamA.players.find(x=>x.role==="GK"),gkB=this.teamB.players.find(x=>x.role==="GK");
  function near(gk,pl){if(!gk)return false;if(pl.team===gk.team)return false;var d=Vec2.sub(pl.pos,gk.pos).len();return d<GK_SAFE_RADIUS;}
  return near(gkA,p)||near(gkB,p);
};
Game.prototype._repelIfInsideGkNoGo=function(p){
  var gkA=this.teamA.players.find(x=>x.role==="GK"),gkB=this.teamB.players.find(x=>x.role==="GK");
  function repel(gk,pl){if(!gk)return;if(pl.team===gk.team)return;var d=Vec2.sub(pl.pos,gk.pos),L=d.len();if(L>0&&L<GK_SAFE_RADIUS){d.norm();pl.pos=Vec2.add(gk.pos,d.mul(GK_SAFE_RADIUS));pl.vel.mul(0.6);} }
  repel(gkA,p);repel(gkB,p);
};
Game.prototype.isInsideLockedKeeperBox=function(p){
  var owner=this.ball.owner;if(!owner||owner.role!=="GK")return false;var left=owner.team.side==="L";
  if(left){if(p.team===owner.team)return false;return(p.pos.x>=BOX_X_L&&p.pos.x<=BOX_X_L+BOX_W&&p.pos.y>=BOX_Y&&p.pos.y<=BOX_Y+BOX_H);}
  else{if(p.team===owner.team)return false;return(p.pos.x>=BOX_X_R&&p.pos.x<=BOX_X_R+BOX_W&&p.pos.y>=BOX_Y&&p.pos.y<=BOX_Y+BOX_H);}
};
Game.prototype.enforceKeeperBoxLock=function(){
  var owner=this.ball.owner;if(!owner||owner.role!=="GK")return;
  var left=owner.team.side==="L",opp=owner.team.oppo;
  for(var i=0;i<opp.players.length;i++){var p=opp.players[i];if(this.isInsideLockedKeeperBox(p)){if(left){p.pos.x=BOX_X_L+BOX_W+2;}else{p.pos.x=BOX_X_R-2;}p.vel.mul(0);}}
};
Game.prototype.ballPlayerCollisions=function(){
  var all=this.teamA.players.concat(this.teamB.players),assistTo=this.ball.assistTo,assistT=this.ball.assistT;
  if(!this.ball.owner&&assistTo&&assistT>0){
    var d0=Vec2.sub(this.ball.pos,assistTo.pos).len();
    if(d0<GRAB_DIST+3){
      if(!this.isInsideGkNoGo(assistTo)&&!this.isInsideLockedKeeperBox(assistTo)){
        this.ball.owner=assistTo;assistTo._holdT=this.t;this.ball.vel.mul(0);this.ball.assistTo=null;this.ball.assistT=0;this.ball.lastTouchTeam=assistTo.team;
        if(this.checkOffsideOnTouch(assistTo))return;
      }else{this._repelIfInsideGkNoGo(assistTo);}return;
    }
  }
  for(var i=0;i<all.length;i++){
    var p=all[i],d=Vec2.sub(this.ball.pos,p.pos),L=d.len(),min=p.r+this.ball.r;
    if(L>0&&L<min){
      if(!this.ball.owner&&(this.ball.pk||0)<=0){
        if(!this.isInsideGkNoGo(p)&&!this.isInsideLockedKeeperBox(p)){
          this.ball.owner=p;p._holdT=this.t;this.ball.vel.mul(0);
          var f=p.facing.clone().norm().mul(10);this.ball.pos.set(p.pos.x+f.x,p.pos.y+f.y);
          this.ball.assistTo=null;this.ball.assistT=0;this.ball.lastTouchTeam=p.team;
          if(this.checkOffsideOnTouch(p))return;
        }else{this._repelIfInsideGkNoGo(p);}
      }
    }
  }
};
Game.prototype.checkOffsideOnTouch=function(player){
  if(this.offside&&this.offside.active){
    if(player.team===this.offside.team){
      if(this.offside.offenders&&this.offside.offenders.has(player)){this.startOffsideRestart();return true;}
      else{this.offside=null;}
    }else{this.offside=null;}
  }
  return false;
};
Game.prototype.queueThrowIn=function(side){
  if(this.state!=="play")return;
  var defend=(this.ball.lastTouchTeam===this.teamA)?this.teamB:this.teamA;
  var pos={x:(side==="LEFT"?FIELD.MINX+8:side==="RIGHT"?FIELD.MAXX-8:clamp(this.ball.pos.x,40,W-40)),y:(side==="TOP"?FIELD.MINY+8:side==="BOT"?FIELD.MAXY-8:clamp(this.ball.pos.y,40,H-40))};
  var taker=defend.players.find(p=>p.role===(side==="LEFT"?(defend.side==="L"?"LW":"RW"):side==="RIGHT"?(defend.side==="L"?"RW":"LW"):"CDM"))||defend.players[0];
  this.startRestart("THROW-IN",defend,taker,pos);
};
Game.prototype.queueCorner=function(outSide,attackTeam){
  if(this.state!=="play")return;
  var x=(outSide==="LEFT")?FIELD.MINX+4:FIELD.MAXX-4,y=(this.ball.pos.y<H/2)?FIELD.MINY+4:FIELD.MAXY-4;
  var taker=attackTeam.players.find(p=>p.role===((y<H/2)?(attackTeam.side==="L"?"LW":"RW"):(attackTeam.side==="L"?"RW":"LW")))||attackTeam.players[0];
  this.startRestart("CORNER",attackTeam,taker,{x:x,y:y});
};
Game.prototype.queueGoalKick=function(defendTeam,outSide){
  if(this.state!=="play")return;
  var taker=defendTeam.players.find(p=>p.role==="GK")||defendTeam.players[0];
  var x=(defendTeam.side==="L")?60:W-60,y=H/2;
  this.startRestart("GOAL-KICK",defendTeam,taker,{x:x,y:y});
};
Game.prototype.startOffsideRestart=function(){
  var defend=(this.offside&&this.offside.team===this.teamA)?this.teamB:this.teamA;
  var pos=this.ball.lastKickInfo?this.ball.lastKickInfo.pos.clone():CENTER.clone();
  var taker=defend.players.find(p=>p.role==="CDM")||defend.players[0];
  this.startRestart("OFFSIDE",defend,taker,pos);
  this._forceOppHalfOnGoalKick(defend);
  this.offside=null;
};
Game.prototype.isTeamHuman=function(team){return(team===this.humanTeam1)||(this.mode==="2P"&&team===this.teamB);};
Game.prototype._forceOppHalfOnGoalKick=function(kickTeam){
  var opp=kickTeam.oppo;
  for(var i=0;i<opp.players.length;i++){
    var p=opp.players[i];
    if(opp.side==="L"){if(p.pos.x>W*0.5-12)p.pos.x=W*0.5-12;}
    else{if(p.pos.x<W*0.5+12)p.pos.x=W*0.5+12;}
  }
};
Game.prototype.startRestart=function(kind,team,taker,pos){
  this.state="restart";
  this.restart={kind:kind,team:team,taker:taker,pos:new Vec2(pos.x,pos.y)};
  taker.pos.set(pos.x,pos.y);this.ball.owner=taker;taker._holdT=this.t;this.ball.pos.set(pos.x,pos.y);
  if(kind==="GOAL-KICK"||kind==="OFFSIDE")this._forceOppHalfOnGoalKick(team);
  var allyMover=team.players.filter(p=>p!==taker).sort((a,b)=>Vec2.sub(a.pos,taker.pos).len()-Vec2.sub(b.pos,taker.pos).len())[0];
  var oppMover=team.oppo.players.slice().sort((a,b)=>Vec2.sub(b.pos,taker.pos).len()-Vec2.sub(a.pos,taker.pos).len()).slice(-1)[0];
  team.players.concat(team.oppo.players).forEach(p=>{p.frozen=true;p.vel.mul(0);this._repelIfInsideGkNoGo(p);});
  if(allyMover)allyMover.frozen=false;
  if(oppMover){oppMover.frozen=false;if(kind==="GOAL-KICK"||kind==="OFFSIDE"){if(oppMover.team.side==="L"&&oppMover.pos.x>W*0.5-12)oppMover.pos.x=W*0.5-12;if(oppMover.team.side==="R"&&oppMover.pos.x<W*0.5+12)oppMover.pos.x=W*0.5+12;}}
  this.restart.allyMover=allyMover;this.restart.oppMover=oppMover;
  this.assignControllers();
  if(team===this.teamA){this.teamA.players.forEach(p=>p.controlled=(p===taker)?1:0);}else{if(this.mode==="2P"){this.teamB.players.forEach(p=>p.controlled=(p===taker)?2:0);}}
  this.restart.isHuman=this.isTeamHuman(team);
  if(!this.restart.isHuman){this.restart.aiKickTime=this.t+rand(0.5,1.1);this.restart._aiActed=false;}
};
Game.prototype.freezeForRestart=function(){if(!this.restart||!this.restart.taker)return;var r=this.restart;var all=this.teamA.players.concat(this.teamB.players);all.forEach(p=>{var allow=(p===r.allyMover||p===r.oppMover);p.frozen=!allow;if(!allow){p.vel.mul(0);}this._repelIfInsideGkNoGo(p);});r.taker.frozen=true;r.taker.vel.mul(0);this.ball.owner=r.taker;this.ball.pos.set(r.pos.x,r.pos.y);};
Game.prototype.updateRestartAllowedMovers=function(){
  var r=this.restart;if(!r||!r.taker)return;
  [r.allyMover,r.oppMover].forEach(m=>{
    if(!m)return;
    if(m.team===r.team){
      var t=m.home.clone();
      if(r.kind==="THROW-IN"){var inwardX=m.team.side==="L"?r.pos.x+40:r.pos.x-40;t.x=inwardX;t.y=clamp(r.pos.y,FIELD.MINY+40,FIELD.MAXY-40);}
      else{t.x+=(m.team.side==="L"?30:-30);}
      m.seek(t,0.12*m.prof.spd);
    }else{
      if(r.kind==="GOAL-KICK"||r.kind==="OFFSIDE"){if(m.team.side==="L"&&m.pos.x>W*0.5-12)m.pos.x=W*0.5-12;if(m.team.side==="R"&&m.pos.x<W*0.5+12)m.pos.x=W*0.5+12;}
      m.blockLane(r.taker);
    }
    this._repelIfInsideGkNoGo(m);
  });
};
Game.prototype.maybeAIRestart=function(){var r=this.restart;if(!r||r.isHuman||r._aiActed)return;if(this.t>=r.aiKickTime){var k=r.taker;if(r.kind==="CORNER"){var st=k.team.players.find(pp=>pp.role==="ST");k.passTo(st||k.nearestMate(),"through",(k.controlled===1)?1:2);}else{k.passRestartSmart("normal",(k.controlled===1)?1:2);}r._aiActed=true;this.state="play";this.restart=null;k.team.players.concat(k.team.oppo.players).forEach(p=>p.frozen=false);}};
Game.prototype.endRestartIfKicked=function(){
  if(this.state!=="restart"||!this.restart||!this.restart.taker)return;
  var k=this.restart.taker;var i=(k.team===this.teamA)?this.input1:this.input2;if(!i)return;var acted=false;
  if(i.shootRelease){
    if(!(this.restart.kind==="GOAL-KICK"&&k.role==="GK")){
      var pow=clamp(i.shotCharge,0,1);var isPower=i.powerHeld===true;k.shootAimed(pow,k.facing.clone(),isPower);acted=true;
    }
    i.shootRelease=false;i.shotCharge=0;
  }
  if(i.passTrigger){var type=i.passIsThrough?"through":"normal";k.passRestartSmart(type,(k.controlled===1)?1:2);i.passTrigger=false;acted=true;}
  if(acted){this.state="play";this.restart=null;k.team.players.concat(k.team.oppo.players).forEach(p=>p.frozen=false);}
};
// 기본 충돌 분리
Game.prototype.separate=function(arr){for(var i=0;i<arr.length;i++)for(var j=i+1;j<arr.length;j++){var a=arr[i],b=arr[j];var d=Vec2.sub(b.pos,a.pos);var L=d.len();var min=SEPARATION_DIST;if(L>0&&L<min){d.norm();var push=(min-L)/2;a.pos.add(new Vec2(-d.x*push,-d.y*push));b.pos.add(new Vec2(d.x*push,d.y*push));a.vel.mul(0.8);b.vel.mul(0.8);}}};
// 0.8초 이상 군집 시 즉시 반발
Game.prototype.applyCrowdRepel=function(dt){
  var all=this.teamA.players.concat(this.teamB.players);
  for(var i=0;i<all.length;i++){
    var a=all[i]; var crowded=false; var nDir=new Vec2();
    for(var j=0;j<all.length;j++){
      if(i===j)continue; var b=all[j];
      var d=Vec2.sub(a.pos,b.pos); var L=d.len();
      if(L>0 && L<CROWD_RAD){crowded=true; nDir.add(d.clone().mul(1/(L+0.001)));} // 외향 방향 누적
    }
    if(crowded){a._crowdT=(a._crowdT||0)+dt;} else {a._crowdT=0;}
    if(a._crowdT>=CROWD_TIME){
      if(nDir.len()>0){nDir.norm(); a.pos.add(nDir.mul(CROWD_PUSH)); a.vel.mul(0.3);}
      a._crowdT=0; // 한 번 밀고 초기화
    }
  }
};
Game.prototype.enforceGkSafety=function(){
  var gkA=this.teamA.players.find(p=>p.role==="GK"),gkB=this.teamB.players.find(p=>p.role==="GK");
  function repel(gk,oppList){if(!gk)return;for(var i=0;i<oppList.length;i++){var p=oppList[i];if(p.team===gk.team)continue;var d=Vec2.sub(p.pos,gk.pos),L=d.len();if(L>0&&L<GK_SAFE_RADIUS){d.norm();p.pos=Vec2.add(gk.pos,d.mul(GK_SAFE_RADIUS));p.vel.mul(0);}}}
  repel(gkA,this.teamB.players);repel(gkB,this.teamA.players);
};
Game.prototype.render=function(){
  var g=ctx;g.clearRect(0,0,canvas.width,canvas.height);this.pitch(g);this.goal3D(g);this.ball.draw(g);
  this.teamA.players.forEach(p=>p.draw(g));this.teamB.players.forEach(p=>p.draw(g));
  if(this.state==="restart"&&this.restart&&this.restart.taker){var k=this.restart.taker;g.save();g.strokeStyle="#ffe38a";g.setLineDash([6,4]);g.lineWidth=2;g.beginPath();g.arc(k.pos.x,k.pos.y,k.r+10,0,TAU);g.stroke();g.setLineDash([]);g.restore();}
};
Game.prototype.pitch=function(g){
  g.save();g.strokeStyle="#e7f5e9";g.globalAlpha=0.6;g.lineWidth=2;
  g.strokeRect(FIELD.MINX,FIELD.MINY,FIELD.MAXX-FIELD.MINX,FIELD.MAXY-FIELD.MINY);
  g.beginPath();g.moveTo(W/2,FIELD.MINY);g.lineTo(W/2,FIELD.MAXY);g.stroke();
  g.beginPath();g.arc(W/2,H/2,70,0,TAU);g.stroke();
  g.strokeRect(BOX_X_L,BOX_Y,BOX_W,BOX_H);
  g.strokeRect(BOX_X_R,BOX_Y,BOX_W,BOX_H);
  g.restore();
};
Game.prototype.goal3D=function(g){
  var y1=H/2-GOAL_W/2,y2=H/2+GOAL_W/2,lw=6;
  g.save();
  g.fillStyle="rgba(255,255,255,0.9)";g.fillRect(14,y1,lw,GOAL_W);g.fillRect(14,y1-6,50,6);
  g.globalAlpha=0.25;g.fillStyle="#fff";g.fillRect(14+lw,y1,12,GOAL_W);
  g.globalAlpha=0.15;g.fillRect(14,y1,50,2);g.fillRect(14,y2-2,50,2);
  g.globalAlpha=1;g.fillStyle="rgba(255,255,255,0.9)";
  g.fillRect(W-20-lw,y1,lw,GOAL_W);g.fillRect(W-20-50,y1-6,50,6);
  g.globalAlpha=0.25;g.fillStyle="#fff";g.fillRect(W-20-lw-12,y1,12,GOAL_W);
  g.globalAlpha=0.15;g.fillRect(W-20-50,y1,50,2);g.fillRect(W-20-50,y2-2,50,2);
  g.restore();
};
Game.prototype.formatTime=function(t){var m=Math.floor(t/60),s=Math.floor(t%60);var mm=("0"+m).slice(-2),ss=("0"+s).slice(-2);return mm+":"+ss;};
function resize(){var dpr=Math.min(2,window.devicePixelRatio||1);canvas.width=Math.floor(W*dpr);canvas.height=Math.floor(H*dpr);ctx.setTransform(dpr,0,0,dpr,0,0);}
function init(){if(game)return;game=new Game();resize();requestAnimationFrame(function(ts){game.tick(ts);});}
// Keys
function isCode(k,list){return list.indexOf(k)!==-1;}
function handlePassKey(input,down){if(down){if(!input.passHeld){input.passHeld=true;input.passStart=game?game.t:0;}}else{if(input.passHeld){var dur=(game?game.t:0)-input.passStart;input.passIsThrough=dur>=PASS_HOLD_THROUGH;input.passTrigger=true;}input.passHeld=false;}}
function handleShootKey(input,down){if(down){if(!input.shootHeld){input.shootHeld=true;input.shootStart=game?game.t:0;}}else{if(input.shootHeld){input.shootHeld=false;input.shootRelease=true;}}}
function setKey(e,down){
  var k=e.code;var i1=(game&&game.input1),i2=(game&&game.input2);if(!i1||!i2)return;
  if(k===Keys.W)i1.up=down;if(k===Keys.S)i1.down=down;if(k===Keys.A)i1.left=down;if(k===Keys.D)i1.right=down;
  if(k===Keys.PASS1){handlePassKey(i1,down);if(game)game.endRestartIfKicked();}
  if(k===Keys.SHOOT1){handleShootKey(i1,down);if(game)game.endRestartIfKicked();}
  if(k===Keys.SWITCH1&&down)i1.switch=true;
  if(k===Keys.POWER1)i1.powerHeld=down;
  if(k===Keys.TACKLE1&&down)i1.tackleTap=true;
  if(k===Keys.UP)i2.up=down;if(k===Keys.DOWN)i2.down=down;if(k===Keys.LEFT)i2.left=down;if(k===Keys.RIGHT)i2.right=down;
  if(isCode(k,[Keys.PASS2,'Numpad1'])){handlePassKey(i2,down);if(game)game.endRestartIfKicked();}
  if(isCode(k,[Keys.SHOOT2,'Numpad2'])){handleShootKey(i2,down);if(game)game.endRestartIfKicked();}
  if(isCode(k,[Keys.SWITCH2,'Numpad3'])&&down)i2.switch=true;
  if(isCode(k,[Keys.POWER2,'Numpad4']))i2.powerHeld=down;
  if(isCode(k,[Keys.TACKLE2,'Numpad5'])&&down)i2.tackleTap=true;
  e.preventDefault();
}
canvas.addEventListener("pointerdown",function(){canvas.focus();toast.style.display="none";});
window.addEventListener("resize",resize);
window.addEventListener("keydown",function(e){setKey(e,true);},{passive:false});
window.addEventListener("keyup",function(e){setKey(e,false);},{passive:false});
mode1Btn.addEventListener("click",function(){if(!game)return;mode1Btn.classList.add("active");mode2Btn.classList.remove("active");game.mode="1P";});
mode2Btn.addEventListener("click",function(){if(!game)return;mode2Btn.classList.add("active");mode1Btn.classList.remove("active");game.mode="2P";});
startBtn.addEventListener("click",function(){if(!game)init();game.start();});
if(document.readyState==="loading"){document.addEventListener("DOMContentLoaded",init,{once:true});}else{init();}
})();
</script>
</body>
</html>
