<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
<title>벡터 레이싱 — three.js 3rd-Person ChaseCam</title>
<style>
  :root{ --bg:#070a16; --bg2:#0b1230; --ink:#eaf2ff; --muted:#9aa9c6; --glass:rgba(10,14,34,.82) }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:radial-gradient(1000px 520px at 80% -10%,#182555 0%,transparent 52%),linear-gradient(180deg,var(--bg),var(--bg2));color:var(--ink);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;user-select:none;-webkit-user-select:none;overscroll-behavior:none}
  .wrap{max-width:1200px;margin:0 auto;padding:12px}
  .card{position:relative;border:1px solid rgba(255,255,255,.1);border-radius:18px;background:rgba(255,255,255,.04);box-shadow:0 12px 48px rgba(0,0,0,.45);overflow:hidden}
  .hud{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.08)}
  .title{display:flex;gap:10px;align-items:center;font-weight:800}
  .stats{display:flex;gap:16px;align-items:center}
  .stat{font-variant-numeric:tabular-nums}
  .stat .label{font-size:12px;color:var(--muted)}
  .controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .btn,.select{appearance:none;border:1px solid rgba(255,255,255,.14);background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02));color:var(--ink);padding:7px 10px;border-radius:10px;font-weight:800;cursor:pointer}
  .view{position:relative;width:100%;height:min(56.25vw,700px);background:#050812;touch-action:none}
  canvas{display:block;width:100%;height:100%}
  .overlay{position:absolute;inset:0;display:grid;place-items:center;pointer-events:none}
  .panel{pointer-events:auto;background:var(--glass);border:1px solid rgba(255,255,255,.16);border-radius:18px;padding:18px;max-width:760px;width:min(92%,760px);text-align:center;box-shadow:0 16px 70px rgba(0,0,0,.55)}
  .panel h1{margin:0 0 10px}
  .keys{margin-top:8px;font-size:12px;color:var(--muted)}
  .padL,.padR{position:absolute;bottom:12px;gap:12px;pointer-events:auto;display:none}
  .padL{left:12px}
  .padR{right:12px;flex-direction:column;align-items:flex-end}
  .pbtn{min-width:92px;min-height:92px;border-radius:20px;border:1px solid rgba(255,255,255,.18);background:rgba(255,255,255,.10);color:#fff;font-weight:900;font-size:18px}
  .pbtn.small{min-width:88px;min-height:66px}
  .row{display:flex;gap:12px}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div class="hud">
      <div class="title">🏁 벡터 레이싱 (three.js 3rd-Person)</div>
      <div class="stats">
        <div class="stat" id="uiSpeed"><span class="label">SPEED</span> <b class="val">0</b></div>
        <div class="stat" id="uiLap"><span class="label">LAP</span> <b class="val">0/3</b></div>
        <div class="stat" id="uiPos"><span class="label">POS</span> <b class="val">Solo</b></div>
        <div class="stat" id="uiBest"><span class="label">BEST</span> <b class="val">—</b></div>
      </div>
      <div class="controls">
        <button class="btn" id="btnPlay">▶ 시작</button>
        <button class="btn" id="btnPause">⏸ 일시정지</button>
        <button class="btn" id="btnReset">↻ 리셋</button>
        <button class="btn" id="btnReroll">🎲 새 트랙</button>
        <button class="btn" id="btnShape">🛣 RANDOM</button>
        <button class="btn" id="btnAI">🤖 AI: 0</button>
        <button class="btn" id="btn2P">👥 1P</button>
        <button class="btn" id="btnMobile">📱 Mobile: OFF</button>
        <label style="font-size:12px;color:#9aa9c6">테마</label>
        <select class="select" id="selTheme">
          <option value="SPACE">SPACE</option>
          <option value="CYBERPUNK">CYBERPUNK</option>
          <option value="XMAS">XMAS</option>
          <option value="NEON">NEON</option>
          <option value="VOLCANO">VOLCANO</option>
        </select>
      </div>
    </div>

    <div class="view" id="view">
      <canvas id="gl"></canvas>
      <div class="overlay" id="overlay"></div>
      <!-- 모바일 패드 -->
      <div class="padL" id="padL">
        <button class="pbtn" data-act="L">◀</button>
        <button class="pbtn" data-act="R">▶</button>
      </div>
      <div class="padR" id="padR">
        <button class="pbtn" data-act="DR">DRIFT</button>
        <div class="row">
          <button class="pbtn small" data-act="ACC">가속</button>
          <button class="pbtn small" data-act="BR">브레이크</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- three.js robust loader with fallbacks -->
<script>
(function loadThree(){
  const cdns = [
    "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js",
    "https://unpkg.com/three@0.160.0/build/three.min.js",
    "https://cdnjs.cloudflare.com/ajax/libs/three.js/0.160.0/three.min.js"
  ];
  let i = 0;
  function tryNext(){
    if (window.THREE) return;
    if (i >= cdns.length) {
      const overlay = document.getElementById('overlay');
      overlay.innerHTML = `<div class="panel"><h1>⚠ three.js 로드 실패</h1><p>네트워크에서 three.js를 받지 못했습니다.</p></div>`;
      return;
    }
    const s = document.createElement('script');
    s.src = cdns[i++];
    s.defer = true;
    s.onerror = tryNext;
    document.head.appendChild(s);
    setTimeout(()=>{ if(!window.THREE) tryNext(); }, 2000);
  }
  tryNext();
})();
</script>

<script>
(()=>{'use strict';
/* ---------- 안전 ---------- */
const overlay=document.getElementById('overlay');
const panel=(html)=>overlay.innerHTML=`<div class="panel">${html}</div>`;
const clearPanel=()=>overlay.innerHTML='';
addEventListener('error',e=>panel(`<h1>⚠ 오류</h1><pre style="text-align:left;white-space:pre-wrap">${e.message||e}</pre>`));
addEventListener('unhandledrejection',e=>panel(`<h1>⚠ 오류</h1><pre style="text-align:left;white-space:pre-wrap">${(e.reason&&e.reason.message)||e.reason||e}</pre>`));

/* ---------- 유틸 ---------- */
const DPR=Math.max(1,Math.min(2,devicePixelRatio||1));
const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
const lerp=(a,b,t)=>a+(b-a)*t;
const mixV=(a,b,t)=>[lerp(a[0],b[0],t), lerp(a[1],b[1],t), lerp(a[2],b[2],t)];
const mulberry32=a=>()=>{let t=a+=0x6D2B79F5;t=Math.imul(t^t>>>15,t|1);t^=t+Math.imul(t^t>>>7,t|61);return((t^t>>>14)>>>0)/4294967296};
const hashStr=s=>{let h=2166136261>>>0; for(let i=0;i<s.length;i++){h^=s.charCodeAt(i); h=Math.imul(h,16777619);} return h>>>0;};
const saveKey='vector_racing_three_cam_v3';
const store={get(){try{return JSON.parse(localStorage.getItem(saveKey)||'{}')}catch(e){return{}}},set(v){localStorage.setItem(saveKey,JSON.stringify(v))}};
function norm(v){ const l=Math.hypot(v[0],v[1],v[2])||1; return [v[0]/l,v[1]/l,v[2]/l]; }

/* ---------- 상태 ---------- */
const SHAPES=['RANDOM','OVAL','FIG8','CLOVER','S_BEND','ISLAND','LEMNISCATE','WAVY'];
const cfg=Object.assign({seed:(Math.random()*1e9)|0,theme:'SPACE',shape:'RANDOM',aiCount:1,twoP:false,mobile:false,best:null}, store.get());

/* ---------- WebGL ---------- */
const view=document.getElementById('view'), canvas=document.getElementById('gl');
const gl=canvas.getContext('webgl',{antialias:false,preserveDrawingBuffer:false});
if(!gl){ panel('<h1>⚠ WebGL 미지원</h1>'); throw new Error('WebGL not supported'); }
let CW=2,CH=2;
function applyViewport(){const r=view.getBoundingClientRect(); CW=(r.width*DPR)|0; CH=(r.height*DPR)|0; canvas.width=CW; canvas.height=CH; gl.viewport(0,0,CW,CH);}
applyViewport(); new ResizeObserver(applyViewport).observe(view);
gl.enable(gl.DEPTH_TEST); gl.depthFunc(gl.LEQUAL);

/* ---------- 셰이더 ---------- */
function compile(type,src){const s=gl.createShader(type); gl.shaderSource(s,src); gl.compileShader(s); if(!gl.getShaderParameter(s,gl.COMPILE_STATUS)) throw new Error(gl.getShaderInfoLog(s)||'shader');
