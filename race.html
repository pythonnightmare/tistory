<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
<title>벡터 레이싱 — CC0</title>
<style>
  :root{ --bg:#070a16; --bg2:#0b1230; --ink:#eaf2ff; --muted:#9aa9c6 }
  html,body{height:100%;margin:0;background:radial-gradient(1000px 520px at 80% -10%,#182555 0%,transparent 52%),linear-gradient(180deg,var(--bg),var(--bg2));color:var(--ink);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;user-select:none;-webkit-user-select:none;overscroll-behavior:none}
  .wrap{max-width:1200px;margin:0 auto;padding:12px}
  .card{position:relative;border:1px solid rgba(255,255,255,.1);border-radius:18px;background:rgba(255,255,255,.04);box-shadow:0 12px 48px rgba(0,0,0,.45);overflow:hidden}
  .hud{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.08)}
  .title{display:flex;gap:10px;align-items:center;font-weight:800}
  .stats{display:flex;gap:16px;align-items:center}
  .stat{font-variant-numeric:tabular-nums}
  .stat .label{font-size:12px;color:var(--muted)}
  .controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .btn,.select{appearance:none;border:1px solid rgba(255,255,255,.14);background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02));color:var(--ink);padding:7px 10px;border-radius:10px;font-weight:800;cursor:pointer}
  .view{position:relative;width:100%;height:min(56.25vw,700px);background:#050812;touch-action:none}
  canvas{display:block;width:100%;height:100%}
  .overlay{position:absolute;inset:0;display:grid;place-items:center;pointer-events:none}
  .panel{pointer-events:auto;background:rgba(10,14,34,.82);border:1px solid rgba(255,255,255,.14);border-radius:18px;padding:18px;max-width:640px;text-align:center;box-shadow:0 16px 70px rgba(0,0,0,.5);animation:pop .14s ease-out}
  .panel h1{margin:0 0 8px}
  .panel .keys{margin:8px 0 0;font-size:12px;color:var(--muted);line-height:1.6}
  @keyframes pop{from{opacity:0;transform:scale(.97)}to{opacity:1;transform:scale(1)}}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div class="hud">
      <div class="title">🏁 벡터 레이싱</div>
      <div class="stats">
        <div class="stat" id="uiSpeed"><span class="label">SPEED</span> <b class="val">0</b></div>
        <div class="stat" id="uiLap"><span class="label">LAP</span> <b class="val">—</b></div>
        <div class="stat" id="uiDrift"><span class="label">DRIFT</span> <b class="val">0</b></div>
        <div class="stat" id="uiBest"><span class="label">BEST</span> <b class="val">—</b></div>
        <div class="stat" id="uiPos"><span class="label">RACE</span> <b class="val">Solo</b></div>
        <div class="stat" id="uiScore"><span class="label">SCORE</span> <b class="val">0</b></div>
      </div>
      <div class="controls">
        <button class="btn" id="btnPlay">▶ 시작</button>
        <button class="btn" id="btnPause">⏸ 일시정지</button>
        <button class="btn" id="btnReset">↻ 리셋</button>
        <button class="btn" id="btnReroll">🎲 새 트랙</button>
        <button class="btn" id="btnShape">🛣 트랙: RANDOM</button>
        <button class="btn" id="btnAI">🤖 AI: 0</button>
        <label style="font-size:12px;color:var(--muted)">테마</label>
        <select class="select" id="selTheme">
          <option value="SPACE">SPACE</option>
          <option value="CYBERPUNK">CYBERPUNK</option>
          <option value="XMAS">XMAS</option>
          <option value="NEON">NEON</option>
          <option value="VOLCANO">VOLCANO</option>
        </select>
      </div>
    </div>
    <div class="view" id="view">
      <canvas id="gl"></canvas>
      <div class="overlay" id="overlay"></div>
    </div>
  </div>
</div>

<script>
(()=>{const DPR=Math.max(1,Math.min(2,devicePixelRatio||1)),clamp=(v,a,b)=>Math.max(a,Math.min(b,v)),lerp=(a,b,t)=>a+(b-a)*t,now=()=>performance.now();function mulberry32(a){return function(){let t=a+=0x6D2B79F5;t=Math.imul(t^t>>>15,t|1);t^=t+Math.imul(t^t>>>7,t|61);return((t^t>>>14)>>>0)/4294967296}}const saveKey='vector_racing_cc0_v6';const store={get(){try{return JSON.parse(localStorage.getItem(saveKey)||'{}')}catch(e){return{}}},set(v){localStorage.setItem(saveKey,JSON.stringify(v))}};const cfg=Object.assign({seed:(Math.random()*1e9)|0,best:null,theme:'SPACE',shape:'RANDOM',aiCount:0},store.get());const hashStr=(s)=>{let h=2166136261>>>0;for(let i=0;i<s.length;i++){h^=s.charCodeAt(i);h=Math.imul(h,16777619)}return h>>>0};
const input={L:false,R:false,ACC:false,BR:false,DR:false,stickX:0,pointer:null};
addEventListener('keydown',e=>{if(e.repeat)return;const b=['ArrowLeft','ArrowRight','ArrowUp','ArrowDown','Space','KeyA','KeyD','KeyW','KeyS','KeyR','KeyP'];if(b.includes(e.code))e.preventDefault();if(e.code==='ArrowLeft'||e.code==='KeyA')input.L=true;if(e.code==='ArrowRight'||e.code==='KeyD')input.R=true;if(e.code==='ArrowUp'||e.code==='KeyW')input.ACC=true;if(e.code==='ArrowDown'||e.code==='KeyS')input.BR=true;if(e.code==='Space')input.DR=true;if(e.key==='p'||e.key==='P')togglePause();if(e.key==='r'||e.key==='R')reset()});addEventListener('keyup',e=>{if(e.code==='ArrowLeft'||e.code==='KeyA')input.L=false;if(e.code==='ArrowRight'||e.code==='KeyD')input.R=false;if(e.code==='ArrowUp'||e.code==='KeyW')input.ACC=false;if(e.code==='ArrowDown'||e.code==='KeyS')input.BR=false;if(e.code==='Space')input.DR=false});
const view=document.getElementById('view');view.addEventListener('pointerdown',e=>{if(e.button===0){view.setPointerCapture(e.pointerId);input.pointer={id:e.pointerId};if(state===S.MENU)start()}});view.addEventListener('pointermove',e=>{if(!input.pointer||e.pointerId!==input.pointer.id)return;const r=view.getBoundingClientRect();input.stickX=clamp(((e.clientX-r.left)/r.width)*2-1,-1,1)});view.addEventListener('pointerup',e=>{if(!input.pointer||e.pointerId!==input.pointer.id)return;input.pointer=null;input.stickX=0});
function setHUD(id,val){const el=document.querySelector('#'+id+' .val');if(el)el.textContent=val}
const canvas=document.getElementById('gl');const gl=canvas.getContext('webgl',{antialias:false,preserveDrawingBuffer:false});let CW=2,CH=2;function applyViewport(){const r=view.getBoundingClientRect();CW=(r.width*DPR)|0;CH=(r.height*DPR)|0;canvas.width=Math.max(2,CW);canvas.height=Math.max(2,CH);gl.viewport(0,0,CW,CH)}applyViewport();new ResizeObserver(applyViewport).observe(view);gl.enable(gl.BLEND);gl.blendFunc(gl.SRC_ALPHA,gl.ONE);gl.clearDepth(1);gl.enable(gl.DEPTH_TEST);gl.depthFunc(gl.LEQUAL);function compile(t,s){const sh=gl.createShader(t);gl.shaderSource(sh,s);gl.compileShader(sh);if(!gl.getShaderParameter(sh,gl.COMPILE_STATUS))throw gl.getShaderInfoLog(sh);return sh}function prog(vs,fs){const p=gl.createProgram();gl.attachShader(p,compile(gl.VERTEX_SHADER,vs));gl.attachShader(p,compile(gl.FRAGMENT_SHADER,fs));gl.linkProgram(p);if(!gl.getProgramParameter(p,gl.LINK_STATUS))throw gl.getProgramInfoLog(p);return p}
const M={mul:(a,b)=>{const o=new Array(16);for(let r=0;r<4;r++)for(let c=0;c<4;c++){o[c*4+r]=a[0*4+r]*b[c*4+0]+a[1*4+r]*b[c*4+1]+a[2*4+r]*b[c*4+2]+a[3*4+r]*b[c*4+3]}return o},T:(x,y,z)=>[1,0,0,0,0,1,0,0,0,0,1,0,x,y,z,1],RfromBasis:(x,y,z)=>[x[0],x[1],x[2],0,y[0],y[1],y[2],0,z[0],z[1],z[2],0,0,0,0,1],look:(eye,at,up)=>{const zx=eye[0]-at[0],zy=eye[1]-at[1],zz=eye[2]-at[2];const zL=Math.hypot(zx,zy,zz)||1;const z=[zx/zL,zy/zL,zz/zL];let x=[up[1]*z[2]-up[2]*z[1],up[2]*z[0]-up[0]*z[2],up[0]*z[1]-up[1]*z[0]];const xL=Math.hypot(x[0],x[1],x[2])||1;x=[x[0]/xL,x[1]/xL,x[2]/xL];const y=[z[1]*x[2]-z[2]*x[1],z[2]*x[0]-z[0]*x[2],z[0]*x[1]-z[1]*x[0]];const RT=[x[0],x[1],x[2],0,y[0],y[1],y[2],0,z[0],z[1],z[2],0,0,0,0,1];return M.mul(RT,M.T(-eye[0],-eye[1],-eye[2]))}},cross=(a,b)=>[a[1]*b[2]-a[2]*b[1],a[2]*b[0]-a[0]*b[2],a[0]*b[1]-a[1]*b[0]],sub=(a,b)=>[a[0]-b[0],a[1]-b[1],a[2]-b[2]],norm=v=>{const l=Math.hypot(v[0],v[1],v[2])||1;return [v[0]/l,v[1]/l,v[2]/l]},add=(a,b)=>[a[0]+b[0],a[1]+b[1],a[2]+b[2]],scale=(v,s)=>[v[0]*s,v[1]*s,v[2]*s];
function pushTri(out,x1,y1,z1,x2,y2,z2,x3,y3,z3,c,g){out.pos.push(x1,y1,z1,x2,y2,z2,x3,y3,z3);out.col.push(c[0],c[1],c[2],c[0],c[1],c[2],c[0],c[1],c[2]);out.glow.push(g,g,g)}function pushQuad(out,x1,y1,z1,x2,y2,z2,x3,y3,z3,x4,y4,z4,c,g){pushTri(out,x1,y1,z1,x2,y2,z2,x3,y3,z3,c,g);pushTri(out,x1,y1,z1,x3,y3,z3,x4,y4,z4,c,g)}function pushBox(out,cx,cy,cz,sx,sy,sz,ct,cs,g=0.25){const x=sx/2,y=sy/2,z=sz/2;pushQuad(out,cx-x,cy+y,cz-z,cx+x,cy+y,cz-z,cx+x,cy+y,cz+z,cx-x,cy+y,cz+z,ct,g);pushQuad(out,cx-x,cy-y,cz+z,cx+x,cy-y,cz+z,cx+x,cy-y,cz-z,cx-x,cy-y,cz-z,cs,g*0.8);pushQuad(out,cx-x,cy-y,cz-z,cx-x,cy+y,cz-z,cx-x,cy+y,cz+z,cx-x,cy-y,cz+z,cs,g);pushQuad(out,cx+x,cy-y,cz+z,cx+x,cy+y,cz+z,cx+x,cy+y,cz-z,cx+x,cy-y,cz-z,cs,g);pushQuad(out,cx-x,cy-y,cz+z,cx-x,cy+y,cz+z,cx+x,cy+y,cz+z,cx+x,cy-y,cz+z,cs,g);pushQuad(out,cx+x,cy-y,cz-z,cx+x,cy+y,cz-z,cx-x,cy+y,cz-z,cx-x,cy-y,cz-z,cs,g)}const makeGeo=()=>({pos:[],col:[],glow:[]});function makeBuffer(data,itemSize,type=gl.FLOAT){const b=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,b);gl.bufferData(gl.ARRAY_BUFFER,data,gl.STATIC_DRAW);return {b,itemSize,type}}function bindBuffer(buf,at){gl.bindBuffer(gl.ARRAY_BUFFER,buf.b);gl.enableVertexAttribArray(at);gl.vertexAttribPointer(at,buf.itemSize,buf.type,false,0,0)}
let samples=1100,trackW=6,trackMaxR=140,CP=[],centerline=[],bufRibbon=null,bufRail=null,verts=0,railVerts=0;const WORLD_UP=[0,1,0],SHAPES=['RANDOM','OVAL','FIG8','CLOVER','S_BEND','ISLAND','LEMNISCATE','WAVY'];
const catmull=(p0,p1,p2,p3,t)=>{const t2=t*t,t3=t2*t;return[0.5*((2*p1[0])+(-p0[0]+p2[0])*t+(2*p0[0]-5*p1[0]+4*p2[0]-p3[0])*t2+(-p0[0]+3*p1[0]-3*p2[0]+p3[0])*t3),0.5*((2*p1[1])+(-p0[1]+p2[1])*t+(2*p0[1]-5*p1[1]+4*p2[1]-p3[1])*t2+(-p0[1]+3*p1[1]-3*p2[1]+p3[1])*t3),0.5*((2*p1[2])+(-p0[2]+p2[2])*t+(2*p0[2]-5*p1[2]+4*p2[2]-p3[2])*t2+(-p0[2]+3*p1[2]-3*p2[2]+p3[2])*t3)]},catmullTangent=(p0,p1,p2,p3,t)=>{const t2=t*t;return[0.5*((-p0[0]+p2[0])+2*(2*p0[0]-5*p1[0]+4*p2[0]-p3[0])*t+3*(-p0[0]+3*p1[0]-3*p2[0]+p3[0])*t2),0.5*((-p0[1]+p2[1])+2*(2*p0[1]-5*p1[1]+4*p2[1]-p3[1])*t+3*(-p0[1]+3*p1[1]-3*p2[1]+p3[1])*t2),0.5*((-p0[2]+p2[2])+2*(2*p0[2]-5*p1[2]+4*p2[2]-p3[2])*t+3*(-p0[2]+3*p1[2]-3*p2[2]+p3[2])*t2)]};let samplesPerLap=samples;const getCenter=i=>{const N=samplesPerLap;i=(i+N)%N;return [centerline[i*3],centerline[i*3+1],centerline[i*3+2]]},basisAt=i=>{const p0=getCenter(i),p1=getCenter(i+1);const T=norm(sub(p1,p0));let R=norm(cross(T,WORLD_UP));if(!isFinite(R[0]))R=[1,0,0];const B=norm(cross(R,T));return {T,R,B}};function computeTrackMaxR(){let m=0;for(let i=0;i<centerline.length;i+=3){const x=centerline[i],z=centerline[i+2];m=Math.max(m,Math.hypot(x,z))}trackMaxR=m}
function genCP(seed,shape,yAmp,baseY){const rng=mulberry32(seed|0),rand=(a,b)=>a+(b-a)*rng();if(shape==='RANDOM')shape=SHAPES[1+((rng()*(SHAPES.length-1))|0)];const arr=[],N=36,R=120,ph=rand(0,Math.PI*2);for(let i=0;i<N;i++){const t=i/N*2*Math.PI;let x=0,z=0;if(shape==='OVAL'){const rx=R*(1.1+0.2*Math.sin(3*t+ph)),rz=R*(0.8+0.15*Math.sin(2*t+ph));x=rx*Math.cos(t);z=rz*Math.sin(t)}else if(shape==='FIG8'){x=R*0.9*Math.sin(2*t);z=R*0.7*Math.sin(t);x+=18*Math.sin(3*t+ph)}else if(shape==='CLOVER'){const rad=R*(1+0.35*Math.sin(3*t+ph));x=rad*Math.cos(t);z=rad*Math.sin(t)}else if(shape==='S_BEND'){x=R*1.1*Math.cos(t)+30*Math.sin(2*t);z=R*0.8*Math.sin(t)}else if(shape==='ISLAND'){const rad=R*(0.9+0.18*Math.sin(3*t+ph))*(0.94+rand(0,0.16));x=rad*Math.cos(t);z=rad*Math.sin(t)}else if(shape==='LEMNISCATE'){const a=R*0.9;const s=Math.sin(t),c=Math.cos(t);x=(a*Math.sqrt(2)*c)/(1+s*s);z=(a*Math.sqrt(2)*c*s)/(1+s*s)}else if(shape==='WAVY'){const rx=R*(1+0.25*Math.sin(4*t+ph)),rz=R*(1+0.25*Math.cos(3*t+ph));x=rx*Math.cos(t);z=rz*Math.sin(t)}const y=baseY+rand(-yAmp,yAmp)*(0.6+0.4*Math.sin(2*t+ph));arr.push([x,y,z])}arr.push(arr[0],arr[1],arr[2]);return arr}
function buildTrack(themeKey){const T=THEMES[themeKey];const seed2=(cfg.seed^hashStr(themeKey)^hashStr(cfg.shape))>>>0;trackW=T.trackW*2.0;CP=genCP(seed2,cfg.shape,T.yAmp,T.baseY);const pos=[],col=[],glow=[],railPos=[],railCol=[],railGlow=[];centerline=[];verts=0;railVerts=0;const Ls=CP.length-3,maxSeg=Ls-1e-6;for(let i=0;i<samples;i++){const seg=(i/(samples-1))*maxSeg,j=Math.floor(seg),t=seg-j;const p=catmull(CP[j],CP[j+1],CP[j+2],CP[j+3],t),d=norm(catmullTangent(CP[j],CP[j+1],CP[j+2],CP[j+3],t));let Rv=norm(cross(d,WORLD_UP));if(!isFinite(Rv[0]))Rv=[1,0,0];centerline.push(p[0],p[1],p[2]);if(i<samples-1){const L=add(p,scale(Rv,-trackW*0.5)),Rr=add(p,scale(Rv,trackW*0.5));pos.push(L[0],L[1],L[2],Rr[0],Rr[1],Rr[2]);col.push(...T.trackC1,...T.trackC2);glow.push(0.55,0.55);verts+=2;railPos.push(L[0],L[1]+0.12,L[2],Rr[0],Rr[1]+0.12,Rr[2]);railCol.push(...T.rail,...T.rail);railGlow.push(1.4,1.4);railVerts+=2}}computeTrackMaxR();bufRibbon={pos:makeBuffer(new Float32Array(pos),3),col:makeBuffer(new Float32Array(col),3),glow:makeBuffer(new Float32Array(glow),1)};bufRail={pos:makeBuffer(new Float32Array(railPos),3),col:makeBuffer(new Float32Array(railCol),3),glow:makeBuffer(new Float32Array(railGlow),1)};gl.clearColor(T.fog[0],T.fog[1],T.fog[2],1);buildCollect(themeKey,seed2);buildBoost(themeKey,seed2);buildEnv(themeKey,seed2);buildCharacters(themeKey,seed2);buildTunnels(themeKey,seed2);ensureAICount(seed2);setHUD('uiPos',rankText())}
function makeCarGeom(col,glow=0.9){const hw=0.72,hh=0.26,hl=1.28,nose=0.55,c=col;const P=[-hw,hh,-hl,hw,hh,-hl,0,hh+nose,-hl*0.2,-hw,hh,hl*0.2,0,hh+nose,-hl*0.2,hw,hh,hl*0.2,-hw,-hh,-hl,-hw,hh,-hl,-hw,hh,hl*0.2,-hw,-hh,-hl,-hw,hh,hl*0.2,-hw,-hh,hl*0.2,hw,-hh,-hl,hw,hh,hl*0.2,hw,hh,-hl,hw,-hh,-hl,hw,-hh,hl*0.2,hw,hh,hl*0.2,-hw,-hh,hl*0.2,hw,-hh,hl*0.2,hw,-hh,-hl,-hw,-hh,hl*0.2,hw,-hh,-hl,-hw,-hh,-hl];const cols=[];for(let i=0;i<P.length/3;i++)cols.push(c[0],c[1],c[2]);const g=new Float32Array(P.length/3).fill(glow);return {pos:makeBuffer(new Float32Array(P),3),col:makeBuffer(new Float32Array(cols),3),glow:makeBuffer(g,1),verts:P.length/3}}
let playerGeom=null,aiGeoms=[];const themeCarColor=key=>THEMES[key].car;
function makeCar(inputRef){return{s:0,v:0,off:0,offV:0,steer:0,drift:0,shake:0,lapStart:null,score:0,update(dt){let steerRaw=(inputRef.L?-1:0)+(inputRef.R?1:0);if(steerRaw===0)steerRaw=clamp(inputRef.stickX,-1,1);const ACC=inputRef.ACC||(inputRef.pointer!=null),BR=inputRef.BR,DR=inputRef.DR;const maxV=130;const acc=ACC?(DR?70:56):0,dec=BR?88:10;this.v=acc>0?clamp(this.v+acc*dt,0,maxV):Math.max(0,this.v-dec*dt);const smooth=1-Math.pow(0.0001,dt*28);this.steer+=(steerRaw-this.steer)*smooth;const latBase=(7+this.v*0.6)*(DR?1.3:0.7);const targetOffV=this.steer*latBase;const f=1-Math.pow(0.0001,dt*(DR?16:22));this.offV+=(targetOffV-this.offV)*f;const spring=-this.off*(DR?0.7:1.2);this.offV+=spring*dt;this.offV*=(DR?0.90:0.94);this.off=clamp(this.off+this.offV*dt,-trackW*0.46,trackW*0.46);this.s=(this.s+this.v*dt)%samplesPerLap;const slip=Math.abs(this.offV)/(trackW*0.8);this.v*=(1-clamp(slip*(DR?0.024:0.05),0,0.12));const gain=Math.max(0,(Math.abs(this.offV)*0.03+Math.abs(this.steer)*this.v*0.014)*(DR?2.0:1.0));this.drift=Math.max(0,this.drift+(gain-0.36*dt));if(BR){this.shake=Math.min(this.shake+6*dt,1)}else{this.shake=Math.max(0,this.shake-2.6*dt)}if(this.lapStart==null)this.lapStart=performance.now();const tNow=performance.now();if(this.s<2&&this.v>12&&(tNow-this.lapStart)>2000){const lap=(tNow-this.lapStart)/1000;this.lapStart=tNow;setHUD('uiLap',lap.toFixed(2)+'s');if(cfg.best==null||lap<cfg.best){cfg.best=lap;store.set(cfg);setHUD('uiBest',cfg.best.toFixed(2)+'s')}}collectItems(this);boostPads(this)},world(){const i=Math.floor(this.s)|0,t=this.s-i,p=getCenter(i),n=getCenter(i+1),pos=[lerp(p[0],n[0],t),lerp(p[1],n[1],t),lerp(p[2],n[2],t)];const {T,R,B}=basisAt(i);return {pos:add(pos,scale(R,this.off)),T,R,B}}}}
function makeAICar(seed,idx){const rng=mulberry32(seed+idx*101);return{s:30+rng()*50,v:0,off:(rng()*2-1)*trackW*0.2,offV:0,lapStart:null,update(dt){const look=24;const i=Math.floor(this.s+look)|0;const aim=0;const diff=aim-this.off;const steer=clamp(diff*0.6+this.offV*-0.05+(Math.sin(this.s*0.01+idx)*0.2),-1,1);const maxV=120;const targetV=maxV*(0.82+0.16*Math.sin(i*0.03+idx));this.v+=clamp(targetV-this.v,-34*dt,42*dt);const lat=(6+this.v*0.5);const targetOffV=steer*lat;this.offV+=(targetOffV-this.offV)*(1-Math.pow(0.0001,dt*20));this.offV+=(-this.off*1.0)*dt;this.offV*=0.94;this.off=clamp(this.off+this.offV*dt,-trackW*0.46,trackW*0.46);this.s=(this.s+this.v*dt)%samplesPerLap;},world(){const i=Math.floor(this.s)|0,t=this.s-i,p=getCenter(i),n=getCenter(i+1),pos=[lerp(p[0],n[0],t),lerp(p[1],n[1],t),lerp(p[2],n[2],t)];const {T,R,B}=basisAt(i);return {pos:add(pos,scale(R,this.off)),T,R,B}}}}
const aiPalette=[[1.00,0.40,0.25],[0.25,1.00,0.75],[1.00,0.85,0.30],[0.35,0.70,1.00]];
const car=makeCar(input);let aiCars=[];function ensureAICount(seed2){const n=clamp(cfg.aiCount,0,4)|0;while(aiCars.length<n)aiCars.push(makeAICar(seed2,aiCars.length));aiCars=aiCars.slice(0,n);setHUD('uiPos',rankText())}
const cam={eye:[0,3.6,-11],at:[0,1.0,5],up:[0,1,0],fovBase:66*(Math.PI/180),fov:66*(Math.PI/180),update(dt){const w=car.world();const speed=clamp(car.v,0,130);const k=1-Math.pow(0.0001,dt*10);const baseH=3.4,baseLead=6.0,baseBack=10.5;const brakePull=car.shake*1.1;const h=baseH-0.5*car.shake;const lead=baseLead-0.8*car.shake;const back=baseBack-1.1*car.shake;const targetAt=[w.pos[0]+w.T[0]*lead,w.pos[1]+0.9,w.pos[2]+w.T[2]*lead];const targetEye=[targetAt[0]-w.T[0]*back,targetAt[1]+h,targetAt[2]-w.T[2]*back];this.eye=[lerp(this.eye[0],targetEye[0],k),lerp(this.eye[1],targetEye[1],k),lerp(this.eye[2],targetEye[2],k)];this.at=[lerp(this.at[0],targetAt[0],k),lerp(this.at[1],targetAt[1],k),lerp(this.at[2],targetAt[2],k)];this.up=[0,1,0];this.fov=this.fovBase+(speed*0.6)*(Math.PI/180)},snap(){const w=car.world();const lead=6.0,back=10.5;this.at=[w.pos[0]+w.T[0]*lead,w.pos[1]+0.9,w.pos[2]+w.T[2]*lead];this.eye=[this.at[0]-w.T[0]*back,this.at[1]+3.4,this.at[2]-w.T[2]*back];this.up=[0,1,0]},VP(aspect=CW/CH){const V=M.look(this.eye,this.at,this.up),P=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],f=1/Math.tan(this.fov/2),near=0.1,far=1200,nf=1/(near-far);P[0]=f/(aspect>0?aspect:1);P[5]=f;P[10]=(far+near)*nf;P[11]=-1;P[14]=(2*far*near)*nf;P[15]=0;return M.mul(P,V)}}
let envBuf=null,envVerts=0,propBuf=null,propVerts=0,geoBuf=null,geoVerts=0,charBuf=null,charVerts=0,tunnelBuf=null,tunnelVerts=0,snowBuf=null,snowVerts=0;
function buildEnv(themeKey,seed2){envBuf=propBuf=geoBuf=snowBuf=null;envVerts=propVerts=geoVerts=snowVerts=0;const pts=[],cols=[],glows=[],p2=[],c2=[],g2=[],GEO=makeGeo();const pushP=(x,y,z,c,g)=>{pts.push(x,y,z);cols.push(c[0],c[1],c[2]);glows.push(g)};const push2=(x,y,z,c,g)=>{p2.push(x,y,z);c2.push(c[0],c[1],c[2]);g2.push(g)};const rng=mulberry32(seed2),t=THEMES[themeKey],groundY=0;const ringR=trackMaxR+trackW*2.8; // 더 여유
if(themeKey==='SPACE'){const rngS=mulberry32(seed2^0x55aa);for(let i=0;i<2600;i++){const rr=ringR+40+rngS()*300,aa=rngS()*Math.PI*2,rx=Math.cos(aa)*rr,rz=Math.sin(aa)*rr,ry=(rngS()*2-1)*260+60;pushP(rx,ry,rz,[0.82+rngS()*0.18,0.88+rngS()*0.12,1],0.06)}const makeSphere=(cx,cy,cz,R,lat,lon,col,glw)=>{for(let i=0;i<lat;i++){const v0=i/lat*Math.PI,v1=(i+1)/lat*Math.PI;for(let j=0;j<lon;j++){const u0=j/lon*2*Math.PI,u1=(j+1)/lon*2*Math.PI;const p=(v,u)=>[cx+R*Math.sin(v)*Math.cos(u),cy+R*Math.cos(v),cz+R*Math.sin(v)*Math.sin(u)];const a=p(v0,u0),b=p(v0,u1),c=p(v1,u1),d=p(v1,u0);pushQuad(GEO,a[0],a[1],a[2],b[0],b[1],b[2],c[0],c[1],c[2],d[0],d[1],d[2],col,glw)}}};const bigR=ringR+120;makeSphere(Math.cos(0.8)*bigR,26,Math.sin(0.8)*bigR,22,14,28,[0.55,0.8,1.0],0.55);makeSphere(Math.cos(2.1)*bigR*0.8,-12,Math.sin(2.1)*bigR*0.8,14,12,20,[1.0,0.6,0.25],0.5);const ring=(cx,cy,cz,R,rMinor,seg=128,col=[0.6,0.9,1],glw=0.6)=>{for(let i=0;i<seg;i++){const a0=i/seg*2*Math.PI,a1=(i+1)/seg*2*Math.PI;const p0=[cx+Math.cos(a0)*R,cy,cz+Math.sin(a0)*R],p1=[cx+Math.cos(a1)*R,cy,cz+Math.sin(a1)*R];pushQuad(GEO,p0[0],cy-rMinor,p0[2],p1[0],cy-rMinor,p1[2],p1[0],cy+rMinor,p1[2],p0[0],cy+rMinor,p0[2],col,glw)}};ring(Math.cos(0.8)*bigR,26,Math.sin(0.8)*bigR,36,1.2,160,[0.6,0.85,1.0],0.7);for(let i=0;i<260;i++){const rr=ringR+40+rng()*360,aa=rng()*Math.PI*2,rx=Math.cos(aa)*rr,rz=Math.sin(aa)*rr,ry=(rng()*2-1)*220+40;push2(rx,ry,rz,[0.9,0.95,1],0.9)}}
else{if(t.ground){const rad=ringR+120,step=10,baseCol=(themeKey==='XMAS')?[0.95,0.98,1]:(themeKey==='VOLCANO')?[0.25,0.08,0.06]:(themeKey==='CYBERPUNK')?[0.08,0.08,0.12]:[0.06,0.08,0.12];for(let x=-rad;x<rad;x+=step)for(let z=-rad;z<rad;z+=step){if(Math.hypot(x,z)<ringR-12)continue;const c=[baseCol[0]*(0.94+0.12*rng()),baseCol[1]*(0.94+0.12*rng()),baseCol[2]*(0.94+0.12*rng())];pushQuad(GEO,x,groundY,z,x+step,groundY,z,x+step,groundY,z+step,x,groundY,z+step,c,0.13)}}if(themeKey==='CYBERPUNK'){for(let i=0;i<460;i++){const r=ringR+12+rng()*260,a=rng()*Math.PI*2,x=Math.cos(a)*r,z=Math.sin(a)*r,sy=16+rng()*70;pushBox(GEO,x,sy/2,z,5+rng()*24,sy,5+rng()*24,[0.2,0.9,0.9],[0.6,0.2,1],0.4)}for(let i=0;i<160;i++){const r=ringR+30+rng()*220,a=rng()*Math.PI*2,x=Math.cos(a)*r,z=Math.sin(a)*r;pushQuad(GEO,x,6,z,x+5,6,z,x+5,12,z,x,12,z,[1,0.3,0.9],0.9)}for(let i=0;i<200;i++){const r=ringR+20+rng()*260,a=rng()*Math.PI*2;push2(Math.cos(a)*r,10+rng()*50,Math.sin(a)*r,[0.3,1,1],0.85)}}else if(themeKey==='XMAS'){for(let i=0;i<360;i++){const r=ringR+14+rng()*200,a=rng()*Math.PI*2,x=Math.cos(a)*r,z=Math.sin(a)*r;if(rng()<0.55){const sx=6+rng()*6,sz=6+rng()*6,sy=4+rng()*3;pushBox(GEO,x,sy/2,z,sx,sy,sz,[1,0.2,0.2],[0.9,0.9,0.95],0.35);pushBox(GEO,x,sy+1.4,z,sx*0.9,1.4,sz*0.9,[0.9,0.1,0.1],[0.9,0.1,0.1],0.4)}else{pushBox(GEO,x,1.3,z,1.0,3.0,1.0,[0.5,0.3,0.2],[0.5,0.3,0.2]);pushBox(GEO,x,4.0,z,3.8,2.2,3.8,[0.1,0.6,0.2],[0.1,0.5,0.2]);pushBox(GEO,x,6.5,z,3.0,2.0,3.0,[0.1,0.7,0.2],[0.1,0.6,0.2]);pushBox(GEO,x,8.9,z,2.4,1.8,2.4,[0.1,0.8,0.2],[0.1,0.7,0.2])}} // 눈
  const sPos=[],sCol=[],sGlow=[];for(let i=0;i<4200;i++){const r=ringR+8+rng()*240,a=rng()*Math.PI*2,rx=Math.cos(a)*r,rz=Math.sin(a)*r,ry=groundY+80+rng()*220;sPos.push(rx,ry,rz);sCol.push(1,1,1);sGlow.push(-0.7)}snowBuf={pos:makeBuffer(new Float32Array(sPos),3),col:makeBuffer(new Float32Array(sCol),3),glow:makeBuffer(new Float32Array(sGlow),1)};snowVerts=sPos.length/3}
else if(themeKey==='NEON'){const baseR=ringR+18;for(let i=0;i<22;i++){const r=baseR+i*10;for(let a=0;a<Math.PI;a+=Math.PI/28){const x=Math.cos(a)*r,y=Math.sin(a)*32+6,z=0;pushQuad(GEO,x,y,z,x+1.6,y,z,x+1.6,y+1.6,z,x,y+1.6,z,[0.2,0.8,1],0.65)}}for(let i=0;i<520;i++){const r=baseR+rng()*320,a=rng()*Math.PI*2,rx=Math.cos(a)*r,rz=Math.sin(a)*r;push2(rx,-7,rz,[0.3,0.9,1],0.85)}}else if(themeKey==='VOLCANO'){for(let i=0;i<320;i++){const r=ringR+8+rng()*280,a=rng()*Math.PI*2,x=Math.cos(a)*r,z=Math.sin(a)*r,sy=9+rng()*32;pushBox(GEO,x,sy/2,z,5,sy,5,[1,0.5,0.2],[1,0.35,0.15],0.44)}for(let i=0;i<1700;i++){const r=ringR+14+rng()*300,a=rng()*Math.PI*2,rx=Math.cos(a)*r,rz=Math.sin(a)*r,ry=rng()*110+8;pushP(rx,ry,rz,[1,0.5+rng()*0.3,0.2],0.45)}}}if(pts.length){envBuf={pos:makeBuffer(new Float32Array(pts),3),col:makeBuffer(new Float32Array(cols),3),glow:makeBuffer(new Float32Array(glows),1)};envVerts=pts.length/3}if(p2.length){propBuf={pos:makeBuffer(new Float32Array(p2),3),col:makeBuffer(new Float32Array(c2),3),glow:makeBuffer(new Float32Array(g2),1)};propVerts=p2.length/3}if(GEO.pos.length){geoBuf={pos:makeBuffer(new Float32Array(GEO.pos),3),col:makeBuffer(new Float32Array(GEO.col),3),glow:makeBuffer(new Float32Array(GEO.glow),1)};geoVerts=GEO.pos.length/3}}
function buildCharacters(themeKey,seed2){charBuf=null;charVerts=0;const G=makeGeo(),rng=mulberry32(seed2^0xABCD),ringR=trackMaxR+trackW*2.4;const bot=(x,y,z,s,c1,c2)=>{pushBox(G,x,y+2*s,z,1.2*s,1.8*s,0.8*s,c1,c1,0.4);pushBox(G,x,y+3.2*s,z,0.9*s,0.9*s,0.9*s,c2,c2,0.7);pushBox(G,x-0.9*s,y+2*s,z,0.4*s,1.2*s,0.4*s,c1,c1,0.4);pushBox(G,x+0.9*s,y+2*s,z,0.4*s,1.2*s,0.4*s,c1,c1,0.4)},snow=(x,y,z,s)=>{pushBox(G,x,y+0.7*s,z,1.0*s,1.0*s,1.0*s,[1,1,1],[1,1,1],0.8);pushBox(G,x,y+1.6*s,z,0.8*s,0.8*s,0.8*s,[1,1,1],[1,1,1],0.8);pushBox(G,x,y+2.3*s,z,0.6*s,0.6*s,0.6*s,[1,1,1],[1,1,1],0.9)},dancer=(x,y,z,s,c)=>{pushBox(G,x,y+1.6*s,z,0.9*s,1.6*s,0.6*s,c,c,0.85);pushBox(G,x,y+2.6*s,z,0.6*s,0.6*s,0.6*s,c,c,0.9)},golem=(x,y,z,s)=>{pushBox(G,x,y+1.6*s,z,1.2*s,1.6*s,1.0*s,[1,0.45,0.15],[1,0.35,0.12],0.85);pushBox(G,x,y+2.6*s,z,1.0*s,0.8*s,1.0*s,[1,0.5,0.2],[1,0.35,0.15],0.85)},astro=(x,y,z,s)=>{pushBox(G,x,y+1.9*s,z,1.0*s,1.6*s,0.8*s,[0.9,0.95,1],[0.8,0.9,1],0.7);pushBox(G,x,y+2.8*s,z,0.8*s,0.8*s,0.8*s,[0.6,0.8,1],[0.6,0.8,1],0.9)},ship=(x,y,z,s)=>{pushBox(G,x,y+0.6*s,z,2.2*s,0.6*s,1.2*s,[0.7,0.9,1],[0.5,0.7,1],0.9);pushBox(G,x,y+1.3*s,z,1.0*s,0.5*s,0.5*s,[0.9,1,1],[0.7,0.9,1],0.8)};const N=220;for(let i=0;i<N;i++){const r=ringR+14+rng()*120,a=rng()*Math.PI*2,x=Math.cos(a)*r,z=Math.sin(a)*r,s=0.9+rng()*0.9,h=0;if(themeKey==='SPACE'){if(rng()<0.4)astro(x,h,z,s);else ship(x,h+2,z,0.7*s)}else if(themeKey==='CYBERPUNK')bot(x,h,z,s,[0.2,0.9,0.9],[1,0.3,0.9]);else if(themeKey==='XMAS')snow(x,h,z,1.2*s);else if(themeKey==='NEON')dancer(x,h,z,s,[0.3,1,1]);else if(themeKey==='VOLCANO')golem(x,h,z,s)}if(G.pos.length){charBuf={pos:makeBuffer(new Float32Array(G.pos),3),col:makeBuffer(new Float32Array(G.col),3),glow:makeBuffer(new Float32Array(G.glow),1)};charVerts=G.pos.length/3}}
function buildTunnels(themeKey,seed2){tunnelBuf=null;tunnelVerts=0;const G=makeGeo(),rng=mulberry32(seed2^0xFACE),T=THEMES[themeKey];function tube(ci,rad,length,radial=36,axial=10){const C0=getCenter(ci),C1=getCenter(ci+Math.floor(length));const baseCol=T.trackC2;for(let j=0;j<axial;j++){const s0=j/axial,s1=(j+1)/axial;const C=[lerp(C0[0],C1[0],s0),lerp(C0[1],C1[1],s0),lerp(C0[2],C1[2],s0)],D=[lerp(C0[0],C1[0],s1),lerp(C0[1],C1[1],s1),lerp(C0[2],C1[2],s1)];const {R,B}=basisAt(ci);for(let i=0;i<radial;i++){const t0=i/radial*2*Math.PI,t1=(i+1)/radial*2*Math.PI;const a0=add(C,add(scale(R,Math.cos(t0)*rad),scale(B,Math.sin(t0)*rad))),a1=add(C,add(scale(R,Math.cos(t1)*rad),scale(B,Math.sin(t1)*rad))),b1=add(D,add(scale(R,Math.cos(t1)*rad),scale(B,Math.sin(t1)*rad))),b0=add(D,add(scale(R,Math.cos(t0)*rad),scale(B,Math.sin(t0)*rad)));pushQuad(G,a0[0],a0[1],a0[2],a1[0],a1[1],a1[2],b1[0],b1[1],b1[2],b0[0],b0[1],b0[2],baseCol,0.8)}} // 리브
  for(let i=0;i<radial;i+=3){const t0=i/radial*2*Math.PI,t1=(i+1)/radial*2*Math.PI;const {R,B}=basisAt(ci);const Cmid=[(C0[0]+C1[0])/2,(C0[1]+C1[1])/2,(C0[2]+C1[2])/2];const a=add(Cmid,scale(R,Math.cos(t0)*(rad+1.0)));const b=add(Cmid,scale(R,Math.cos(t1)*(rad+1.0)));pushQuad(G,a[0],a[1]-2,a[2],b[0],b[1]-2,b[2],b[0],b[1]+2,b[2],a[0],a[1]+2,a[2],[1,1,1],0.9)}}function arch(ci,height,width){const C=getCenter(ci),{R,B}=basisAt(ci);const steps=24;for(let i=0;i<steps;i++){const t0=i/steps*Math.PI,t1=(i+1)/steps*Math.PI;const a=add(C,add(scale(R,Math.cos(t0)*width),scale(B,Math.sin(t0)*height)));const b=add(C,add(scale(R,Math.cos(t1)*width),scale(B,Math.sin(t1)*height)));pushQuad(G,a[0],a[1],a[2],b[0],b[1],b[2],b[0],b[1]+1.6,b[2],a[0],a[1]+1.6,a[2],[1,1,1],0.9)}}
const n=4+(rng()*3|0);for(let k=0;k<n;k++){const i=80+(rng()*(samples-200)|0);tube(i,Math.max(4.0,trackW*1.6),24+(rng()*16|0),44,12)}for(let gk=0;gk<6;gk++){const i=60+(rng()*(samples-120)|0);arch(i,12+trackW*0.6,trackW*0.7)}if(themeKey==='SPACE'){const m=1+(rng()*2|0);for(let k=0;k<m;k++){const i=120+(rng()*(samples-240)|0);const C=getCenter(i);const lat=12,lon=20,rad=Math.max(18,trackW*2.4);for(let a=0;a<lat;a++){const v0=a/lat*Math.PI,v1=(a+1)/lat*Math.PI;for(let b=0;b<lon;b++){const u0=b/lon*2*Math.PI,u1=(b+1)/lon*2*Math.PI;const p=(v,u)=>[C[0]+rad*Math.sin(v)*Math.cos(u),C[1]+rad*Math.cos(v),C[2]+rad*Math.sin(v)*Math.sin(u)];const A=p(v0,u0),B=p(v0,u1),C2=p(v1,u1),D=p(v1,u0);pushQuad(G,A[0],A[1],A[2],B[0],B[1],B[2],C2[0],C2[1],C2[2],D[0],D[1],D[2],[0.6,0.85,1.0],0.7)}}}if(G.pos.length){tunnelBuf={pos:makeBuffer(new Float32Array(G.pos),3),col:makeBuffer(new Float32Array(G.col),3),glow:makeBuffer(new Float32Array(G.glow),1)};tunnelVerts=G.pos.length/3}}
let orbBuf=null,orbVerts=0,orbs=[],boostBuf=null,boostVerts=0,boosts=[],missionDone=false;function buildCollect(theme,seed2){orbs=[];const pos=[],col=[],glow=[];const rng=mulberry32(seed2^0x333);for(let i=40;i<samples;i+=Math.floor(56+rng()*60)){const {R}=basisAt(i),C=getCenter(i),l=(rng()*2-1)*trackW*0.42,p=[C[0]+R[0]*l,C[1]+1.0,C[2]+R[2]*l];orbs.push({i,pos:p,r:1.0,taken:false});pos.push(p[0],p[1],p[2]);col.push(1,1,1);glow.push(1.6)}orbBuf={pos:makeBuffer(new Float32Array(pos),3),col:makeBuffer(new Float32Array(col),3),glow:makeBuffer(new Float32Array(glow),1)};orbVerts=pos.length/3}
function buildBoost(theme,seed2){boosts=[];const pos=[],col=[],glow=[];const rng=mulberry32(seed2^0x999);for(let i=80;i<samples;i+=Math.floor(120+rng()*100)){const C=getCenter(i),p=[C[0],C[1]+0.2,C[2]];boosts.push({i,pos:p,r:2.0});pos.push(p[0],p[1],p[2]);col.push(0.3,1,0.8);glow.push(1.5)}boostBuf={pos:makeBuffer(new Float32Array(pos),3),col:makeBuffer(new Float32Array(col),3),glow:makeBuffer(new Float32Array(glow),1)};boostVerts=pos.length/3}
function boostPads(c){for(const b of boosts){const w=c.world(),d=Math.hypot(w.pos[0]-b.pos[0],w.pos[1]-b.pos[1],w.pos[2]-b.pos[2]);if(d<b.r){c.v=Math.min(c.v+28,130)}}}
function collectItems(c){let got=0;for(const o of orbs){if(o.taken)continue;const w=c.world();const d=Math.hypot(w.pos[0]-o.pos[0],w.pos[1]-o.pos[1],w.pos[2]-o.pos[2]);if(d<o.r){o.taken=true;c.score+=120;got++}}if(got>0){setHUD('uiScore',String(c.score));const remain=orbs.filter(o=>!o.taken).length;setHUD('uiMission',remain>0?`Collect ${remain}`:'Mission ✓');if(remain===0&&!missionDone){missionDone=true;const col=THEMES[cfg.theme].trackC1,hex='#'+col.map(v=>('0'+((v*255)|0).toString(16)).slice(-2)).join(''),ov=document.getElementById('overlay');ov.innerHTML=`<div class="panel" style="border-color:${hex}80;background:linear-gradient(180deg,${hex}22,rgba(10,14,34,.78));font-weight:800">MISSION COMPLETE</div>`;setTimeout(()=>ov.innerHTML='',1300);c.score+=5000;setHUD('uiScore',String(c.score))}}}
const VS=`attribute vec3 aPos;attribute vec3 aCol;attribute float aGlow;uniform mat4 uVP;uniform float uTime;varying vec3 vCol;varying float vGlow;
float n2(vec2 p){return fract(sin(dot(p, vec2(12.9898,78.233)))*43758.5453);}
void main(){
  vCol=aCol; float g=aGlow; vec3 p=aPos;
  // XMAS 눈: g<0 → 각 파티클별 위상/속도 난수화
  if(g<0.0){
    float n = n2(p.xz);
    float speed = 0.06 + 0.16*n;       // 더 느리고 다양한 속도
    float ph = fract(n*7.13);
    float t = fract(uTime*speed + ph);
    float fall = (180.0 + 140.0*n);
    p.y = p.y - t*fall;
    g = 0.5 + 0.3*n;
  }
  vGlow=g;
  gl_Position=uVP*vec4(p,1.0);
  gl_PointSize = 1.2 + 2.0*clamp(vGlow,0.0,2.0); // 눈 더 작게
}`;
const FS=`precision mediump float;varying vec3 vCol;varying float vGlow;void main(){float a=min(0.08+vGlow*0.9,1.0);gl_FragColor=vec4(vCol,a);} `;
const program=prog(VS,FS);gl.useProgram(program);const loc={aPos:gl.getAttribLocation(program,'aPos'),aCol:gl.getAttribLocation(program,'aCol'),aGlow:gl.getAttribLocation(program,'aGlow'),uVP:gl.getUniformLocation(program,'uVP'),uTime:gl.getUniformLocation(program,'uTime')};
function drawBuf(buf,count,mode){if(!buf||!count)return;bindBuffer(buf.pos,loc.aPos);bindBuffer(buf.col,loc.aCol);bindBuffer(buf.glow,loc.aGlow);gl.drawArrays(mode,0,count)}
function drawCarGeom(g){bindBuffer(g.pos,loc.aPos);bindBuffer(g.col,loc.aCol);bindBuffer(g.glow,loc.aGlow);gl.drawArrays(gl.TRIANGLES,0,g.verts)}
function carModelMatrix(c,driftYaw=0){const w=c.world();const cos=Math.cos(driftYaw),sin=Math.sin(driftYaw);const R=w.R,B=w.B,T=w.T;const R2=[R[0]*cos+T[0]*sin,R[1]*cos+T[1]*sin,R[2]*cos+T[2]*sin];const T2=[T[0]*cos-R[0]*sin,T[1]*cos-R[1]*sin,T[2]*cos-R[2]*sin];return M.mul(M.T(w.pos[0],w.pos[1]+0.35,w.pos[2]),M.RfromBasis(R2,[0,1,0],T2))}
function rankText(){const total=1+aiCars.length;if(total===1)return 'Solo';const all=[{name:'YOU',s:car.s}].concat(aiCars.map((a,i)=>({name:'AI'+(i+1),s:a.s})));all.sort((a,b)=>((b.s - a.s + samplesPerLap)%samplesPerLap) - ((a.s - b.s + samplesPerLap)%samplesPerLap));const pos=all.findIndex(o=>o.name==='YOU')+1;return `${pos}/${total}`}
function render(){gl.viewport(0,0,CW,CH);gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT);const VP=cam.VP(CW/CH);gl.uniformMatrix4fv(loc.uVP,false,new Float32Array(VP));gl.uniform1f(loc.uTime,performance.now()/1000);
  if(geoBuf)drawBuf(geoBuf,geoVerts,gl.TRIANGLES);
  if(envBuf){gl.disable(gl.DEPTH_TEST);drawBuf(envBuf,envVerts,gl.POINTS);gl.enable(gl.DEPTH_TEST)}
  if(propBuf)drawBuf(propBuf,propVerts,gl.POINTS);
  if(tunnelBuf)drawBuf(tunnelBuf,tunnelVerts,gl.TRIANGLES);
  if(snowBuf)drawBuf(snowBuf,snowVerts,gl.POINTS);
  drawBuf(bufRail,railVerts,gl.POINTS);
  drawBuf(bufRibbon,verts,gl.TRIANGLE_STRIP);
  if(charBuf)drawBuf(charBuf,charVerts,gl.TRIANGLES);
  drawBuf(orbBuf,orbVerts,gl.POINTS);
  drawBuf(boostBuf,boostVerts,gl.POINTS);
  const dy=clamp(car.offV*0.035,-0.38,0.38);const VPcar=M.mul(VP,carModelMatrix(car,dy));gl.uniformMatrix4fv(loc.uVP,false,new Float32Array(VPcar));drawCarGeom(playerGeom);
  for(let i=0;i<aiCars.length;i++){const a=aiCars[i];const d2=clamp(a.offV*0.03,-0.32,0.32);const VPai=M.mul(VP,carModelMatrix(a,d2));gl.uniformMatrix4fv(loc.uVP,false,new Float32Array(VPai));drawCarGeom(aiGeoms[i])}
  setHUD('uiSpeed',Math.round(car.v*3.6)+'');setHUD('uiDrift',Math.floor(car.drift)+'');if(cfg.best!=null)setHUD('uiBest',cfg.best.toFixed(2)+'s');setHUD('uiPos',rankText())}
const S={MENU:0,PLAY:1,PAUSE:2};let state=S.MENU,last=now(),acc=0;const dt=1/60;function frame(){const t=now();let d=(t-last)/1000;last=t;d=Math.min(d,0.2);acc+=d;if(state===S.PLAY){while(acc>=dt){pollGamepad();car.update(dt);for(const a of aiCars)a.update(dt);cam.update(dt);acc-=dt}render();requestAnimationFrame(frame)}}function pollGamepad(){const gp=(navigator.getGamepads&&navigator.getGamepads()[0])||null;if(!gp)return;const x=Math.abs(gp.axes[0])>0.08?gp.axes[0]:0;input.stickX=x;input.ACC=gp.buttons[0]?.pressed||false;input.BR=gp.buttons[1]?.pressed||false}
const overlay=document.getElementById('overlay');function showMenu(){overlay.innerHTML=`<div class="panel"><h1>벡터 레이싱</h1>
<div class="keys">←/→ 좌우&nbsp;&nbsp;|&nbsp;&nbsp;↑ 가속&nbsp;&nbsp;|&nbsp;&nbsp;↓ 브레이크&nbsp;&nbsp;|&nbsp;&nbsp;Space 드리프트<br/>R 리셋 · P 일시정지</div>
<div style="margin-top:12px;display:flex;gap:8px;justify-content:center;flex-wrap:wrap">
  <button class='btn' id='start'>시작</button>
  <button class='btn' id='reroll'>새 트랙</button>
  <button class='btn' id='clear'>기록 삭제</button>
</div></div>`;overlay.querySelector('#start').onclick=()=>start();overlay.querySelector('#reroll').onclick=()=>{cfg.seed=(Math.random()*1e9)|0;store.set(cfg);rebuild()};overlay.querySelector('#clear').onclick=()=>{cfg.best=null;store.set(cfg);location.reload()}}function clearOverlay(){overlay.innerHTML=''}function start(){clearOverlay();if(state!==S.PLAY){state=S.PLAY;last=now();acc=0;cam.snap();frame()}}function togglePause(){if(state===S.PLAY){state=S.PAUSE;overlay.innerHTML=`<div class='panel'>일시정지<div style='margin-top:10px;display:flex;gap:8px;justify-content:center'><button class='btn' id='res'>계속</button><button class='btn' id='menu'>메뉴</button></div></div>`;overlay.querySelector('#res').onclick=()=>{clearOverlay();state=S.PLAY;last=now();acc=0;frame()};overlay.querySelector('#menu').onclick=()=>{state=S.MENU;showMenu()}}else if(state===S.MENU){start()}}function reset(){state=S.MENU;car.s=0;car.v=0;car.off=0;car.offV=0;car.steer=0;car.drift=0;car.shake=0;car.score=0;missionDone=false;showMenu();render()}
function rebuild(){applyThemeCSS(cfg.theme);playerGeom=makeCarGeom(themeCarColor(cfg.theme),0.95);aiGeoms=[];for(let i=0;i<4;i++){aiGeoms.push(makeCarGeom(aiPalette[i],0.95))}buildTrack(cfg.theme);samplesPerLap=samples;cam.snap();render()}
const THEMES={SPACE:{bg:()=>`radial-gradient(1200px 700px at 70% -10%, #0b1740 0%, transparent 55%), linear-gradient(180deg,#030616,#071531)`,trackC1:[0.58,0.82,1.0],trackC2:[0.62,0.4,1.0],rail:[0.9,0.95,1],env:'stars',trackW:6.2,baseY:1.6,yAmp:6,car:[0.9,0.95,1],fog:[0.02,0.04,0.09]},CYBERPUNK:{bg:()=>`radial-gradient(800px 500px at 80% -10%, #461058 0%, transparent 50%), linear-gradient(180deg,#16061e,#090a18)`,trackC1:[1.0,0.2,0.8],trackC2:[0.2,1.0,0.9],rail:[1,0.7,1],env:'city',trackW:6.8,baseY:0.6,yAmp:2.2,car:[1.0,0.3,0.9],fog:[0.06,0.02,0.10]},XMAS:{bg:()=>`radial-gradient(1000px 600px at 60% -10%, #0e1b3a 0%, transparent 52%), linear-gradient(180deg,#081226,#0a1a33)`,trackC1:[0.0,0.9,0.3],trackC2:[1.0,0.1,0.1],rail:[1,1,1],env:'village',trackW:7.0,baseY:0.6,yAmp:0.9,car:[0.9,0.1,0.1],fog:[0.03,0.05,0.08]},NEON:{bg:()=>`radial-gradient(900px 540px at 85% -10%, #103b6b 0%, transparent 52%), linear-gradient(180deg,#081022,#0a0f28)`,trackC1:[0.2,0.9,1.0],trackC2:[1.0,0.5,0.2],rail:[0.8,1,1],env:'scan',trackW:6.0,baseY:1.0,yAmp:3.2,car:[0.2,0.9,1.0],fog:[0.02,0.05,0.12]},VOLCANO:{bg:()=>`radial-gradient(900px 540px at 85% -10%, #3b0f0f 0%, transparent 52%), linear-gradient(180deg,#140606,#230a0a)`,trackC1:[1.0,0.5,0.0],trackC2:[0.9,0.2,0.1],rail:[1,0.85,0.7],env:'ash',trackW:7.2,baseY:0.4,yAmp:1.8,car:[1.0,0.4,0.05],fog:[0.06,0.02,0.02]}};function applyThemeCSS(key){const t=THEMES[key];if(!t)return;document.body.style.background=t.bg()}
function applyTheme(key){if(!THEMES[key])return;cfg.theme=key;store.set(cfg);rebuild()}
function ensureAIButtons(){document.getElementById('btnAI').textContent=`🤖 AI: ${cfg.aiCount}`}
document.getElementById('selTheme').value=cfg.theme;applyThemeCSS(cfg.theme);playerGeom=makeCarGeom(themeCarColor(cfg.theme),0.95);for(let i=0;i<4;i++)aiGeoms.push(makeCarGeom(aiPalette[i],0.95));buildTrack(cfg.theme);cam.snap();showMenu();render();
document.getElementById('btnPlay').onclick=()=>{if(state!==S.PLAY)start()};document.getElementById('btnPause').onclick=togglePause;document.getElementById('btnReset').onclick=reset;document.getElementById('btnReroll').onclick=()=>{cfg.seed=(Math.random()*1e9)|0;store.set(cfg);rebuild()};document.getElementById('btnShape').onclick=()=>{const idx=(SHAPES.indexOf(cfg.shape)+1)%SHAPES.length;cfg.shape=SHAPES[idx];store.set(cfg);document.getElementById('btnShape').textContent=`🛣 트랙: ${cfg.shape}`;rebuild()};document.getElementById('btnAI').onclick=()=>{cfg.aiCount=(cfg.aiCount+1)%5;store.set(cfg);ensureAICount(cfg.seed^0x777);ensureAIButtons();render()};document.getElementById('selTheme').onchange=(e)=>applyTheme(e.target.value);ensureAIButtons();
})();
</script>
</body>
</html>
